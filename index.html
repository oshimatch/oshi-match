<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¨ã—ãƒãƒƒãƒ</title>
<style>
:root{--pk:#FF3D8B;--nv:#0D0D2B;--nv2:#1A1A3E;--nv3:#252550;--gd:#FFD166;--mn:#06D6A0;--wh:#F0F0FF;--gr:#8888AA;--rd:#FF6B6B;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:-apple-system,'Hiragino Sans',sans-serif;background:var(--nv);color:var(--wh);min-height:100vh;overflow-x:hidden;}

/* PAGES */
.pg{display:none;height:100vh;flex-direction:column;overflow:hidden;}
.pg.on{display:flex;}
.pg-body{flex:1;overflow-y:auto;padding:16px;}
.pg-ftr{padding:0 16px 16px;display:flex;flex-direction:column;gap:9px;flex-shrink:0;}

/* HEADER */
.hdr{background:var(--nv2);padding:13px 17px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--pk);flex-shrink:0;}
.logo{font-size:17px;font-weight:900;color:var(--pk);}
.logo b{color:var(--gd);}
.sm-badge{background:var(--nv3);border:1px solid var(--gd);color:var(--gd);font-size:11px;font-weight:700;padding:3px 9px;border-radius:18px;}

/* BOTTOM NAV */
.bnav{background:var(--nv2);border-top:1px solid var(--nv3);display:flex;padding:8px 0 22px;flex-shrink:0;}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:2px 0;}
.ni-ico{font-size:20px;}
.ni-lbl{font-size:9px;color:var(--gr);font-weight:700;}
.ni.on .ni-lbl{color:var(--pk);}
.ni.on .ni-ico{filter:drop-shadow(0 0 4px var(--pk));}

/* TABS */
.tabs{display:flex;background:var(--nv2);border-bottom:1px solid var(--nv3);flex-shrink:0;}
.tab{flex:1;padding:11px;text-align:center;font-size:13px;font-weight:700;color:var(--gr);cursor:pointer;border-bottom:3px solid transparent;}
.tab.on{color:var(--pk);border-bottom-color:var(--pk);}

/* TYPOGRAPHY */
.ttl{font-size:18px;font-weight:900;margin-bottom:4px;}
.sub{color:var(--gr);font-size:13px;margin-bottom:15px;}

/* BUTTONS */
.btn{border:none;padding:13px;border-radius:48px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;width:100%;}
.btn-p{background:linear-gradient(135deg,var(--pk),#9B5DE5);color:#fff;box-shadow:0 4px 16px rgba(255,61,139,.3);}
.btn-s{background:transparent;color:var(--pk);border:2px solid var(--pk);}
.btn-g{background:linear-gradient(135deg,var(--mn),#0099CC);color:var(--nv);}
.btn-r{background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);}
.btn-sm{padding:7px 13px;border-radius:18px;font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;border:none;}

/* HERO */
.hero{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 20px;text-align:center;gap:18px;background:radial-gradient(ellipse at 30% 20%,#2D0B55,var(--nv) 65%);}
.hero-ico{width:80px;height:80px;background:linear-gradient(135deg,var(--pk),#9B5DE5);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:38px;box-shadow:0 0 32px rgba(255,61,139,.4);animation:fl 3s ease-in-out infinite;}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
.hero h1{font-size:24px;font-weight:900;line-height:1.3;}
.hero h1 span{color:var(--pk);}
.hero p{color:var(--gr);font-size:13px;line-height:1.7;max-width:260px;}
.total-box{background:var(--nv2);border:1px solid var(--mn);border-radius:14px;padding:13px 26px;text-align:center;}
.total-n{font-size:32px;font-weight:900;color:var(--mn);}
.total-l{font-size:12px;color:var(--gr);margin-top:2px;}

/* SEARCH */
.search-inp{background:var(--nv2);border:1px solid var(--nv3);border-radius:11px;padding:10px 14px;color:var(--wh);font-family:inherit;font-size:14px;width:100%;margin-bottom:12px;outline:none;}
.search-inp:focus{border-color:var(--pk);}

/* TEAM ITEMS */
.team-item{background:var(--nv2);border:2px solid var(--nv3);border-radius:13px;padding:12px 13px;display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:8px;}
.team-item.sel{border-color:var(--pk);background:rgba(255,61,139,.07);}
.team-ico{font-size:20px;width:40px;height:40px;background:var(--nv3);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.team-name{font-weight:700;font-size:14px;}
.team-sub{font-size:11px;color:var(--gr);margin-top:1px;}

/* GOODS */
.g-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.g-card{background:var(--nv2);border:2px solid var(--nv3);border-radius:14px;padding:13px 9px;text-align:center;cursor:pointer;}
.g-card.sel{border-color:var(--pk);background:rgba(255,61,139,.08);}
.g-card.new-c{border-style:dashed;}
.g-card img{width:100%;height:64px;object-fit:cover;border-radius:7px;margin-bottom:6px;}
.g-card .emo{font-size:26px;display:block;margin-bottom:6px;}
.g-card .lbl{font-size:11px;font-weight:700;line-height:1.3;}
.g-card .usage{font-size:10px;color:var(--gr);margin-top:2px;}

/* UPLOAD */
.up-area{background:var(--nv2);border:2px dashed var(--gr);border-radius:14px;padding:24px;text-align:center;cursor:pointer;margin-bottom:12px;}
.up-area .ico{font-size:32px;margin-bottom:6px;}
.up-area p{color:var(--gr);font-size:13px;}
#up-prev{width:100%;max-height:180px;object-fit:cover;border-radius:11px;margin-bottom:12px;display:none;}

/* INPUTS */
.lbl{font-size:12px;font-weight:700;color:var(--gr);margin-bottom:5px;display:block;}
.inp{background:var(--nv2);border:1px solid var(--nv3);border-radius:11px;padding:11px 14px;color:var(--wh);font-family:inherit;font-size:14px;width:100%;margin-bottom:12px;outline:none;}
.inp:focus{border-color:var(--pk);}

/* STEPS */
.steps{display:flex;align-items:center;gap:5px;margin-bottom:16px;}
.st{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;background:var(--nv3);color:var(--gr);flex-shrink:0;}
.st.on{background:var(--pk);color:#fff;}
.st.dn{background:var(--mn);color:var(--nv);}
.sl{flex:1;height:2px;background:var(--nv3);}
.sl.dn{background:var(--mn);}

/* NUMBER GRID */
.legend{display:flex;gap:12px;margin-bottom:10px;}
.leg{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--gr);}
.dot{width:9px;height:9px;border-radius:50%;}
.n-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:16px;}
.n-chip{background:var(--nv2);border:2px solid var(--nv3);border-radius:10px;padding:8px 3px;text-align:center;cursor:pointer;}
.n-chip .nn{font-size:14px;font-weight:900;}
.n-chip .np{font-size:9px;color:var(--gr);margin-top:1px;line-height:1.2;word-break:break-all;}
.n-chip.have{border-color:var(--mn);background:rgba(6,214,160,.1);}
.n-chip.have .nn{color:var(--mn);}
.n-chip.want{border-color:var(--pk);background:rgba(255,61,139,.1);}
.n-chip.want .nn{color:var(--pk);}
.n-chip.trading{border-color:var(--gd);background:rgba(255,209,102,.1);opacity:0.6;cursor:not-allowed;}
.n-chip.trading .nn{color:var(--gd);}

/* SEARCH RESULTS */
.result-item{background:var(--nv2);border:1px solid var(--nv3);border-radius:13px;padding:13px;margin-bottom:9px;}
.result-item.trading-item{border-color:var(--gd);opacity:.7;}
.ri-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.ri-user{display:flex;align-items:center;gap:8px;}
.ava{width:34px;height:34px;background:linear-gradient(135deg,var(--pk),#9B5DE5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.ri-name{font-weight:700;font-size:13px;}
.ri-sub{font-size:11px;color:var(--gr);}
.status-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:14px;}
.sb-open{background:rgba(6,214,160,.2);color:var(--mn);border:1px solid var(--mn);}
.sb-trading{background:rgba(255,209,102,.2);color:var(--gd);border:1px solid var(--gd);}
.tag-row{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:9px;}
.tag{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:700;}
.tag.h{background:rgba(6,214,160,.15);color:var(--mn);border:1px solid var(--mn);}
.tag.w{background:rgba(255,61,139,.15);color:var(--pk);border:1px solid var(--pk);}
.tag.t{background:rgba(255,209,102,.15);color:var(--gd);border:1px solid var(--gd);}

/* MESSAGE LIST */
.msg-thread{background:var(--nv2);border:1px solid var(--nv3);border-radius:13px;padding:13px;margin-bottom:9px;cursor:pointer;display:flex;align-items:center;gap:11px;}
.msg-thread.trading{border-color:var(--gd);}
.thread-info{flex:1;}
.thread-name{font-weight:700;font-size:14px;}
.thread-last{font-size:12px;color:var(--gr);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.unread-dot{width:9px;height:9px;background:var(--pk);border-radius:50%;flex-shrink:0;}

/* CHAT */
.chat-hdr{background:var(--nv2);padding:12px 16px;border-bottom:1px solid var(--nv3);display:flex;align-items:center;gap:10px;flex-shrink:0;}
.back{background:none;border:none;color:var(--pk);font-size:20px;cursor:pointer;padding:0;line-height:1;}
.chat-status{font-size:11px;color:var(--mn);}
.c-msgs{flex:1;padding:14px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:9px;}
.msg{max-width:76%;padding:9px 12px;border-radius:14px;font-size:14px;line-height:1.5;}
.msg.r{background:var(--nv2);border-bottom-left-radius:3px;align-self:flex-start;}
.msg.s{background:linear-gradient(135deg,var(--pk),#9B5DE5);border-bottom-right-radius:3px;align-self:flex-end;}
.msg.sys{background:rgba(255,209,102,.1);border:1px solid var(--gd);color:var(--gd);font-size:11px;align-self:center;max-width:92%;text-align:center;}
.c-inp-area{padding:9px 12px;background:var(--nv2);border-top:1px solid var(--nv3);display:flex;gap:7px;align-items:center;flex-shrink:0;}
.c-inp{flex:1;background:var(--nv3);border:1px solid transparent;border-radius:22px;padding:9px 13px;color:var(--wh);font-family:inherit;font-size:14px;outline:none;}
.c-inp:focus{border-color:var(--pk);}
.send-btn{width:38px;height:38px;background:var(--pk);border:none;border-radius:50%;color:#fff;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.done-btn{background:var(--mn);color:var(--nv);border:none;padding:7px 10px;border-radius:20px;font-weight:700;font-size:11px;font-family:inherit;cursor:pointer;flex-shrink:0;}
.cancel-btn{background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);padding:7px 10px;border-radius:20px;font-weight:700;font-size:11px;font-family:inherit;cursor:pointer;flex-shrink:0;}

/* STADIUM MAP */
.stadium-area{background:var(--nv3);border-radius:12px;overflow:hidden;margin:11px 0;}
.stadium-img{width:100%;height:160px;object-fit:cover;}
.stadium-name{padding:8px 11px;font-size:12px;font-weight:700;color:var(--gd);}
.no-stadium{height:100px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--gr);}

/* PROFILE */
.p-card{background:var(--nv2);border-radius:16px;padding:20px;margin-bottom:12px;text-align:center;border:1px solid var(--nv3);}
.p-ava{width:64px;height:64px;background:linear-gradient(135deg,var(--pk),#9B5DE5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;margin:0 auto 10px;}
.p-id{font-size:11px;color:var(--gr);margin-top:3px;}
.st-row{display:flex;gap:8px;margin-top:13px;}
.st-box{flex:1;background:var(--nv3);border-radius:10px;padding:10px;text-align:center;}
.st-n{font-size:20px;font-weight:900;color:var(--pk);}
.st-l{font-size:10px;color:var(--gr);margin-top:2px;}

/* NOTICE */
.notice-box{background:rgba(255,209,102,.08);border:1px solid var(--gd);border-radius:12px;padding:13px;margin-bottom:14px;}
.notice-title{color:var(--gd);font-weight:700;font-size:13px;margin-bottom:6px;}
.notice-body{color:var(--gr);font-size:12px;line-height:1.7;}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.overlay.on{display:flex;}
.sheet{background:var(--nv2);border-radius:20px 20px 0 0;padding:20px 20px 36px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;}
.handle{width:36px;height:4px;background:var(--nv3);border-radius:2px;margin:0 auto 17px;}
.sheet-ttl{font-size:16px;font-weight:900;margin-bottom:6px;}
.sheet-sub{color:var(--gr);font-size:13px;margin-bottom:17px;}

/* ADMIN */
.a-sec{background:var(--nv2);border-radius:14px;padding:13px;margin-bottom:10px;border:1px solid var(--nv3);}
.a-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.a-btns{display:flex;gap:5px;}
.btn-ed{background:var(--nv3);color:var(--wh);font-size:11px;padding:5px 9px;border-radius:7px;cursor:pointer;border:none;font-family:inherit;}
.btn-dl{background:rgba(255,61,139,.12);color:var(--pk);font-size:11px;padding:5px 9px;border-radius:7px;cursor:pointer;border:1px solid var(--pk);font-family:inherit;}
.p-tag{display:inline-block;background:var(--nv3);border-radius:7px;padding:2px 6px;font-size:10px;margin:2px;}
.word-tag{display:inline-flex;align-items:center;gap:4px;background:rgba(255,107,107,.15);border:1px solid var(--rd);color:var(--rd);border-radius:8px;padding:3px 9px;font-size:12px;margin:3px;cursor:pointer;}

.empty{text-align:center;padding:40px 18px;color:var(--gr);}
.empty .ei{font-size:42px;margin-bottom:12px;}
.divider{height:1px;background:var(--nv3);margin:13px 0;}
</style>
</head>
<body>

<!-- ========== HOME ========== -->
<div id="pg-home" class="pg on">
  <div class="hdr">
    <div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div>
    <div class="sm-badge" id="hdr-badge">ğŸ‰ 0ä»¶æˆç«‹</div>
  </div>
  <div class="hero">
    <div class="hero-ico">ğŸ´</div>
    <h1>æ¨ã—ã‚°ãƒƒã‚ºã‚’<br><span>ç¾å ´ã§ãƒãƒƒãƒãƒ³ã‚°</span></h1>
    <p>å€‹äººæƒ…å ±ä¸è¦ã€‚ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´ã§åŒã˜æ¨ã—ã®ã‚°ãƒƒã‚ºã‚’æŒã¤äººã¨å®‰å…¨ã«äº¤æ›ã§ãã¾ã™ã€‚</p>
    <div class="total-box">
      <div class="total-n" id="total-n">0</div>
      <div class="total-l">ä»¶ã®äº¤æ›ãŒæˆç«‹ã—ã¾ã—ãŸ ğŸŠ</div>
    </div>
  </div>
  <div id="home-notice" style="padding:0 16px 8px;display:none;">
    <div class="notice-box">
      <div class="notice-title">âš ï¸ ã”åˆ©ç”¨ã®æ³¨æ„</div>
      <div class="notice-body" id="notice-text"></div>
    </div>
  </div>
  <div class="bnav">
    <div class="ni on" onclick="go('pg-home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="go('pg-register')"><div class="ni-ico">â•</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="go('pg-search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="go('pg-messages')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== REGISTER: TEAM SELECT ========== -->
<div id="pg-register" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="tabs" id="reg-league-tabs">
    <div class="tab on" onclick="switchLeague('J1',this,'reg')">J1</div>
    <div class="tab" onclick="switchLeague('J2',this,'reg')">J2</div>
    <div class="tab" onclick="switchLeague('J3',this,'reg')">J3</div>
  </div>
  <div class="pg-body">
    <div class="ttl">ãƒãƒ¼ãƒ ã‚’é¸ã¶</div>
    <div class="sub">ç™»éŒ²ã™ã‚‹ã‚°ãƒƒã‚ºã®ãƒãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <input class="search-inp" id="reg-team-q" placeholder="ğŸ” ãƒãƒ¼ãƒ åã§æ¤œç´¢..." oninput="renderTeamList('reg')">
    <div id="reg-team-list"></div>
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" onclick="toRegGoods()">æ¬¡ã¸ â†’ ã‚°ãƒƒã‚ºã‚’é¸ã¶</button>
  </div>
  <div class="bnav">
    <div class="ni" onclick="go('pg-home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni on"><div class="ni-ico">â•</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="go('pg-search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="go('pg-messages')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== REGISTER: GOODS SELECT ========== -->
<div id="pg-reg-goods" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="steps"><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st on">1</div><div class="sl"></div><div class="st">2</div><div class="sl"></div><div class="st">3</div></div>
    <div class="ttl">ã‚°ãƒƒã‚ºã‚’é¸ã¶</div>
    <div class="sub" id="reg-goods-sub">ã©ã®ã‚°ãƒƒã‚ºã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="g-grid" id="reg-g-grid"></div>
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" onclick="toRegNumbers()">æ¬¡ã¸ â†’ èƒŒç•ªå·ã‚’é¸ã¶</button>
    <button class="btn btn-s" onclick="go('pg-register')">â† ãƒãƒ¼ãƒ ã‚’é¸ã³ç›´ã™</button>
  </div>
</div>

<!-- ========== REGISTER: NEW GOODS ========== -->
<div id="pg-new-goods" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="steps"><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st on">æ–°</div><div class="sl"></div><div class="st">3</div></div>
    <div class="ttl">æ–°ã—ã„ã‚°ãƒƒã‚ºã‚’ç™»éŒ²</div>
    <div class="sub">åˆã‚ã¦ç™»éŒ²ã•ã‚Œã‚‹ã‚°ãƒƒã‚ºã§ã™ã€‚å†™çœŸã¨ã‚°ãƒƒã‚ºåã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚</div>
    <span class="lbl">ã‚°ãƒƒã‚ºã®å†™çœŸï¼ˆå¿…é ˆï¼‰</span>
    <div class="up-area" id="up-area" onclick="document.getElementById('file-inp').click()">
      <div class="ico">ğŸ“·</div>
      <p>ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶<br><small style="color:var(--gr)">JPGãƒ»PNGå¯¾å¿œ</small></p>
    </div>
    <img id="up-prev" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
    <input type="file" id="file-inp" accept="image/*" style="display:none" onchange="onFileChange(this)">
    <span class="lbl">ã‚°ãƒƒã‚ºã®ç¨®é¡</span>
    <select class="inp" id="ng-cat"><option>ç¼¶ãƒãƒƒã‚¸</option><option>ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰</option><option>ã‚¬ãƒãƒ£</option><option>ãã®ä»–</option></select>
    <span class="lbl">ã‚°ãƒƒã‚ºå</span>
    <input class="inp" id="ng-name" placeholder="ä¾‹ï¼š2024ã‚·ãƒ¼ã‚ºãƒ³ç¼¶ãƒãƒƒã‚¸">
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" id="ng-btn" onclick="saveNewGoods()">ç™»éŒ²ã—ã¦èƒŒç•ªå·ã‚’é¸ã¶ â†’</button>
    <button class="btn btn-s" onclick="go('pg-reg-goods')">â† æˆ»ã‚‹</button>
  </div>
</div>

<!-- ========== REGISTER: NUMBERS ========== -->
<div id="pg-reg-nums" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="steps"><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st dn">âœ“</div><div class="sl dn"></div><div class="st on">3</div></div>
    <div class="ttl">èƒŒç•ªå·ã‚’é¸ã¶</div>
    <div class="sub" id="reg-num-sub">æŒã£ã¦ã„ã‚‹ãƒ»æ¬²ã—ã„èƒŒç•ªå·ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="notice-box" style="margin-bottom:13px;">
      <div class="notice-body">âš ï¸ ã€Œæ¬²ã—ã„ã€ã ã‘ã®ç™»éŒ²ã¯ã§ãã¾ã›ã‚“ã€‚å¿…ãšã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚</div>
    </div>
    <div class="legend">
      <div class="leg"><div class="dot" style="background:var(--mn)"></div>æŒã£ã¦ã„ã‚‹</div>
      <div class="leg"><div class="dot" style="background:var(--pk)"></div>æ¬²ã—ã„</div>
    </div>
    <div class="n-grid" id="reg-n-grid"></div>
    <p style="font-size:11px;color:var(--gr);text-align:center;margin-bottom:16px;">ã‚¿ãƒƒãƒ— â†’ æŒã£ã¦ã„ã‚‹ğŸŸ¢ â†’ æ¬²ã—ã„ğŸ”´ â†’ ãªã—</p>
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" onclick="submitMyListing()">ç™»éŒ²ã™ã‚‹</button>
    <button class="btn btn-s" onclick="go('pg-reg-goods')">â† ã‚°ãƒƒã‚ºã‚’é¸ã³ç›´ã™</button>
  </div>
</div>

<!-- ========== SEARCH ========== -->
<div id="pg-search" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="tabs" id="search-league-tabs">
    <div class="tab on" onclick="switchLeague('J1',this,'search')">J1</div>
    <div class="tab" onclick="switchLeague('J2',this,'search')">J2</div>
    <div class="tab" onclick="switchLeague('J3',this,'search')">J3</div>
  </div>
  <div class="pg-body">
    <div class="ttl">æ¢ã™</div>
    <div class="sub">ãƒãƒ¼ãƒ ãƒ»é¸æ‰‹ãƒ»ã‚°ãƒƒã‚ºã§æ¤œç´¢</div>
    <!-- Step 1: team -->
    <div id="search-step1">
      <input class="search-inp" id="search-team-q" placeholder="ğŸ” ãƒãƒ¼ãƒ åã§æ¤œç´¢..." oninput="renderTeamList('search')">
      <div id="search-team-list"></div>
    </div>
    <!-- Step 2: player -->
    <div id="search-step2" style="display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:13px;">
        <button onclick="searchBack(1)" style="background:none;border:none;color:var(--pk);font-size:18px;cursor:pointer;">â†</button>
        <div id="search-team-label" style="font-weight:700;font-size:15px;"></div>
      </div>
      <div class="sub">é¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</div>
      <div id="search-player-list"></div>
    </div>
    <!-- Step 3: goods -->
    <div id="search-step3" style="display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:13px;">
        <button onclick="searchBack(2)" style="background:none;border:none;color:var(--pk);font-size:18px;cursor:pointer;">â†</button>
        <div id="search-player-label" style="font-weight:700;font-size:15px;"></div>
      </div>
      <div class="sub">ã‚°ãƒƒã‚ºã‚’é¸ã‚“ã§ãã ã•ã„</div>
      <div class="g-grid" id="search-g-grid"></div>
    </div>
    <!-- Step 4: results -->
    <div id="search-step4" style="display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:13px;">
        <button onclick="searchBack(3)" style="background:none;border:none;color:var(--pk);font-size:18px;cursor:pointer;">â†</button>
        <div id="search-result-label" style="font-weight:700;font-size:15px;"></div>
      </div>
      <div id="search-results-list"></div>
    </div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="go('pg-home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="go('pg-register')"><div class="ni-ico">â•</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni on"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="go('pg-messages')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== TRADE REQUEST: NUMBERS ========== -->
<div id="pg-trade-nums" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="ttl">äº¤æ›å¸Œæœ›ã™ã‚‹</div>
    <div class="sub" id="trade-num-sub">ã‚ãªãŸãŒæŒã£ã¦ã„ã‚‹ã‚°ãƒƒã‚ºã®èƒŒç•ªå·ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="notice-box" style="margin-bottom:13px;">
      <div class="notice-body">âš ï¸ ã€Œæ¬²ã—ã„ã€ã ã‘ã®ç™»éŒ²ã¯ã§ãã¾ã›ã‚“ã€‚å¿…ãšã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚</div>
    </div>
    <div class="legend">
      <div class="leg"><div class="dot" style="background:var(--mn)"></div>æŒã£ã¦ã„ã‚‹</div>
      <div class="leg"><div class="dot" style="background:var(--pk)"></div>æ¬²ã—ã„</div>
    </div>
    <div class="n-grid" id="trade-n-grid"></div>
    <p style="font-size:11px;color:var(--gr);text-align:center;margin-bottom:16px;">ã‚¿ãƒƒãƒ— â†’ æŒã£ã¦ã„ã‚‹ğŸŸ¢ â†’ æ¬²ã—ã„ğŸ”´ â†’ ãªã—</p>
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" onclick="submitTradeRequest()">äº¤æ›å¸Œæœ›ã‚’é€ã‚‹</button>
    <button class="btn btn-s" onclick="go('pg-search')">â† æˆ»ã‚‹</button>
  </div>
</div>

<!-- ========== MESSAGES ========== -->
<div id="pg-messages" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="ttl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
    <div class="sub">å–å¼•ä¸­ã®ã‚„ã‚Šã¨ã‚Š</div>
    <div id="msg-thread-list"></div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="go('pg-home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="go('pg-register')"><div class="ni-ico">â•</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="go('pg-search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni on"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== CHAT ========== -->
<div id="pg-chat" class="pg">
  <div class="chat-hdr">
    <button class="back" onclick="go('pg-messages')">â†</button>
    <div class="ava" id="c-ava">ğŸ˜Š</div>
    <div>
      <div style="font-weight:700;font-size:14px;" id="c-name">ç›¸æ‰‹</div>
      <div class="chat-status" id="c-status">å–å¼•ä¸­</div>
    </div>
    <div style="margin-left:auto;font-size:11px;color:var(--gd);" id="c-goods-badge"></div>
  </div>
  <!-- Stadium map -->
  <div class="stadium-area" id="stadium-area" style="margin:0 12px;display:none;">
    <img id="stadium-img" class="stadium-img" alt="ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ">
    <div class="stadium-name" id="stadium-name"></div>
  </div>
  <div class="c-msgs" id="c-msgs">
    <div class="msg sys">ğŸ”’ åŒ¿åãƒãƒ£ãƒƒãƒˆã§ã™ã€‚å€‹äººæƒ…å ±ã¯å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚</div>
  </div>
  <div class="c-inp-area">
    <input class="c-inp" id="c-inp" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
    <button class="cancel-btn" id="cancel-trade-btn" onclick="showCancelModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="done-btn" id="done-trade-btn" onclick="showDoneModal()">å®Œäº†</button>
    <button class="send-btn" onclick="sendMsg()">â¤</button>
  </div>
</div>

<!-- ========== PROFILE (admin access) ========== -->
<div id="pg-profile" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div></div>
  <div class="pg-body">
    <div class="ttl">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
    <div class="p-card">
      <div class="p-ava" id="p-ava">ğŸ˜Š</div>
      <div style="font-size:15px;font-weight:900;" id="p-name">æ¨ã—ãƒ•ã‚¡ãƒ³</div>
      <div class="p-id" id="p-uid">ID: ---</div>
      <div class="st-row">
        <div class="st-box"><div class="st-n" id="my-trades">0</div><div class="st-l">äº¤æ›æˆç«‹</div></div>
        <div class="st-box"><div class="st-n" style="color:var(--gd)" id="my-badge">ğŸŒ±</div><div class="st-l">ãƒãƒƒã‚¸</div></div>
      </div>
    </div>
    <button class="btn btn-s" style="font-size:12px;padding:10px;margin-bottom:9px;" onclick="go('pg-admin-login')">âš™ï¸ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</button>
    <button class="btn btn-s" style="font-size:12px;padding:10px;" onclick="go('pg-home')">â† ãƒ›ãƒ¼ãƒ ã¸</button>
  </div>
</div>

<!-- ========== ADMIN LOGIN ========== -->
<div id="pg-admin-login" class="pg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b> <span style="font-size:11px;color:var(--gr)">ç®¡ç†è€…</span></div></div>
  <div class="pg-body" style="display:flex;align-items:center;justify-content:center;">
    <div style="width:100%;max-width:290px;text-align:center;">
      <div style="font-size:36px;margin-bottom:13px;">ğŸ”</div>
      <div class="ttl" style="text-align:center;margin-bottom:5px;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="sub" style="text-align:center;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <input class="inp" type="password" id="admin-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      <button class="btn btn-p" onclick="checkPw()" style="margin-bottom:9px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn btn-s" onclick="go('pg-home')">â† æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- ========== ADMIN PANEL ========== -->
<div id="pg-admin" class="pg">
  <div class="hdr">
    <div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b> <span style="font-size:11px;color:var(--gr)">ç®¡ç†</span></div>
    <button onclick="go('pg-home')" style="background:none;border:none;color:var(--gr);font-size:12px;cursor:pointer;">â† æˆ»ã‚‹</button>
  </div>
  <div class="tabs" id="admin-main-tabs">
    <div class="tab on" onclick="switchAdminTab('teams',this)">ãƒãƒ¼ãƒ </div>
    <div class="tab" onclick="switchAdminTab('notice',this)">æ³¨æ„äº‹é …</div>
    <div class="tab" onclick="switchAdminTab('words',this)">ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰</div>
    <div class="tab" onclick="switchAdminTab('goods-a',this)">ã‚°ãƒƒã‚º</div>
  </div>
  <div class="pg-body">
    <!-- TEAMS -->
    <div id="admin-teams-tab">
      <div class="tabs" id="admin-league-tabs" style="border-radius:10px;overflow:hidden;margin-bottom:12px;">
        <div class="tab on" onclick="switchAdminLeague('J1',this)" style="font-size:12px;padding:8px;">J1</div>
        <div class="tab" onclick="switchAdminLeague('J2',this)" style="font-size:12px;padding:8px;">J2</div>
        <div class="tab" onclick="switchAdminLeague('J3',this)" style="font-size:12px;padding:8px;">J3</div>
      </div>
      <button onclick="openAddTeam()" style="background:var(--mn);color:var(--nv);border:none;padding:9px;border-radius:10px;font-weight:700;font-size:13px;width:100%;cursor:pointer;font-family:inherit;margin-bottom:12px;">ï¼‹ ãƒãƒ¼ãƒ ã‚’è¿½åŠ </button>
      <div id="admin-team-list"></div>
    </div>
    <!-- NOTICE -->
    <div id="admin-notice-tab" style="display:none;">
      <div class="ttl" style="margin-bottom:13px;">æ³¨æ„äº‹é …ã®ç·¨é›†</div>
      <span class="lbl">åˆ©ç”¨è€…ã«è¡¨ç¤ºã™ã‚‹æ³¨æ„äº‹é …ï¼ˆç©ºç™½ã§éè¡¨ç¤ºï¼‰</span>
      <textarea class="inp" id="notice-edit" rows="8" style="resize:vertical;" placeholder="ä¾‹ï¼šäº¤æ›ã¯å¿…ãšã‚¹ã‚¿ã‚¸ã‚¢ãƒ å†…ã®å…¬å…±ã‚¹ãƒšãƒ¼ã‚¹ã§è¡Œã£ã¦ãã ã•ã„ã€‚"></textarea>
      <button class="btn btn-p" onclick="saveNotice()">ä¿å­˜ã™ã‚‹</button>
    </div>
    <!-- BANNED WORDS -->
    <div id="admin-words-tab" style="display:none;">
      <div class="ttl" style="margin-bottom:6px;">ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰è¨­å®š</div>
      <div class="sub">ãƒãƒ£ãƒƒãƒˆã§ã“ã®ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã¨é€ä¿¡ã§ãã¾ã›ã‚“</div>
      <div id="word-tags" style="margin-bottom:13px;"></div>
      <div style="display:flex;gap:8px;">
        <input class="inp" id="new-word-inp" placeholder="ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ " style="margin-bottom:0;flex:1;">
        <button onclick="addWord()" style="background:var(--pk);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;">è¿½åŠ </button>
      </div>
    </div>
    <!-- GOODS ADMIN -->
    <div id="admin-goods-a-tab" style="display:none;">
      <div class="ttl" style="margin-bottom:13px;">ç™»éŒ²æ¸ˆã¿ã‚°ãƒƒã‚º</div>
      <div id="admin-goods-list"></div>
      <p style="color:var(--gr);font-size:12px;text-align:center;margin-top:8px;">ã‚°ãƒƒã‚ºã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¾å ´ã§åˆå›ç™»éŒ²ã—ã¾ã™</p>
    </div>
  </div>
</div>

<!-- ========== MODAL: COMPLETE ========== -->
<div class="overlay" id="ov-done">
  <div class="sheet">
    <div class="handle"></div>
    <div style="font-size:44px;text-align:center;margin-bottom:10px;">ğŸ‰</div>
    <div class="sheet-ttl">äº¤æ›å®Œäº†ï¼</div>
    <div class="sheet-sub">å–å¼•ã‚’å®Œäº†ã—ã¾ã—ãŸã‹ï¼ŸåŒæ–¹ãŒå®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æˆç«‹ã«ãªã‚Šã¾ã™ã€‚</div>
    <button class="btn btn-p" onclick="confirmDone()" style="margin-bottom:9px;">å®Œäº†ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-done')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ========== MODAL: CANCEL ========== -->
<div class="overlay" id="ov-cancel">
  <div class="sheet">
    <div class="handle"></div>
    <div style="font-size:44px;text-align:center;margin-bottom:10px;">âŒ</div>
    <div class="sheet-ttl">äº¤æ›ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
    <div class="sheet-sub">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ç™»éŒ²ã‚°ãƒƒã‚ºãŒäº¤æ›å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚</div>
    <button class="btn btn-r" onclick="confirmCancel()" style="margin-bottom:9px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-cancel')">æˆ»ã‚‹</button>
  </div>
</div>

<!-- ========== MODAL: ADD/EDIT TEAM ========== -->
<div class="overlay" id="ov-team">
  <div class="sheet">
    <div class="handle"></div>
    <div class="sheet-ttl" id="ov-team-title">ãƒãƒ¼ãƒ ã‚’è¿½åŠ </div>
    <div class="sheet-sub">ãƒãƒ¼ãƒ æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <span class="lbl">ãƒãƒ¼ãƒ å</span>
    <input class="inp" id="t-name" placeholder="ä¾‹ï¼šæ ƒæœ¨SC">
    <span class="lbl">çµµæ–‡å­—</span>
    <input class="inp" id="t-emoji" placeholder="ä¾‹ï¼šğŸŸ¡">
    <span class="lbl">ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å</span>
    <input class="inp" id="t-stadium" placeholder="ä¾‹ï¼šã‚«ãƒ³ã‚»ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã¨ã¡ã">
    <span class="lbl">ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç”»åƒURLï¼ˆä»»æ„ï¼‰</span>
    <input class="inp" id="t-stadium-img" placeholder="https://...">
    <span class="lbl">é¸æ‰‹ä¸€è¦§ï¼ˆã€ŒèƒŒç•ªå· åå‰ã€ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</span>
    <textarea class="inp" id="t-players" rows="9" style="resize:vertical;" placeholder="1 å·ç”°ä¿®å¹³&#10;4 ä½è—¤ç¥¥&#10;5 æŸ³è‚²å´‡"></textarea>
    <input type="hidden" id="t-id">
    <button class="btn btn-p" onclick="saveTeam()" style="margin-bottom:9px;">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-team')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Firebase Compat SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// ============================================================
// FIREBASE INIT
// ============================================================
firebase.initializeApp({
  apiKey: "AIzaSyBiLft_UAh3FxTQ2BlMDxc9ztues6LiBoo",
  authDomain: "oshi-match-2c8e6.firebaseapp.com",
  projectId: "oshi-match-2c8e6",
  storageBucket: "oshi-match-2c8e6.firebasestorage.app",
  messagingSenderId: "518098690390",
  appId: "1:518098690390:web:f33481ca687d80fa2d76f7"
});
var db = firebase.firestore();

// ============================================================
// LOCAL CACHE HELPERS (FirebaseãŒä½¿ãˆãªã„é–“ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
// ============================================================
function sg(k,d){try{var v=localStorage.getItem(k);return v!==null?JSON.parse(v):d;}catch(e){return d;}}
function ss(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function nid(){return db.collection('_').doc().id;}

// ============================================================
// FIREBASE DB HELPERS
// ============================================================

// listings
async function dbGetListings(){
  try{
    var snap=await db.collection('listings').where('status','in',['open','trading']).get();
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_listings',arr);
    return arr;
  }catch(e){return sg('oshi_listings',[]);}
}
async function dbSaveListing(data){
  try{
    if(data.id&&data.id.length>5){
      await db.collection('listings').doc(data.id).set(data);
    } else {
      var ref=await db.collection('listings').add(data);
      data.id=ref.id;
    }
    // update cache
    var arr=sg('oshi_listings',[]);
    var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0) arr[idx]=data; else arr.push(data);
    ss('oshi_listings',arr);
    return data;
  }catch(e){
    var arr2=sg('oshi_listings',[]);
    arr2.push(data); ss('oshi_listings',arr2);
    return data;
  }
}
async function dbUpdateListing(id,update){
  try{await db.collection('listings').doc(id).update(update);}catch(e){}
  var arr=sg('oshi_listings',[]);
  var idx=arr.findIndex(function(x){return x.id===id;});
  if(idx>=0){Object.assign(arr[idx],update);ss('oshi_listings',arr);}
}
async function dbDeleteListing(id){
  try{await db.collection('listings').doc(id).delete();}catch(e){}
  var arr=sg('oshi_listings',[]).filter(function(x){return x.id!==id;});
  ss('oshi_listings',arr);
}

// threads
async function dbGetThreads(){
  try{
    var snap=await db.collection('threads').where('users','array-contains',window.myUid).get();
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_threads',arr);
    return arr;
  }catch(e){return sg('oshi_threads',[]);}
}
async function dbSaveThread(data){
  try{
    if(data.id&&data.id.length>5){
      await db.collection('threads').doc(data.id).set(data);
    } else {
      var ref=await db.collection('threads').add(data);
      data.id=ref.id;
    }
    var arr=sg('oshi_threads',[]);
    var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0) arr[idx]=data; else arr.push(data);
    ss('oshi_threads',arr);
    return data;
  }catch(e){
    var arr2=sg('oshi_threads',[]);
    arr2.push(data); ss('oshi_threads',arr2);
    return data;
  }
}
async function dbUpdateThread(id,update){
  try{await db.collection('threads').doc(id).update(update);}catch(e){}
  var arr=sg('oshi_threads',[]);
  var idx=arr.findIndex(function(x){return x.id===id;});
  if(idx>=0){Object.assign(arr[idx],update);ss('oshi_threads',arr);}
}

// goods
async function dbGetGoods(){
  try{
    var snap=await db.collection('goods').get();
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    if(arr.length) ss('oshi_goods',arr);
    return arr.length?arr:sg('oshi_goods',[]);
  }catch(e){return sg('oshi_goods',[]);}
}
async function dbSaveGoods(data){
  try{
    if(data.id&&data.id.length>5){
      await db.collection('goods').doc(data.id).set(data);
    } else {
      var ref=await db.collection('goods').add(data);
      data.id=ref.id;
    }
    var arr=sg('oshi_goods',[]);
    var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0) arr[idx]=data; else arr.push(data);
    ss('oshi_goods',arr);
    return data;
  }catch(e){
    var arr2=sg('oshi_goods',[]);
    arr2.push(data); ss('oshi_goods',arr2);
    return data;
  }
}
async function dbDeleteGoods(id){
  try{await db.collection('goods').doc(id).delete();}catch(e){}
  var arr=sg('oshi_goods',[]).filter(function(x){return x.id!==id;});
  ss('oshi_goods',arr);
}

// settings (notice / banned words)
async function dbGetSettings(){
  try{
    var snap=await db.collection('settings').doc('global').get();
    if(snap.exists){
      var d=snap.data();
      ss('oshi_notice',d.notice||'');
      ss('oshi_banned_words',d.bannedWords||[]);
      return d;
    }
  }catch(e){}
  return {notice:sg('oshi_notice',''),bannedWords:sg('oshi_banned_words',[])};
}
async function dbSaveSettings(notice,bannedWords){
  try{await db.collection('settings').doc('global').set({notice:notice,bannedWords:bannedWords});}catch(e){}
  ss('oshi_notice',notice);
  ss('oshi_banned_words',bannedWords);
}

// stats
async function dbIncrementTrades(){
  try{
    await db.collection('settings').doc('global').update({
      totalTrades: firebase.firestore.FieldValue.increment(1)
    });
  }catch(e){}
  ss('oshi_total',sg('oshi_total',0)+1);
}
async function dbGetTotal(){
  try{
    var snap=await db.collection('settings').doc('global').get();
    if(snap.exists) return snap.data().totalTrades||0;
  }catch(e){}
  return sg('oshi_total',0);
}

// ============================================================
// DEFAULT TEAM DATA (2026ã‚·ãƒ¼ã‚ºãƒ³)
// ============================================================
function defaultTeams(){
  return {
    J1:[
      {id:'j1t01',name:'æ°´æˆ¸ãƒ›ãƒ¼ãƒªãƒ¼ãƒ›ãƒƒã‚¯',emoji:'ğŸ’™',stadium:'Ksã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ°´æˆ¸',stadiumImg:'',players:[{no:1,name:'æ¾äº•è¬™å¼¥'},{no:7,name:'å¾Œè—¤ç”°äº˜'},{no:9,name:'æœ¨æ‘å‹å¤ª'},{no:10,name:'éˆ´æœ¨å–œä¸ˆ'},{no:11,name:'é»’å·æ·³å²'}]},
      {id:'j1t02',name:'é¹¿å³¶ã‚¢ãƒ³ãƒˆãƒ©ãƒ¼ã‚º',emoji:'ğŸ¦Œ',stadium:'ã‚«ã‚·ãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ—©å·å‹åŸº'},{no:4,name:'ä½é‡æµ·èˆŸ'},{no:5,name:'æ¤ç”°ç›´é€š'},{no:7,name:'å¸«å²¡æŸŠç”Ÿ'},{no:9,name:'çŸ¥å¿µæ…¶'},{no:10,name:'è’æœ¨é¼å¤ªéƒ'},{no:13,name:'æ¿ƒé‡å…¬äºº'},{no:40,name:'éˆ´æœ¨å„ªç£¨'}]},
      {id:'j1t03',name:'æµ¦å’Œãƒ¬ãƒƒã‚º',emoji:'â¤ï¸',stadium:'åŸ¼ç‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ 2002',stadiumImg:'',players:[{no:1,name:'è¥¿å·å‘¨ä½œ'},{no:2,name:'é…’äº•å®æ¨¹'},{no:8,name:'ä¼Šè—¤æ•¦æ¨¹'},{no:9,name:'ãƒã‚¢ã‚´ãƒ»ã‚µãƒ³ã‚¿ãƒŠ'},{no:14,name:'å‰ç”°ç›´è¼'},{no:17,name:'æ¾å°¾ä½‘ä»‹'}]},
      {id:'j1t04',name:'æŸãƒ¬ã‚¤ã‚½ãƒ«',emoji:'ğŸŒŸ',stadium:'ä¸‰å”ãƒ•ãƒ­ãƒ³ãƒ†ã‚¢æŸã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä½ã€…æœ¨é›…å¿—'},{no:7,name:'ç´°è°·çœŸå¤§'},{no:9,name:'å°å±‹æ¾çŸ¥å“‰'},{no:10,name:'ãƒãƒ†ã‚¦ã‚¹ãƒ»ã‚µãƒ´ã‚£ã‚ª'},{no:11,name:'æ­¦è—¤é›„æ¨¹'}]},
      {id:'j1t05',name:'ã‚¸ã‚§ãƒ•ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰åƒè‘‰',emoji:'ğŸŸ¡',stadium:'ãƒ•ã‚¯ãƒ€é›»å­ã‚¢ãƒªãƒ¼ãƒŠ',stadiumImg:'',players:[{no:1,name:'éˆ´æœ¨æ¤‹å¤§'},{no:8,name:'ç”°å£æ³°å£«'},{no:9,name:'å°æ£®é£›çµ¢'},{no:10,name:'è¦‹æœ¨å‹å“‰'},{no:11,name:'æ¤¿ç›´èµ·'}]},
      {id:'j1t06',name:'FCæ±äº¬',emoji:'ğŸ”µ',stadium:'å‘³ã®ç´ ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ³¢å¤šé‡è±ª'},{no:8,name:'æ¾æœ¨ç–ç”Ÿ'},{no:9,name:'ä»²å·è¼äºº'},{no:11,name:'è’æœ¨é¼å¤ªéƒ'},{no:15,name:'ä¿µç©ç”°æ™ƒå¤ª'}]},
      {id:'j1t07',name:'æ±äº¬ãƒ´ã‚§ãƒ«ãƒ‡ã‚£',emoji:'ğŸ’š',stadium:'å‘³ã®ç´ ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ãƒãƒ†ã‚¦ã‚¹'},{no:7,name:'å±±è¦‹å¤§ç™»'},{no:9,name:'æœ¨æ‘å‹å¤§'},{no:10,name:'è¦‹æœ¨å‹å“‰'},{no:11,name:'ç¿é•·è–'}]},
      {id:'j1t08',name:'FCç”ºç”°ã‚¼ãƒ«ãƒ“ã‚¢',emoji:'âš«',stadium:'ç”ºç”°GIONã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'è°·æ™ƒç”Ÿ'},{no:7,name:'å¹³æ²³æ‚ '},{no:9,name:'ãƒ‰ãƒ¬ã‚·ã‚§ãƒ“ãƒƒãƒ'},{no:10,name:'ã‚ªã‚»ãƒ•ãƒ³'},{no:11,name:'ãƒŠã‚µãƒ³ãƒ›'}]},
      {id:'j1t09',name:'å·å´ãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬',emoji:'ğŸ’™',stadium:'Uvanceã¨ã©ã‚ãã‚¹ã‚¿ã‚¸ã‚¢ãƒ  by Fujitsu',stadiumImg:'',players:[{no:1,name:'ãƒãƒ§ãƒ³ãƒ»ã‚½ãƒ³ãƒªãƒ§ãƒ³'},{no:5,name:'æ©˜ç”°å¥äºº'},{no:8,name:'è„‡å‚æ³°æ–—'},{no:10,name:'å®¶é•·æ˜­åš'},{no:25,name:'å°æ—æ‚ '}]},
      {id:'j1t10',name:'æ¨ªæµœFãƒ»ãƒãƒªãƒã‚¹',emoji:'âš“',stadium:'æ—¥ç”£ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:4,name:'å–œç”°æ‹“ä¹Ÿ'},{no:7,name:'ãƒ¤ãƒ³ãƒ»ãƒãƒ†ã‚¦ã‚¹'},{no:9,name:'ã‚¢ãƒ³ãƒ‡ãƒ«ã‚½ãƒ³ãƒ»ãƒ­ãƒšã‚¹'},{no:10,name:'æ¸¡è¾ºçš“å¤ª'},{no:11,name:'æ¤ä¸­æœæ—¥'}]},
      {id:'j1t11',name:'æ¸…æ°´ã‚¨ã‚¹ãƒ‘ãƒ«ã‚¹',emoji:'ğŸ§¡',stadium:'IAIã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ—¥æœ¬å¹³',stadiumImg:'',players:[{no:1,name:'æ¨©ç”°ä¿®ä¸€'},{no:7,name:'ã‚«ãƒ«ãƒªãƒ¼ãƒ‹ãƒ§ã‚¹ãƒ»ã‚¸ãƒ¥ãƒ‹ã‚ª'},{no:9,name:'åŒ—å·èˆªä¹Ÿ'},{no:10,name:'ä¹¾è²´å£«'},{no:11,name:'ãƒ«ãƒ¼ã‚«ã‚¹ãƒ»ãƒ–ãƒ©ã‚¬'}]},
      {id:'j1t12',name:'åå¤å±‹ã‚°ãƒ©ãƒ³ãƒ‘ã‚¹',emoji:'ğŸ”´',stadium:'è±Šç”°ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ãƒ©ãƒ³ã‚²ãƒ©ãƒƒã‚¯'},{no:4,name:'ç¨²å£ç¥¥'},{no:7,name:'æ£®å³¶å¸'},{no:9,name:'ãƒ‘ãƒˆãƒªãƒƒã‚¯'},{no:19,name:'æ°¸äº•è¬™ä½‘'}]},
      {id:'j1t13',name:'äº¬éƒ½ã‚µãƒ³ã‚¬F.C.',emoji:'ğŸ’œ',stadium:'ã‚µãƒ³ã‚¬ã‚¹ã‚¿ã‚¸ã‚¢ãƒ  by KYOCERA',stadiumImg:'',players:[{no:1,name:'å¤ªç”°å²³å¿—'},{no:7,name:'è±Šå·é›„å¤ª'},{no:9,name:'ãƒãƒ«ã‚³ãƒ»ãƒˆã‚¥ãƒ¼ãƒªã‚ª'},{no:10,name:'å·ï¨‘é¢¯å¤ª'},{no:11,name:'å®®å‰æ‹“å®Ÿ'}]},
      {id:'j1t14',name:'ã‚¬ãƒ³ãƒå¤§é˜ª',emoji:'ğŸ’›',stadium:'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¹ç”°',stadiumImg:'',players:[{no:1,name:'ä¸€æ£®ç´”'},{no:7,name:'å®‡ä½ç¾è²´å²'},{no:8,name:'ãƒ€ãƒ¯ãƒ³'},{no:9,name:'å‚æœ¬ä¸€å½©'},{no:11,name:'å±±ä¸‹è«’ä¹Ÿ'}]},
      {id:'j1t15',name:'ã‚»ãƒ¬ãƒƒã‚½å¤§é˜ª',emoji:'ğŸŒ¸',stadium:'ãƒ¨ãƒ‰ã‚³ã‚¦æ¡œã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'ãƒ¬ã‚ªãƒ»ã‚»ã‚¢ãƒ©'},{no:7,name:'åŒ—é‡é¢¯å¤ª'},{no:10,name:'é¦™å·çœŸå¸'},{no:11,name:'ã‚«ãƒ”ã‚·ãƒ£ãƒ¼ãƒ'}]},
      {id:'j1t16',name:'ãƒ´ã‚£ãƒƒã‚»ãƒ«ç¥æˆ¸',emoji:'ğŸ”´',stadium:'ãƒã‚¨ãƒ“ã‚¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç¥æˆ¸',stadiumImg:'',players:[{no:1,name:'å‰å·é»›ä¹Ÿ'},{no:7,name:'æ­¦è—¤å˜‰ç´€'},{no:8,name:'å±±å£è›'},{no:10,name:'å¤§è¿«å‹‡ä¹Ÿ'},{no:11,name:'é½Šè—¤æœªæœˆ'}]},
      {id:'j1t17',name:'ãƒ•ã‚¡ã‚¸ã‚¢ãƒ¼ãƒå²¡å±±',emoji:'ğŸ¦…',stadium:'ã‚·ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å €ç”°å¤§æš‰'},{no:7,name:'ç”°ä¸­é›„å¤§'},{no:9,name:'ã‚°ãƒ¬ã‚¤ã‚½ãƒ³'},{no:10,name:'ãƒã‚¢ã‚´ãƒ»ã‚¢ã‚¦ãƒ™ã‚¹'},{no:11,name:'ãƒ«ã‚«ã‚ª'}]},
      {id:'j1t18',name:'ã‚µãƒ³ãƒ•ãƒ¬ãƒƒãƒã‚§åºƒå³¶',emoji:'ğŸŸ£',stadium:'ã‚¨ãƒ‡ã‚£ã‚ªãƒ³ãƒ”ãƒ¼ã‚¹ã‚¦ã‚¤ãƒ³ã‚°åºƒå³¶',stadiumImg:'',players:[{no:1,name:'å¤§è¿«æ•¬ä»‹'},{no:7,name:'æ±ä¿Šå¸Œ'},{no:9,name:'ãƒ”ã‚¨ãƒ­ã‚¹'},{no:10,name:'åŠ è—¤é™¸æ¬¡æ¨¹'},{no:11,name:'æº€ç”°èª '}]},
      {id:'j1t19',name:'Vãƒ»ãƒ•ã‚¡ãƒ¼ãƒ¬ãƒ³é•·å´',emoji:'ğŸ’™',stadium:'ãƒˆãƒ©ãƒ³ã‚¹ã‚³ã‚¹ãƒ¢ã‚¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ é•·å´',stadiumImg:'',players:[{no:1,name:'å¯Œæ¾¤é›…ä¹Ÿ'},{no:7,name:'ãƒãƒ«ã‚³ã‚¹ãƒ»ã‚®ãƒªã‚§ãƒ«ãƒ¡'},{no:9,name:'ã‚¨ã‚¸ã‚¬ãƒ«ãƒ»ã‚¸ãƒ¥ãƒ‹ã‚ª'},{no:10,name:'åŠ è—¤è–'},{no:11,name:'åå€‰å·§'}]},
      {id:'j1t20',name:'ã‚¢ãƒ“ã‚¹ãƒ‘ç¦å²¡',emoji:'ğŸ',stadium:'ãƒ™ã‚¹ãƒˆé›»å™¨ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ‘ä¸Šæ˜Œè¬™'},{no:7,name:'ç´ºé‡å’Œä¹Ÿ'},{no:9,name:'å±±å²¸ç¥ä¹Ÿ'},{no:10,name:'å‰å¶‹æ´‹å¤ª'},{no:11,name:'ã‚¦ã‚§ãƒªãƒ³ãƒˆãƒ³'}]}
    ],
    J2:[
      {id:'j2t01',name:'åŒ—æµ·é“ã‚³ãƒ³ã‚µãƒ‰ãƒ¼ãƒ¬æœ­å¹Œ',emoji:'ğŸ”´',stadium:'æœ­å¹Œãƒ‰ãƒ¼ãƒ ',stadiumImg:'',players:[{no:1,name:'è…é‡å­æ†²'},{no:7,name:'ãƒ«ãƒ¼ã‚«ã‚¹ãƒ»ãƒ•ã‚§ãƒ«ãƒŠãƒ³ãƒ‡ã‚¹'},{no:9,name:'å°æŸå‰›'},{no:10,name:'è’é‡æ‹“é¦¬'},{no:11,name:'é‡‘å­æ‹“éƒ'}]},
      {id:'j2t02',name:'ãƒ´ã‚¡ãƒ³ãƒ©ãƒ¼ãƒ¬å…«æˆ¸',emoji:'âš“',stadium:'ãƒ—ãƒ©ã‚¤ãƒ•ãƒ¼ã‚ºã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ¾åŸé¢¯æ±°'},{no:9,name:'æµ¦ä¸Šä»é¨'},{no:10,name:'å’Œç”°è‚²'},{no:11,name:'ä½ã€…æœ¨å¿«'}]},
      {id:'j2t03',name:'ãƒ¢ãƒ³ãƒ†ãƒ‡ã‚£ã‚ªå±±å½¢',emoji:'ğŸŸ£',stadium:'NDã‚½ãƒ•ãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ å±±å½¢',stadiumImg:'',players:[{no:1,name:'å¾Œè—¤é›…æ˜'},{no:7,name:'å—ç§€ä»'},{no:9,name:'ãƒã‚¢ã‚´ãƒ»ã‚¢ã‚¦ãƒ™ã‚¹'},{no:10,name:'å‚æœ¬æ¶¼é¦¬'}]},
      {id:'j2t04',name:'ãƒ–ãƒ©ã‚¦ãƒ–ãƒªãƒƒãƒ„ç§‹ç”°',emoji:'ğŸ”µ',stadium:'ã‚½ãƒ¦ãƒ¼ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å±±ç”°å…ƒæ°—'},{no:9,name:'ä¸­æ‘å……å­'},{no:10,name:'ç¨²è‘‰ä¿®åœŸ'}]},
      {id:'j2t05',name:'ãƒ™ã‚¬ãƒ«ã‚¿ä»™å°',emoji:'ğŸ’›',stadium:'ãƒ¦ã‚¢ãƒ†ãƒƒã‚¯ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ä»™å°',stadiumImg:'',players:[{no:1,name:'ã‚¹ãƒˆã‚¤ã‚·ãƒƒãƒ'},{no:7,name:'ç›¸è‰¯ç«œä¹‹ä»‹'},{no:9,name:'ä¸­å³¶å…ƒå½¦'},{no:10,name:'å†…ç”°è£•æ–—'}]},
      {id:'j2t06',name:'ã„ã‚ãFC',emoji:'ğŸŸ¡',stadium:'ã„ã‚ãã‚°ãƒªãƒ¼ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰',stadiumImg:'',players:[{no:1,name:'ç«‹å·å°å¤ªéƒ'},{no:9,name:'æœ‰ç”°ç¨œ'},{no:10,name:'åµ¯å³¨ç†ä¹…'}]},
      {id:'j2t07',name:'æ ƒæœ¨ã‚·ãƒ†ã‚£',emoji:'ğŸŸ¢',stadium:'æ ƒæœ¨å¸‚ç·åˆé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'å®ˆç”°é”å¼¥'},{no:9,name:'å²¡ç”°å„ªå¸Œ'},{no:10,name:'ç”°ä¸­å’Œæ¨¹'}]},
      {id:'j2t08',name:'RBå¤§å®®ã‚¢ãƒ«ãƒ‡ã‚£ãƒ¼ã‚¸ãƒ£',emoji:'ğŸŸ ',stadium:'NACK5ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¤§å®®',stadiumImg:'',players:[{no:1,name:'ç¬ åŸæ˜‚å²'},{no:9,name:'çŸ¢å³¶æ…ä¹Ÿ'},{no:10,name:'ä¸­é‡èª ä¹Ÿ'},{no:11,name:'å¯Œå±±è²´å…‰'}]},
      {id:'j2t09',name:'æ¨ªæµœFC',emoji:'ğŸ”µ',stadium:'ãƒ‹ãƒƒãƒ‘ãƒ„ä¸‰ãƒ„æ²¢çƒæŠ€å ´',stadiumImg:'',players:[{no:1,name:'å¸‚å·æš‰è¨˜'},{no:7,name:'ä¸€ç¾å’Œæˆ'},{no:9,name:'å°å·æ…¶æ²»æœ—'},{no:10,name:'å±±ä¸‹è«’ä¹Ÿ'}]},
      {id:'j2t10',name:'æ¹˜å—ãƒ™ãƒ«ãƒãƒ¼ãƒ¬',emoji:'ğŸ’™',stadium:'ãƒ¬ãƒ¢ãƒ³ã‚¬ã‚¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¹³å¡š',stadiumImg:'',players:[{no:1,name:'å¯Œå±…å¤§æ¨¹'},{no:7,name:'å¤§æ©‹ç¥ç´€'},{no:9,name:'å²¡æœ¬æ‹“ä¹Ÿ'},{no:10,name:'æ± ç”°æ˜Œç”Ÿ'}]},
      {id:'j2t11',name:'è—¤æMYFC',emoji:'ğŸŸ¢',stadium:'è—¤æç·åˆé‹å‹•å…¬åœ’ã‚µãƒƒã‚«ãƒ¼å ´',stadiumImg:'',players:[{no:9,name:'çŸ¢æ‘å¥'},{no:10,name:'å¤§çŸ³ç«œå¹³'}]},
      {id:'j2t12',name:'ãƒ´ã‚¡ãƒ³ãƒ•ã‚©ãƒ¼ãƒ¬ç”²åºœ',emoji:'ğŸ’œ',stadium:'JITãƒªã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ³ã‚¯ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ²³ç”°æ™ƒå…µ'},{no:9,name:'ã‚¦ã‚¿ã‚«'},{no:10,name:'ãƒãƒ«ã‚»ãƒ­'}]},
      {id:'j2t13',name:'ã‚¸ãƒ¥ãƒ“ãƒ­ç£ç”°',emoji:'ğŸŸ¤',stadium:'ãƒ¤ãƒãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä¸‰æµ¦é¾è¼'},{no:7,name:'éˆ´æœ¨æµ·éŸ³'},{no:9,name:'å¤å·é™½ä»‹'},{no:10,name:'ä¸ŠåŸåŠ›ä¹Ÿ'},{no:11,name:'ã‚¸ãƒ£ãƒ¼ãƒ¡ã‚¤ãƒ³è‰¯'}]},
      {id:'j2t14',name:'ã‚«ã‚¿ãƒ¼ãƒ¬å¯Œå±±',emoji:'ğŸ”µ',stadium:'å¯Œå±±çœŒç·åˆé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:9,name:'æœ«æœ¨è£•ä¹Ÿ'},{no:10,name:'ç¢“äº•é‰„å¹³'}]},
      {id:'j2t15',name:'ã‚¢ãƒ«ãƒ“ãƒ¬ãƒƒã‚¯ã‚¹æ–°æ½Ÿ',emoji:'ğŸŸ ',stadium:'ãƒ‡ãƒ³ã‚«ãƒ“ãƒƒã‚°ã‚¹ãƒ¯ãƒ³ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å°å³¶äº¨ä»‹'},{no:7,name:'ä¸‰æˆ¸èˆœä»‹'},{no:9,name:'éˆ´æœ¨å­å¸'},{no:10,name:'ç§‹å±±è£•ç´€'}]},
      {id:'j2t16',name:'å¾³å³¶ãƒ´ã‚©ãƒ«ãƒ†ã‚£ã‚¹',emoji:'ğŸ’›',stadium:'é³´é–€ãƒ»å¤§å¡šã‚¹ãƒãƒ¼ãƒ„ãƒ‘ãƒ¼ã‚¯ãƒã‚«ãƒªã‚¹ã‚¨ãƒƒãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'æ‰æ£®è€ƒèµ·'},{no:10,name:'è¥¿è°·å’Œå¸Œ'}]},
      {id:'j2t17',name:'FCä»Šæ²»',emoji:'ğŸŸ ',stadium:'é‡Œå±±ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'æœ‰ç”°å…‰å¸Œ'},{no:10,name:'å°æ¾¤å¸'}]},
      {id:'j2t18',name:'ã‚µã‚¬ãƒ³é³¥æ –',emoji:'ğŸ’™',stadium:'é§…å‰ä¸å‹•ç”£ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ãƒ‘ã‚¯ãƒ»ã‚¤ãƒ«ã‚®ãƒ¥'},{no:7,name:'æ‰‹å¡šåº·å¹³'},{no:9,name:'å£ç”°è£•æš‰'},{no:10,name:'ç¦ç”°æ™ƒæ–—'}]},
      {id:'j2t19',name:'ãƒ†ã‚²ãƒã‚¸ãƒ£ãƒ¼ãƒ­å®®å´',emoji:'ğŸŸ¢',stadium:'ãƒ¦ãƒ‹ãƒªãƒ¼ãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ–°å¯Œ',stadiumImg:'',players:[{no:9,name:'å±±æœ¬å¤§è²´'},{no:10,name:'å²©å´æ‚ äºº'}]},
      {id:'j2t20',name:'å¤§åˆ†ãƒˆãƒªãƒ‹ãƒ¼ã‚¿',emoji:'ğŸŸ¡',stadium:'æ˜­å’Œé›»å·¥ãƒ‰ãƒ¼ãƒ å¤§åˆ†',stadiumImg:'',players:[{no:1,name:'é«˜æœ¨å’Œå¾¹'},{no:7,name:'é‡æ‘ç›´è¼'},{no:9,name:'ã‚µãƒ ã‚¨ãƒ«ãƒ»ã‚°ã‚¹ã‚¿ãƒ•ã‚½ãƒ³'},{no:10,name:'å¼“å ´å°†è¼'}]}
    ],
    J3:[
      {id:'j3t01',name:'ç¦å³¶ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰FC',emoji:'ğŸŸ¢',stadium:'ã¨ã†ã»ã†ãƒ»ã¿ã‚“ãªã®ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä¸‰æµ¦åŸºç‘›'},{no:9,name:'æœ‰ç”°å…‰å¸Œ'},{no:10,name:'æ·±å·å¤§è¼'}]},
      {id:'j3t02',name:'æ ƒæœ¨SC',emoji:'ğŸŸ¡',stadium:'ã‚«ãƒ³ã‚»ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã¨ã¡ã',stadiumImg:'',players:[
        {no:1,name:'å·ç”°ä¿®å¹³'},{no:4,name:'ä½è—¤ç¥¥'},{no:5,name:'æŸ³è‚²å´‡'},{no:6,name:'é˜¿éƒ¨æµ·æ–—'},
        {no:7,name:'å·åé€£ä»‹'},{no:9,name:'è¿‘è—¤æ…¶ä¸€'},{no:10,name:'äº”ååµå¤ªé™½'},{no:11,name:'é’å³¶å¤ªä¸€'},
        {no:13,name:'å¤§æ›½æ ¹åºƒæ±°'},{no:14,name:'éˆ´æœ¨ä¿Šä¹Ÿ'},{no:15,name:'å ¤é™½è¼'},{no:17,name:'æ‰æ£®è€ƒèµ·'},
        {no:19,name:'åº„å¸æœ—'},{no:21,name:'æ«»åº­ç«‹æ¨¹'},{no:24,name:'ç”°ç«¯ç‰è–'},{no:25,name:'å²©ï¨‘åš'},
        {no:26,name:'ç”°ç•‘çŸ¥èµ·'},{no:27,name:'æ°¸äº•å¤§å£«'},{no:29,name:'çŸ¢é‡è²´ç« '},{no:31,name:'é¹¿é‡ä¿®å¹³'},
        {no:37,name:'æœ¨é‚¨å„ªäºº'},{no:39,name:'å±‹å®œå’ŒçœŸ'},{no:40,name:'é£Ÿé‡å£®ç£¨'},{no:47,name:'å‰é‡é™½ç¿”'},
        {no:71,name:'çŒªè¶Šå„ªæƒŸ'},{no:77,name:'è¥¿é‡å¤ªé™½'},{no:80,name:'ã‚ªã‚¿ãƒœãƒ¼ ã‚±ãƒã‚¹'},{no:81,name:'ä¸­é‡å…‹å“‰'},{no:88,name:'å†…ç”°èˆªå¹³'}
      ]},
      {id:'j3t03',name:'ã‚¶ã‚¹ãƒ‘ç¾¤é¦¬',emoji:'ğŸŸ¢',stadium:'æ­£ç”°é†¤æ²¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç¾¤é¦¬',stadiumImg:'',players:[{no:9,name:'å²¡æœ¬ä¸€çœŸ'},{no:10,name:'åŸå’Œéš¼é¢¯'}]},
      {id:'j3t04',name:'æ¾æœ¬å±±é›…FC',emoji:'ğŸŸ¢',stadium:'ã‚µãƒ³ãƒ—ãƒ­ ã‚¢ãƒ«ã‚¦ã‚£ãƒ³',stadiumImg:'',players:[{no:1,name:'å¤§å†…ä¸€ç”Ÿ'},{no:7,name:'å°æ¾è“®'},{no:9,name:'æ¨ªå±±æ­©å¤¢'},{no:10,name:'è—¤ç”°æ¯å¹'}]},
      {id:'j3t05',name:'SCç›¸æ¨¡åŸ',emoji:'âš«',stadium:'ç›¸æ¨¡åŸã‚®ã‚ªãƒ³ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ³¢å¤šé‡è±ª'},{no:9,name:'ãƒ‰ãƒŸãƒ³ã‚²ã‚¹'},{no:10,name:'ç”°ä¸­ãƒ‘ã‚¦ãƒ­æ·³ä¸€'}]},
      {id:'j3t06',name:'ACé•·é‡ãƒ‘ãƒ«ã‚»ã‚¤ãƒ­',emoji:'ğŸ’›',stadium:'é•·é‡Uã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'ä¸‰ç”°å°šå¸Œ'},{no:10,name:'å®®é˜ªæ”¿æ¨¹'}]},
      {id:'j3t07',name:'ãƒ„ã‚¨ãƒ¼ã‚²ãƒ³é‡‘æ²¢',emoji:'ğŸ’›',stadium:'çŸ³å·çœŒè¥¿éƒ¨ç·‘åœ°å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:9,name:'ç‰åŸå³»å¾'},{no:10,name:'æ—èª é“'}]},
      {id:'j3t08',name:'FCå²é˜œ',emoji:'ğŸ”µ',stadium:'å²é˜œãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼é•·è‰¯å·ç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'æ¡ç•‘å’Œç¹'},{no:9,name:'å±±å†…å¯›å²'},{no:10,name:'è—¤å²¡æµ©ä»‹'},{no:11,name:'ç²Ÿé£¯åŸå°šå¹³'}]},
      {id:'j3t09',name:'ãƒ¬ã‚¤ãƒ©ãƒƒã‚¯æ»‹è³€FC',emoji:'ğŸ’™',stadium:'è‰æ´¥å¸‚ç«‹å¸‚æ°‘ä½“è‚²é¤¨å‰ç«¶æŠ€å ´',stadiumImg:'',players:[{no:9,name:'é½Šè—¤å­¦'},{no:10,name:'å‰é•·çœŸå„ª'}]},
      {id:'j3t10',name:'å¥ˆè‰¯ã‚¯ãƒ©ãƒ–',emoji:'ğŸŸ¤',stadium:'ãƒ­ãƒ¼ãƒˆ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¥ˆè‰¯',stadiumImg:'',players:[{no:9,name:'å†…ç”°é”ä¹Ÿ'},{no:10,name:'é«˜æ©‹å¤§æ‚Ÿ'}]},
      {id:'j3t11',name:'FCå¤§é˜ª',emoji:'ğŸ”µ',stadium:'æ±å¤§é˜ªå¸‚èŠ±åœ’ãƒ©ã‚°ãƒ“ãƒ¼å ´',stadiumImg:'',players:[{no:9,name:'è—¤æœ¬æ·³å¾'},{no:10,name:'ç”°ä¸­ãƒ‘ã‚¦ãƒ­æ·³ä¸€'}]},
      {id:'j3t12',name:'ã‚¬ã‚¤ãƒŠãƒ¼ãƒ¬é³¥å–',emoji:'ğŸ’™',stadium:'Axisãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'ã‚¸ãƒ§ã‚¢ãƒ³ãƒ»ã‚¸ãƒ§ã‚¤ã‚¢'},{no:10,name:'ç”°æ‘ç¿”å¤ª'}]},
      {id:'j3t13',name:'ãƒ¬ãƒãƒ•ã‚¡å±±å£FC',emoji:'ğŸ’™',stadium:'ç¶­æ–°ã¿ã‚‰ã„ãµã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'é–¢æ†²å¤ªéƒ'},{no:7,name:'äº”ååµå¤ªé™½'},{no:9,name:'æ²³é‡å­æ±°'},{no:10,name:'é«˜æœ¨å¤§è¼”'}]},
      {id:'j3t14',name:'æ„›åª›FC',emoji:'ğŸŸ ',stadium:'ãƒ‹ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'è¥¿ç”°æµ'},{no:10,name:'æ£®ç”°æ¶¼é¦¬'}]},
      {id:'j3t15',name:'ã‚«ãƒã‚¿ãƒãƒ¼ãƒ¬è®ƒå²',emoji:'ğŸ’›',stadium:'Pikaraã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'å¯Œç”°å¥å¤ª'},{no:10,name:'é«˜æ©‹å¤§æ‚Ÿ'}]},
      {id:'j3t16',name:'é«˜çŸ¥ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰SC',emoji:'ğŸ”´',stadium:'æ˜¥é‡ç·åˆé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:9,name:'æ¾ç”°é™¸'},{no:10,name:'ä¸­å±±é™¸'}]},
      {id:'j3t17',name:'ã‚®ãƒ©ãƒ´ã‚¡ãƒ³ãƒ„åŒ—ä¹å·',emoji:'ğŸ’™',stadium:'ãƒŸã‚¯ãƒ‹ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ åŒ—ä¹å·',stadiumImg:'',players:[{no:9,name:'ãƒ‡ã‚£ã‚µãƒ­ç‡¦ã‚·ãƒ«ãƒ´ã‚¡ãƒ¼ãƒ'},{no:10,name:'å¹³å±±ç›¸å¤ª'}]},
      {id:'j3t18',name:'ãƒ­ã‚¢ãƒƒã‚½ç†Šæœ¬',emoji:'ğŸ”´',stadium:'ãˆãŒãŠå¥åº·ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ç”°ä»£ç‰æˆ‘'},{no:7,name:'æ±Ÿï¨‘å·§æœ—'},{no:9,name:'ç”°è¾ºé™½å¤ª'},{no:10,name:'å³¶æ‘æ‹“å¼¥'}]},
      {id:'j3t19',name:'é¹¿å…å³¶ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰FC',emoji:'âš«',stadium:'ç™½æ³¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:9,name:'æœ‰ç”°ç¨œ'},{no:10,name:'ä¸­åŸç§€äºº'}]},
      {id:'j3t20',name:'FCç‰çƒ',emoji:'ğŸ’™',stadium:'æ²–ç¸„å¸‚é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:9,name:'é˜¿éƒ¨æ‹“é¦¬'},{no:10,name:'æ¸…æ­¦åŠŸæš‰'}]}
    ]
  };
}

// ============================================================
// STATE
// ============================================================
var myUid, myEmoji;
var regLeague='J1', searchLeague='J1';
var selRegTeam=null, selRegGoodsId=null, selRegGoodsName=null, regNumStates={};
var searchTeam=null, searchPlayer=null, searchGoodsId=null, searchGoodsName=null;
var tradeTargetId=null, tradeTargetUserId=null, tradeNumStates={};
var curChatThreadId=null;
var adminLeague='J1';

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', function(){
  myUid = localStorage.getItem('oshi_uid');
  if(!myUid){myUid='u'+Math.random().toString(36).substr(2,8);localStorage.setItem('oshi_uid',myUid);}
  var emos=['ğŸ˜Š','ğŸµ','â­','ğŸŒ¸','ğŸ’«','ğŸ¤','ğŸ†','ğŸŒŸ','ğŸ€','ğŸ’–'];
  myEmoji = emos[parseInt(myUid.slice(-2),36)%emos.length];
  document.getElementById('p-ava').textContent = myEmoji;
  document.getElementById('p-uid').textContent = 'ID: '+myUid;
  document.getElementById('p-name').textContent = 'æ¨ã—ãƒ•ã‚¡ãƒ³ #'+myUid.slice(-4);
  updateStats(sg('trades_'+myUid,0));

  // ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå¤‰æ›´é »åº¦ä½ãƒ»å®¹é‡å¤§ã®ãŸã‚Firestoreä¸è¦ï¼‰
  if(!sg('oshi_teams',null)) ss('oshi_teams',defaultTeams());

  // Firebase ã‹ã‚‰è¨­å®šãƒ»ã‚°ãƒƒã‚ºã‚’å–å¾—
  dbGetSettings().then(function(s){
    showNoticeFromText(s.notice||'');
  });
  dbGetGoods().then(function(goods){
    if(!goods.length){
      // åˆæœŸã‚°ãƒƒã‚ºã‚’Firestoreã«ç™»éŒ²
      var defs=[
        {name:'ç¼¶ãƒãƒƒã‚¸',emoji:'ğŸ«',photo:null,lastUsed:0,teamId:null},
        {name:'ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰',emoji:'ğŸƒ',photo:null,lastUsed:0,teamId:null},
        {name:'ã‚¬ãƒãƒ£',emoji:'ğŸ°',photo:null,lastUsed:0,teamId:null}
      ];
      defs.forEach(function(g){dbSaveGoods(g);});
    }
  });

  loadTotalTrades();
  renderTeamList('reg');
  renderTeamList('search');
  renderMsgThreads();

  document.getElementById('c-inp').addEventListener('keypress',function(e){if(e.key==='Enter')sendMsg();});
});

async function loadTotalTrades(){
  var n=await dbGetTotal();
  document.getElementById('total-n').textContent=n;
  document.getElementById('hdr-badge').textContent='ğŸ‰ '+n+'ä»¶æˆç«‹';
}

function updateStats(n){
  document.getElementById('my-trades').textContent=n;
  document.getElementById('my-badge').textContent=n>=30?'ğŸ‘‘':n>=10?'ğŸ†':n>=3?'â­':'ğŸŒ±';
}

function showNotice(){
  showNoticeFromText(sg('oshi_notice',''));
}
function showNoticeFromText(txt){
  var box=document.getElementById('home-notice');
  var el=document.getElementById('notice-text');
  if(txt&&txt.trim()){el.textContent=txt;box.style.display='block';}
  else box.style.display='none';
}

// ============================================================
// NAVIGATION
// ============================================================
function go(id){
  var pages=document.querySelectorAll('.pg');
  for(var i=0;i<pages.length;i++) pages[i].classList.remove('on');
  document.getElementById(id).classList.add('on');
  window.scrollTo(0,0);
  if(id==='pg-messages') renderMsgThreads();
}

// ============================================================
// TEAM LIST (shared for reg & search)
// ============================================================
function switchLeague(l,el,mode){
  if(mode==='reg') regLeague=l;
  else searchLeague=l;
  var tabsId = mode==='reg'?'reg-league-tabs':'search-league-tabs';
  var tabs=document.querySelectorAll('#'+tabsId+' .tab');
  for(var i=0;i<tabs.length;i++) tabs[i].classList.remove('on');
  el.classList.add('on');
  renderTeamList(mode);
}

function renderTeamList(mode){
  var league = mode==='reg'?regLeague:searchLeague;
  var listId = mode==='reg'?'reg-team-list':'search-team-list';
  var qId = mode==='reg'?'reg-team-q':'search-team-q';
  var selTeam = mode==='reg'?selRegTeam:searchTeam;

  var teams=(sg('oshi_teams',defaultTeams())[league])||[];
  var q=(document.getElementById(qId)||{}).value||'';
  var el=document.getElementById(listId);
  if(!el) return;
  var filtered=teams.filter(function(t){return t.name.indexOf(q)>=0;});
  if(!filtered.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ”</div><p>ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>';return;}
  var html='';
  for(var i=0;i<filtered.length;i++){
    var t=filtered[i];
    var sel=(selTeam&&selTeam.id===t.id)?' sel':'';
    var enc=encodeURIComponent(JSON.stringify(t));
    html+='<div class="team-item'+sel+'" onclick="pickTeam(\''+enc+'\',\''+mode+'\')">';
    html+='<div class="team-ico">'+t.emoji+'</div>';
    html+='<div><div class="team-name">'+t.name+'</div>';
    html+='<div class="team-sub">'+league+' Â· '+(t.players||[]).length+'é¸æ‰‹</div></div></div>';
  }
  el.innerHTML=html;
}

function pickTeam(enc,mode){
  var t=JSON.parse(decodeURIComponent(enc));
  if(mode==='reg'){
    selRegTeam=t;
    renderTeamList('reg');
  } else {
    searchTeam=t;
    renderTeamList('search');
    showSearchStep(2);
  }
}

// ============================================================
// REGISTER FLOW
// ============================================================
function toRegGoods(){
  if(!selRegTeam){alert('ãƒãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  document.getElementById('reg-goods-sub').textContent=selRegTeam.name+'ã®ã‚°ãƒƒã‚ºã‚’é¸ã‚“ã§ãã ã•ã„';
  renderRegGoodsGrid();
  go('pg-reg-goods');
}

function renderRegGoodsGrid(){
  var goods=sg('oshi_goods',[]);
  var filtered=goods.filter(function(g){return !g.teamId||g.teamId===selRegTeam.id;});
  filtered.sort(function(a,b){return (b.lastUsed||0)-(a.lastUsed||0);});
  var html='';
  for(var i=0;i<filtered.length;i++){
    var g=filtered[i];
    var sel=(selRegGoodsId===g.id)?' sel':'';
    html+='<div class="g-card'+sel+'" onclick="pickRegGoods(\''+g.id+'\',\''+g.name.replace(/'/g,'&#39;')+'\')">';
    if(g.photo) html+='<img src="'+g.photo+'" alt="'+g.name+'">';
    else html+='<span class="emo">'+(g.emoji||'ğŸ«')+'</span>';
    html+='<div class="lbl">'+g.name+'</div></div>';
  }
  html+='<div class="g-card new-c" onclick="go(\'pg-new-goods\')">';
  html+='<span class="emo" style="color:var(--gr)">ï¼‹</span>';
  html+='<div class="lbl" style="color:var(--gr)">æ–°ã—ãç™»éŒ²</div></div>';
  document.getElementById('reg-g-grid').innerHTML=html;
}

function pickRegGoods(id,name){
  selRegGoodsId=id; selRegGoodsName=name;
  renderRegGoodsGrid();
}

function onFileChange(inp){
  var file=inp.files[0]; if(!file) return;
  window._pendingFile=file;
  var reader=new FileReader();
  reader.onload=function(e){
    var prev=document.getElementById('up-prev');
    prev.src=e.target.result; prev.style.display='block';
    document.getElementById('up-area').style.display='none';
  };
  reader.readAsDataURL(file);
}

function saveNewGoods(){
  var name=document.getElementById('ng-name').value.trim();
  var cat=document.getElementById('ng-cat').value;
  if(!name){alert('ã‚°ãƒƒã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!window._pendingFile){alert('å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„');return;}

  // Check duplicate name
  var goods=sg('oshi_goods',[]);
  var fullName=cat+'ï½œ'+name;
  var dup=goods.find(function(g){return g.name===fullName;});
  if(dup){alert('åŒã˜ã‚°ãƒƒã‚ºåãŒã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸€è¦§ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚');return;}

  var btn=document.getElementById('ng-btn');
  btn.textContent='ç™»éŒ²ä¸­...'; btn.disabled=true;
  var reader=new FileReader();
  reader.onload=function(e){
    var entry={name:fullName,emoji:'ğŸ«',photo:e.target.result,lastUsed:Date.now(),teamId:selRegTeam?selRegTeam.id:null};
    dbSaveGoods(entry).then(function(saved){
      selRegGoodsId=saved.id; selRegGoodsName=fullName;
      window._pendingFile=null;
      document.getElementById('up-prev').style.display='none';
      document.getElementById('up-area').style.display='block';
      document.getElementById('ng-name').value='';
      btn.textContent='ç™»éŒ²ã—ã¦èƒŒç•ªå·ã‚’é¸ã¶ â†’'; btn.disabled=false;
      toRegNumbers();
    });
  };
  reader.readAsDataURL(window._pendingFile);
}

function toRegNumbers(){
  if(!selRegGoodsId){alert('ã‚°ãƒƒã‚ºã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  document.getElementById('reg-num-sub').textContent=selRegTeam.name+'ï½œ'+selRegGoodsName;
  regNumStates={};
  renderNumGrid('reg-n-grid',selRegTeam.players||[],regNumStates,'regCycle');
  go('pg-reg-nums');
}

function renderNumGrid(gridId,players,states,cycleFn,disabledNos){
  disabledNos=disabledNos||[];
  var html='';
  for(var i=0;i<players.length;i++){
    var p=players[i];
    var st=states[p.no]||'';
    var disabled=disabledNos.indexOf(p.no)>=0;
    var cls=disabled?'n-chip trading':'n-chip '+st;
    var onclick=disabled?'':' onclick="'+cycleFn+'('+p.no+')"';
    html+='<div class="'+cls+'"'+onclick+'>';
    html+='<div class="nn">#'+p.no+'</div>';
    html+='<div class="np">'+p.name+'</div></div>';
  }
  document.getElementById(gridId).innerHTML=html;
}

function regCycle(no){
  var cur=regNumStates[no];
  if(!cur) regNumStates[no]='have';
  else if(cur==='have') regNumStates[no]='want';
  else delete regNumStates[no];
  renderNumGrid('reg-n-grid',selRegTeam.players||[],regNumStates,'regCycle');
}

async function submitMyListing(){
  var haveNos=[], wantNos=[];
  var keys=Object.keys(regNumStates);
  for(var i=0;i<keys.length;i++){
    if(regNumStates[keys[i]]==='have') haveNos.push(parseInt(keys[i]));
    else wantNos.push(parseInt(keys[i]));
  }
  if(!haveNos.length){alert('ã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');return;}

  var listing={
    userId:myUid, userEmoji:myEmoji,
    team:selRegTeam.name, teamEmoji:selRegTeam.emoji, teamId:selRegTeam.id, league:regLeague,
    stadium:selRegTeam.stadium||'', stadiumImg:selRegTeam.stadiumImg||'',
    goodsId:selRegGoodsId, goodsName:selRegGoodsName,
    have:haveNos, want:wantNos, status:'open',
    users:[myUid],
    createdAt:Date.now(), updatedAt:Date.now()
  };
  await dbSaveListing(listing);

  // Update goods lastUsed
  var goods=sg('oshi_goods',[]);
  var gi=goods.findIndex(function(g){return g.id===selRegGoodsId;});
  if(gi>=0){goods[gi].lastUsed=Date.now();dbSaveGoods(goods[gi]);}

  alert('âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼ã€Œæ¢ã™ã€ã‹ã‚‰äº¤æ›ç›¸æ‰‹ã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚');
  go('pg-home');
}

// ============================================================
// SEARCH FLOW
// ============================================================
function showSearchStep(n){
  document.getElementById('search-step1').style.display=n===1?'block':'none';
  document.getElementById('search-step2').style.display=n===2?'block':'none';
  document.getElementById('search-step3').style.display=n===3?'block':'none';
  document.getElementById('search-step4').style.display=n===4?'block':'none';
  if(n===2) renderSearchPlayers();
  if(n===3) renderSearchGoods();
  if(n===4) renderSearchResults();
}

function searchBack(toStep){
  showSearchStep(toStep);
}

function renderSearchPlayers(){
  var el=document.getElementById('search-player-list');
  document.getElementById('search-team-label').textContent=searchTeam.emoji+' '+searchTeam.name;
  var players=searchTeam.players||[];
  var html='';
  for(var i=0;i<players.length;i++){
    var p=players[i];
    var enc=encodeURIComponent(JSON.stringify(p));
    html+='<div class="team-item" onclick="pickSearchPlayer(\''+enc+'\')">';
    html+='<div class="team-ico" style="font-size:16px;font-weight:900;">#'+p.no+'</div>';
    html+='<div><div class="team-name">'+p.name+'</div></div></div>';
  }
  el.innerHTML=html;
}

function pickSearchPlayer(enc){
  searchPlayer=JSON.parse(decodeURIComponent(enc));
  showSearchStep(3);
}

function renderSearchGoods(){
  dbGetGoods().then(function(goods){
    var filtered=goods.filter(function(g){return !g.teamId||g.teamId===searchTeam.id;});
    filtered.sort(function(a,b){return (b.lastUsed||0)-(a.lastUsed||0);});
    document.getElementById('search-player-label').textContent='#'+searchPlayer.no+' '+searchPlayer.name;
    var html='';
    for(var i=0;i<filtered.length;i++){
      var g=filtered[i];
      html+='<div class="g-card" onclick="pickSearchGoods(\''+g.id+'\',\''+g.name.replace(/'/g,'&#39;')+'\')">';
      if(g.photo) html+='<img src="'+g.photo+'" alt="'+g.name+'">';
      else html+='<span class="emo">'+(g.emoji||'ğŸ«')+'</span>';
      html+='<div class="lbl">'+g.name+'</div></div>';
    }
    if(!filtered.length) html='<div class="empty"><div class="ei">ğŸ“¦</div><p>ã‚°ãƒƒã‚ºãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    document.getElementById('search-g-grid').innerHTML=html;
  });
}

function pickSearchGoods(id,name){
  searchGoodsId=id; searchGoodsName=name;
  showSearchStep(4);
}

function renderSearchResults(){
  var lbl=searchTeam.emoji+' '+searchTeam.name+' #'+searchPlayer.no+' '+searchPlayer.name;
  document.getElementById('search-result-label').textContent=lbl;
  var el=document.getElementById('search-results-list');
  el.innerHTML='<div class="empty"><div class="ei">â³</div><p>æ¤œç´¢ä¸­...</p></div>';
  dbGetListings().then(function(listings){
    var filtered=listings.filter(function(l){
      return l.teamId===searchTeam.id && l.goodsId===searchGoodsId && l.userId!==myUid &&
             (l.have||[]).indexOf(searchPlayer.no)>=0||(l.want||[]).indexOf(searchPlayer.no)>=0;
    });
    if(!filtered.length){
      el.innerHTML='<div class="empty"><div class="ei">ğŸ˜¢</div><p>ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äººãŒã„ã¾ã›ã‚“</p></div>';
      return;
    }
    var html='';
    for(var i=0;i<filtered.length;i++){
      var l=filtered[i];
      var isTrading=l.status==='trading';
      var haveTagsHtml='',wantTagsHtml='';
      for(var j=0;j<(l.have||[]).length;j++) haveTagsHtml+='<span class="tag h">#'+l.have[j]+'</span>';
      for(var j=0;j<(l.want||[]).length;j++) wantTagsHtml+='<span class="tag w">#'+l.want[j]+'</span>';
      html+='<div class="result-item'+(isTrading?' trading-item':'')+'">';
      html+='<div class="ri-hdr"><div class="ri-user">';
      html+='<div class="ava">'+(l.userEmoji||'ğŸ˜Š')+'</div>';
      html+='<div><div class="ri-name">'+l.goodsName+'</div>';
      html+='<div class="ri-sub">'+l.team+'</div></div></div>';
      html+='<span class="status-badge '+(isTrading?'sb-trading':'sb-open')+'">'+(isTrading?'å–å¼•ä¸­':'äº¤æ›å¯èƒ½')+'</span></div>';
      html+='<div class="tag-row">'+haveTagsHtml+'</div>';
      html+='<div class="tag-row" style="margin-bottom:9px;">'+wantTagsHtml+'</div>';
      if(!isTrading){
        html+='<button class="btn btn-p" style="font-size:13px;padding:10px;" onclick="startTradeRequest(\''+l.id+'\')">äº¤æ›å¸Œæœ›ã™ã‚‹</button>';
      } else {
        html+='<button class="btn" style="background:var(--nv3);color:var(--gr);font-size:13px;padding:10px;" disabled>å–å¼•ä¸­</button>';
      }
      html+='</div>';
    }
    el.innerHTML=html;
  });
}

async function startTradeRequest(listingId){
  tradeTargetId=listingId;
  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===listingId;});
  if(!target){
    try{var snap=await db.collection('listings').doc(listingId).get();if(snap.exists)target=Object.assign({id:snap.id},snap.data());}catch(e){}
  }
  if(!target){alert('ç™»éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  tradeTargetUserId=target.userId;
  document.getElementById('trade-num-sub').textContent=target.team+'ï½œ'+target.goodsName+' ã®äº¤æ›å¸Œæœ›';
  tradeNumStates={};
  renderNumGrid('trade-n-grid',target.teamId?getTeamPlayers(target.teamId):[],tradeNumStates,'tradeCycle',[]);
  go('pg-trade-nums');
}

function getTeamPlayers(teamId){
  var teams=sg('oshi_teams',defaultTeams());
  for(var league in teams){
    var t=teams[league].find(function(t){return t.id===teamId;});
    if(t) return t.players||[];
  }
  return [];
}

function tradeCycle(no){
  var cur=tradeNumStates[no];
  if(!cur) tradeNumStates[no]='have';
  else if(cur==='have') tradeNumStates[no]='want';
  else delete tradeNumStates[no];
  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===tradeTargetId;});
  renderNumGrid('trade-n-grid',target?getTeamPlayers(target.teamId):[],tradeNumStates,'tradeCycle',[]);
}

async function submitTradeRequest(){
  var haveNos=[], wantNos=[];
  var keys=Object.keys(tradeNumStates);
  for(var i=0;i<keys.length;i++){
    if(tradeNumStates[keys[i]]==='have') haveNos.push(parseInt(keys[i]));
    else wantNos.push(parseInt(keys[i]));
  }
  if(!haveNos.length){alert('ã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');return;}

  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===tradeTargetId;});
  if(!target){alert('ç™»éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}

  await dbUpdateListing(tradeTargetId,{status:'trading',updatedAt:Date.now()});

  var thread={
    userA:myUid, userAEmoji:myEmoji,
    userB:target.userId, userBEmoji:target.userEmoji,
    users:[myUid,target.userId],
    team:target.team, teamEmoji:target.teamEmoji,
    stadium:target.stadium||'', stadiumImg:target.stadiumImg||'',
    goodsName:target.goodsName, listingId:tradeTargetId,
    myNums:haveNos, wantNums:wantNos,
    status:'trading',
    messages:[{from:'sys',text:'å–å¼•ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ä¸å¯§ãªã‚„ã‚Šã¨ã‚Šã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',at:Date.now()}],
    doneA:false, doneB:false,
    createdAt:Date.now()
  };
  await dbSaveThread(thread);

  alert('âœ… äº¤æ›å¸Œæœ›ã‚’é€ã‚Šã¾ã—ãŸï¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç›¸è«‡ã—ã¾ã—ã‚‡ã†ã€‚');
  go('pg-messages');
}

// ============================================================
// MESSAGES
// ============================================================
function renderMsgThreads(){
  var el=document.getElementById('msg-thread-list');
  el.innerHTML='<div class="empty"><div class="ei">â³</div><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>';
  dbGetThreads().then(function(threads){
    threads=threads.filter(function(t){return t.userA===myUid||t.userB===myUid;});
    if(!threads.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ’¬</div><p>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';return;}
    threads.sort(function(a,b){return b.createdAt-a.createdAt;});
    var html='';
    for(var i=0;i<threads.length;i++){
      var t=threads[i];
      var isMyA=t.userA===myUid;
      var peerEmoji=isMyA?t.userBEmoji:t.userAEmoji;
      var lastMsg=t.messages&&t.messages.length?t.messages[t.messages.length-1]:{text:'å–å¼•é–‹å§‹'};
      var isDone=t.status==='done';
      html+='<div class="msg-thread'+(t.status==='trading'?' trading':'')+'" onclick="openChat(\''+t.id+'\')">';
      html+='<div class="ava">'+(peerEmoji||'ğŸ˜Š')+'</div>';
      html+='<div class="thread-info">';
      html+='<div class="thread-name">'+t.teamEmoji+' '+t.goodsName+(isDone?' âœ…':'')+'</div>';
      html+='<div class="thread-last">'+(lastMsg.text.length>30?lastMsg.text.substr(0,30)+'â€¦':lastMsg.text)+'</div></div>';
      if(!isDone&&t.status==='trading') html+='<div class="unread-dot"></div>';
      html+='</div>';
    }
    el.innerHTML=html;
  });
}

function openChat(threadId){
  curChatThreadId=threadId;
  var threads=sg('oshi_threads',[]);
  var t=threads.find(function(t){return t.id===threadId;});
  if(!t) return;

  var isMyA=t.userA===myUid;
  var peerEmoji=isMyA?t.userBEmoji:t.userAEmoji;
  document.getElementById('c-ava').textContent=peerEmoji||'ğŸ˜Š';
  document.getElementById('c-name').textContent=t.teamEmoji+' '+t.goodsName;
  document.getElementById('c-goods-badge').textContent=t.status==='done'?'âœ…æˆç«‹':'å–å¼•ä¸­';
  document.getElementById('c-status').textContent=t.status==='done'?'äº¤æ›æˆç«‹':'â— å–å¼•ä¸­';

  // Stadium
  var sa=document.getElementById('stadium-area');
  if(t.stadiumImg&&t.stadiumImg.trim()){
    document.getElementById('stadium-img').src=t.stadiumImg;
    document.getElementById('stadium-name').textContent='ğŸ“ '+t.stadium;
    sa.style.display='block';
  } else if(t.stadium){
    sa.style.display='block';
    document.getElementById('stadium-img').style.display='none';
    document.getElementById('stadium-name').textContent='ğŸ“ '+t.stadium;
  } else {
    sa.style.display='none';
  }

  var isDone=t.status==='done';
  document.getElementById('done-trade-btn').style.display=isDone?'none':'block';
  document.getElementById('cancel-trade-btn').style.display=isDone?'none':'block';

  renderChatMsgs(t);
  go('pg-chat');
}

function renderChatMsgs(t){
  var el=document.getElementById('c-msgs');
  var msgs=t.messages||[];
  var html='<div class="msg sys">ğŸ”’ åŒ¿åãƒãƒ£ãƒƒãƒˆã§ã™ã€‚å€‹äººæƒ…å ±ã¯å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚</div>';
  for(var i=0;i<msgs.length;i++){
    var m=msgs[i];
    if(m.from==='sys'){
      html+='<div class="msg sys">'+m.text+'</div>';
    } else if(m.from===myUid){
      html+='<div class="msg s">'+m.text+'</div>';
    } else {
      html+='<div class="msg r">'+m.text+'</div>';
    }
  }
  el.innerHTML=html;
  el.scrollTop=el.scrollHeight;
}

async function sendMsg(){
  var inp=document.getElementById('c-inp');
  var text=inp.value.trim();
  if(!text) return;

  var banned=sg('oshi_banned_words',[]);
  for(var i=0;i<banned.length;i++){
    if(text.indexOf(banned[i])>=0){alert('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚');return;}
  }

  inp.value='';
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0) return;
  threads[idx].messages=threads[idx].messages||[];
  threads[idx].messages.push({from:myUid,text:text,at:Date.now()});
  await dbUpdateThread(curChatThreadId,{messages:threads[idx].messages});
  ss('oshi_threads',threads);
  renderChatMsgs(threads[idx]);
}

function showDoneModal(){document.getElementById('ov-done').classList.add('on');}
function showCancelModal(){document.getElementById('ov-cancel').classList.add('on');}
function closeOv(id){document.getElementById(id).classList.remove('on');}

async function confirmDone(){
  closeOv('ov-done');
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0) return;
  var t=threads[idx];
  var isMyA=t.userA===myUid;
  if(isMyA) t.doneA=true; else t.doneB=true;

  if(t.doneA&&t.doneB){
    t.status='done';
    t.messages.push({from:'sys',text:'ğŸ‰ äº¤æ›ãŒæˆç«‹ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚',at:Date.now()});
    await dbUpdateThread(curChatThreadId,{status:'done',doneA:true,doneB:true,messages:t.messages});
    await dbDeleteListing(t.listingId);

    var n=sg('trades_'+myUid,0)+1;
    ss('trades_'+myUid,n);
    updateStats(n);
    await dbIncrementTrades();
    loadTotalTrades();

    ss('oshi_threads',threads);
    renderChatMsgs(t);
    document.getElementById('c-goods-badge').textContent='âœ…æˆç«‹';
    document.getElementById('done-trade-btn').style.display='none';
    document.getElementById('cancel-trade-btn').style.display='none';
    alert('ğŸ‰ äº¤æ›æˆç«‹ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼');
  } else {
    var upd=isMyA?{doneA:true}:{doneB:true};
    await dbUpdateThread(curChatThreadId,upd);
    ss('oshi_threads',threads);
    alert('å®Œäº†ã—ã¾ã—ãŸã€‚ç›¸æ‰‹ãŒå®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æˆç«‹ã«ãªã‚Šã¾ã™ã€‚');
  }
}

async function confirmCancel(){
  closeOv('ov-cancel');
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0) return;
  var t=threads[idx];
  t.status='cancelled';
  t.messages.push({from:'sys',text:'âŒ å–å¼•ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚',at:Date.now()});
  await dbUpdateThread(curChatThreadId,{status:'cancelled',messages:t.messages});
  await dbUpdateListing(t.listingId,{status:'open',updatedAt:Date.now()});

  ss('oshi_threads',threads);
  renderChatMsgs(t);
  document.getElementById('done-trade-btn').style.display='none';
  document.getElementById('cancel-trade-btn').style.display='none';
  alert('å–å¼•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ã‚°ãƒƒã‚ºãŒäº¤æ›å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚');
  go('pg-messages');
}

// ============================================================
// ADMIN
// ============================================================
var ADMIN_PW='oshimatch2024';

function switchAdminTab(tab,el){
  var tabs=document.querySelectorAll('#admin-main-tabs .tab');
  for(var i=0;i<tabs.length;i++) tabs[i].classList.remove('on');
  el.classList.add('on');
  document.getElementById('admin-teams-tab').style.display=tab==='teams'?'block':'none';
  document.getElementById('admin-notice-tab').style.display=tab==='notice'?'block':'none';
  document.getElementById('admin-words-tab').style.display=tab==='words'?'block':'none';
  document.getElementById('admin-goods-a-tab').style.display=tab==='goods-a'?'block':'none';
}

function switchAdminLeague(l,el){
  adminLeague=l;
  var tabs=document.querySelectorAll('#admin-league-tabs .tab');
  for(var i=0;i<tabs.length;i++) tabs[i].classList.remove('on');
  el.classList.add('on');
  renderAdminTeams();
}

function renderAdminTeams(){
  var teams=(sg('oshi_teams',defaultTeams())[adminLeague])||[];
  var el=document.getElementById('admin-team-list');
  if(!teams.length){el.innerHTML='<div style="color:var(--gr);text-align:center;padding:16px;font-size:13px;">ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  var html='';
  for(var i=0;i<teams.length;i++){
    var t=teams[i];
    var enc=encodeURIComponent(JSON.stringify(t));
    html+='<div class="a-sec"><div class="a-row">';
    html+='<span style="font-weight:700;font-size:13px;">'+t.emoji+' '+t.name+'</span>';
    html+='<div class="a-btns"><button class="btn-ed" onclick="openEditTeam(\''+enc+'\')">ç·¨é›†</button>';
    html+='<button class="btn-dl" onclick="delTeam(\''+t.id+'\',\''+t.name.replace(/'/g,'&#39;')+'\')">å‰Šé™¤</button></div></div>';
    if(t.stadium) html+='<div style="font-size:11px;color:var(--gr);margin-bottom:6px;">ğŸ“ '+t.stadium+'</div>';
    var ptags='';
    for(var j=0;j<(t.players||[]).length;j++) ptags+='<span class="p-tag">#'+t.players[j].no+' '+t.players[j].name+'</span>';
    html+='<div>'+ptags+'</div></div>';
  }
  el.innerHTML=html;
}

function checkPw(){
  if(document.getElementById('admin-pw').value===ADMIN_PW){
    document.getElementById('admin-pw').value='';
    renderAdminTeams();
    dbGetGoods().then(function(){renderAdminGoods();});
    dbGetSettings().then(function(s){
      renderWordTags();
      document.getElementById('notice-edit').value=s.notice||'';
    });
    go('pg-admin');
  } else {
    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  }
}

function renderAdminGoods(){
  var goods=sg('oshi_goods',[]);
  var html='';
  for(var i=0;i<goods.length;i++){
    var g=goods[i];
    html+='<div class="a-sec"><div class="a-row">';
    if(g.photo) html+='<img src="'+g.photo+'" style="width:26px;height:26px;object-fit:cover;border-radius:5px;margin-right:7px;vertical-align:middle;">';
    else html+='<span style="margin-right:6px;">'+(g.emoji||'ğŸ«')+'</span>';
    html+='<span style="font-weight:700;font-size:13px;">'+g.name+'</span>';
    html+='<button class="btn-dl" onclick="delGoods(\''+g.id+'\')" style="margin-left:auto;">å‰Šé™¤</button>';
    html+='</div></div>';
  }
  if(!goods.length) html='<div style="color:var(--gr);text-align:center;padding:16px;font-size:13px;">ã‚°ãƒƒã‚ºãŒã‚ã‚Šã¾ã›ã‚“</div>';
  document.getElementById('admin-goods-list').innerHTML=html;
}

async function delGoods(id){
  if(!confirm('ã“ã®ã‚°ãƒƒã‚ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await dbDeleteGoods(id);
  renderAdminGoods();
}

function renderWordTags(){
  var words=sg('oshi_banned_words',[]);
  var html='';
  for(var i=0;i<words.length;i++){
    html+='<span class="word-tag" onclick="delWord(\''+words[i].replace(/'/g,'&#39;')+'\')">'+words[i]+' âœ•</span>';
  }
  document.getElementById('word-tags').innerHTML=html||'<span style="color:var(--gr);font-size:13px;">ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</span>';
}

async function addWord(){
  var w=document.getElementById('new-word-inp').value.trim();
  if(!w) return;
  var words=sg('oshi_banned_words',[]);
  if(words.indexOf(w)<0) words.push(w);
  var notice=sg('oshi_notice','');
  await dbSaveSettings(notice,words);
  document.getElementById('new-word-inp').value='';
  renderWordTags();
}

async function delWord(w){
  var words=sg('oshi_banned_words',[]).filter(function(x){return x!==w;});
  var notice=sg('oshi_notice','');
  await dbSaveSettings(notice,words);
  renderWordTags();
}

async function saveNotice(){
  var txt=document.getElementById('notice-edit').value.trim();
  var words=sg('oshi_banned_words',[]);
  await dbSaveSettings(txt,words);
  showNoticeFromText(txt);
  alert('æ³¨æ„äº‹é …ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function openAddTeam(){
  document.getElementById('ov-team-title').textContent='ãƒãƒ¼ãƒ ã‚’è¿½åŠ ï¼ˆ'+adminLeague+'ï¼‰';
  document.getElementById('t-name').value='';
  document.getElementById('t-emoji').value='';
  document.getElementById('t-stadium').value='';
  document.getElementById('t-stadium-img').value='';
  document.getElementById('t-players').value='';
  document.getElementById('t-id').value='';
  document.getElementById('ov-team').classList.add('on');
}

function openEditTeam(enc){
  var t=JSON.parse(decodeURIComponent(enc));
  document.getElementById('ov-team-title').textContent='ãƒãƒ¼ãƒ ã‚’ç·¨é›†';
  document.getElementById('t-name').value=t.name;
  document.getElementById('t-emoji').value=t.emoji;
  document.getElementById('t-stadium').value=t.stadium||'';
  document.getElementById('t-stadium-img').value=t.stadiumImg||'';
  document.getElementById('t-players').value=(t.players||[]).map(function(p){return p.no+' '+p.name;}).join('\n');
  document.getElementById('t-id').value=t.id||'';
  document.getElementById('ov-team').classList.add('on');
}

function saveTeam(){
  var name=document.getElementById('t-name').value.trim();
  var emoji=document.getElementById('t-emoji').value.trim()||'âš½';
  var stadium=document.getElementById('t-stadium').value.trim();
  var stadiumImg=document.getElementById('t-stadium-img').value.trim();
  var raw=document.getElementById('t-players').value.trim();
  var editId=document.getElementById('t-id').value.trim();
  if(!name){alert('ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var lines=raw.split('\n');
  var players=[];
  for(var i=0;i<lines.length;i++){
    var line=lines[i].trim(); if(!line) continue;
    var parts=line.split(/\s+/);
    var no=parseInt(parts[0]); var pname=parts.slice(1).join(' ');
    if(!isNaN(no)&&pname) players.push({no:no,name:pname});
  }
  var teams=sg('oshi_teams',defaultTeams());
  if(!teams[adminLeague]) teams[adminLeague]=[];
  var teamData={id:editId||nid(),name:name,emoji:emoji,stadium:stadium,stadiumImg:stadiumImg,players:players};
  if(editId){
    var idx=teams[adminLeague].findIndex(function(t){return t.id===editId;});
    if(idx>=0) teams[adminLeague][idx]=teamData;
    else teams[adminLeague].push(teamData);
  } else {
    teams[adminLeague].push(teamData);
  }
  ss('oshi_teams',teams);
  closeOv('ov-team');
  renderAdminTeams();
}

function delTeam(id,name){
  if(!confirm('ã€Œ'+name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  var teams=sg('oshi_teams',defaultTeams());
  if(teams[adminLeague]) teams[adminLeague]=teams[adminLeague].filter(function(t){return t.id!==id;});
  ss('oshi_teams',teams);
  renderAdminTeams();
}
</script>
</body>
</html>
