<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¨ã—ãƒãƒƒãƒ</title>
<style>
:root{--pk:#FF3D8B;--nv:#0D0D2B;--nv2:#1A1A3E;--nv3:#252550;--gd:#FFD166;--mn:#06D6A0;--wh:#F0F0FF;--gr:#8888AA;--rd:#FF6B6B;--bl:#4A90E2;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:-apple-system,'Hiragino Sans',sans-serif;background:var(--nv);color:var(--wh);min-height:100vh;overflow-x:hidden;}

/* PAGES */
.pg{display:none;height:100vh;flex-direction:column;overflow:hidden;}
.pg.on{display:flex;}
.pg-body{flex:1;overflow-y:auto;padding:16px;}
.pg-ftr{padding:0 16px 16px;display:flex;flex-direction:column;gap:9px;flex-shrink:0;}

/* HEADER */
.hdr{background:var(--nv2);padding:13px 17px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--pk);flex-shrink:0;}
.logo{font-size:17px;font-weight:900;color:var(--pk);}
.logo b{color:var(--gd);}
.sm-badge{background:var(--nv3);border:1px solid var(--gd);color:var(--gd);font-size:11px;font-weight:700;padding:3px 9px;border-radius:18px;}

/* BOTTOM NAV - 5ã‚¿ãƒ– */
.bnav{background:var(--nv2);border-top:1px solid var(--nv3);display:flex;padding:8px 0 22px;flex-shrink:0;}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:2px 0;position:relative;}
.ni-ico{font-size:20px;}
.ni-lbl{font-size:9px;color:var(--gr);font-weight:700;}
.ni.on .ni-lbl{color:var(--pk);}
.ni.on .ni-ico{filter:drop-shadow(0 0 4px var(--pk));}
.ni-badge{position:absolute;top:0;right:12%;background:var(--rd);color:#fff;font-size:9px;font-weight:900;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px;}

/* TABS */
.tabs{display:flex;background:var(--nv2);border-bottom:1px solid var(--nv3);flex-shrink:0;}
.tab{flex:1;padding:11px;text-align:center;font-size:13px;font-weight:700;color:var(--gr);cursor:pointer;border-bottom:3px solid transparent;}
.tab.on{color:var(--pk);border-bottom-color:var(--pk);}

/* TYPOGRAPHY */
.ttl{font-size:18px;font-weight:900;margin-bottom:4px;}
.sub{color:var(--gr);font-size:13px;margin-bottom:15px;}

/* BUTTONS */
.btn{border:none;padding:13px;border-radius:48px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;width:100%;}
.btn-p{background:linear-gradient(135deg,var(--pk),#9B5DE5);color:#fff;box-shadow:0 4px 16px rgba(255,61,139,.3);}
.btn-s{background:transparent;color:var(--pk);border:2px solid var(--pk);}
.btn-g{background:linear-gradient(135deg,var(--mn),#0099CC);color:var(--nv);}
.btn-r{background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);}
.btn-b{background:rgba(74,144,226,.15);color:var(--bl);border:1px solid var(--bl);}
.btn-sm{padding:7px 13px;border-radius:18px;font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;border:none;}
.btn:disabled{opacity:.5;cursor:default;}

/* HERO */
.hero{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 20px;text-align:center;gap:18px;background:radial-gradient(ellipse at 30% 20%,#2D0B55,var(--nv) 65%);}
.hero-ico{font-size:72px;line-height:1;}
.hero-ttl{font-size:26px;font-weight:900;}
.hero-sub{color:var(--gr);font-size:14px;line-height:1.6;}

/* CARDS */
.team-item{background:var(--nv2);border-radius:13px;padding:13px 15px;display:flex;align-items:center;gap:12px;margin-bottom:9px;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
.team-item:active{border-color:var(--pk);}
.team-ico{width:40px;height:40px;background:var(--nv3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.team-name{font-weight:700;font-size:14px;}
.team-sub{color:var(--gr);font-size:11px;margin-top:2px;}

/* GOODS GRID */
.g-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:16px;}
.g-card{background:var(--nv2);border-radius:13px;padding:13px 8px;text-align:center;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
.g-card:active,.g-card.sel{border-color:var(--pk);}
.g-card img{width:60px;height:60px;object-fit:cover;border-radius:8px;margin-bottom:7px;}
.g-card .emo{font-size:40px;display:block;margin-bottom:7px;}
.g-card .lbl{font-size:11px;font-weight:700;word-break:break-all;line-height:1.3;}

/* NUMBER GRID */
.n-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:16px;}
.n-chip{background:var(--nv3);border-radius:10px;padding:10px 5px;text-align:center;cursor:pointer;border:2px solid transparent;transition:all .15s;user-select:none;}
.n-chip.have{background:rgba(6,214,160,.15);border-color:var(--mn);color:var(--mn);}
.n-chip.want{background:rgba(255,61,139,.15);border-color:var(--pk);color:var(--pk);}
.n-chip.trading{background:rgba(255,209,102,.1);border-color:var(--gd);color:var(--gd);cursor:default;}
.n-chip .nn{font-size:13px;font-weight:900;}
.n-chip .np{font-size:9px;color:inherit;opacity:.8;margin-top:2px;}

/* LEGEND */
.legend{display:flex;gap:16px;margin-bottom:12px;font-size:12px;}
.leg{display:flex;align-items:center;gap:5px;}
.leg-dot{width:10px;height:10px;border-radius:50%;}

/* INPUT */
.inp{background:var(--nv3);border:1px solid var(--nv3);border-radius:10px;padding:12px;color:var(--wh);font-size:14px;font-family:inherit;width:100%;margin-bottom:10px;outline:none;}
.inp:focus{border-color:var(--pk);}
.lbl{font-size:11px;color:var(--gr);font-weight:700;margin-bottom:5px;display:block;}

/* SEARCH */
.search-box{background:var(--nv3);border-radius:10px;padding:10px 13px;display:flex;align-items:center;gap:8px;margin-bottom:13px;}
.search-box input{background:transparent;border:none;color:var(--wh);font-size:14px;font-family:inherit;flex:1;outline:none;}

/* RESULT ITEMS */
.result-item{background:var(--nv2);border-radius:13px;padding:14px;margin-bottom:10px;border:2px solid transparent;}
.trading-item{border-color:rgba(255,209,102,.4);}
.ri-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.ri-user{display:flex;align-items:center;gap:9px;}
.ri-name{font-weight:700;font-size:13px;}
.ri-sub{font-size:11px;color:var(--gr);}
.ri-mine{font-size:10px;background:rgba(255,61,139,.2);color:var(--pk);border:1px solid var(--pk);padding:2px 7px;border-radius:10px;font-weight:700;}
.status-badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:10px;}
.sb-open{background:rgba(6,214,160,.15);color:var(--mn);border:1px solid var(--mn);}
.sb-trading{background:rgba(255,209,102,.15);color:var(--gd);border:1px solid var(--gd);}
.tag-row{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px;}
.tag{font-size:11px;font-weight:700;padding:3px 8px;border-radius:8px;}
.tag.h{background:rgba(6,214,160,.15);color:var(--mn);border:1px solid var(--mn);}
.tag.w{background:rgba(255,61,139,.15);color:var(--pk);border:1px solid var(--pk);}
.tag.t{background:rgba(255,209,102,.15);color:var(--gd);border:1px solid var(--gd);}

/* MESSAGES */
.msg-thread{background:var(--nv2);border-radius:13px;padding:13px 15px;display:flex;align-items:center;gap:12px;margin-bottom:9px;cursor:pointer;border:2px solid transparent;position:relative;overflow:hidden;transition:transform .2s;}
.msg-thread.trading{border-color:rgba(255,209,102,.3);}
.msg-thread.done{border-color:rgba(6,214,160,.3);}
.thread-info{flex:1;min-width:0;}
.thread-name{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.thread-last{font-size:11px;color:var(--gr);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.thread-time{font-size:10px;color:var(--gr);flex-shrink:0;}
.unread-dot{width:10px;height:10px;background:var(--pk);border-radius:50%;flex-shrink:0;}
.read-badge{font-size:10px;color:var(--mn);}

/* SWIPE DELETE */
.thread-wrap{position:relative;margin-bottom:9px;}
.thread-del-btn{position:absolute;right:0;top:0;bottom:0;width:70px;background:var(--rd);border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;opacity:0;transition:opacity .2s;}
.thread-wrap.swiped .msg-thread{transform:translateX(-70px);}
.thread-wrap.swiped .thread-del-btn{opacity:1;}

/* CHAT */
.c-msgs{flex:1;overflow-y:auto;padding:13px;}
.msg{padding:9px 13px;border-radius:13px;max-width:75%;font-size:13px;line-height:1.5;margin-bottom:8px;word-break:break-word;}
.msg.s{background:linear-gradient(135deg,var(--pk),#9B5DE5);color:#fff;margin-left:auto;border-bottom-right-radius:3px;}
.msg.r{background:var(--nv2);margin-right:auto;border-bottom-left-radius:3px;}
.msg.sys{background:rgba(255,255,255,.07);color:var(--gr);margin:0 auto 8px;text-align:center;font-size:11px;max-width:90%;}
.msg-time{font-size:9px;opacity:.6;margin-top:3px;text-align:right;}
.read-txt{font-size:9px;color:var(--mn);text-align:right;margin-top:-4px;margin-bottom:4px;}
.c-bar{padding:9px 13px;background:var(--nv2);border-top:1px solid var(--nv3);display:flex;gap:8px;align-items:center;flex-shrink:0;}
.c-bar input{flex:1;background:var(--nv3);border:none;border-radius:20px;padding:10px 15px;color:var(--wh);font-size:14px;font-family:inherit;outline:none;}
.c-send{background:var(--pk);border:none;border-radius:50%;width:38px;height:38px;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* TRADE INFO BAR */
.trade-bar{background:var(--nv3);padding:10px 13px;border-bottom:1px solid var(--nv2);flex-shrink:0;}
.trade-bar-ttl{font-size:11px;color:var(--gr);font-weight:700;margin-bottom:5px;}
.trade-nums{display:flex;flex-wrap:wrap;gap:4px;}

/* STADIUM */
.stadium-area{background:var(--nv3);border-radius:10px;overflow:hidden;margin:0 13px 9px;}
.stadium-area img{width:100%;height:120px;object-fit:cover;}
.stadium-name{padding:7px 11px;font-size:12px;color:var(--gr);}

/* AVATAR */
.ava{width:38px;height:38px;background:linear-gradient(135deg,var(--pk),#9B5DE5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.ava.sm{width:28px;height:28px;font-size:14px;}

/* NOTICE */
.notice-box{background:rgba(255,209,102,.1);border:1px solid rgba(255,209,102,.4);border-radius:13px;padding:13px;margin-bottom:16px;display:none;}
.notice-ttl{color:var(--gd);font-size:12px;font-weight:700;margin-bottom:5px;}

/* STAT CARDS */
.stat-row{display:flex;gap:9px;margin-bottom:16px;}
.stat-card{flex:1;background:var(--nv2);border-radius:13px;padding:13px;text-align:center;}
.stat-n{font-size:24px;font-weight:900;color:var(--pk);}
.stat-l{font-size:11px;color:var(--gr);margin-top:3px;}

/* MY PAGE */
.my-ava-big{width:72px;height:72px;background:linear-gradient(135deg,var(--pk),#9B5DE5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 11px;cursor:pointer;position:relative;}
.my-ava-edit{position:absolute;bottom:0;right:0;background:var(--nv2);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid var(--nv3);}
.my-id{text-align:center;font-size:13px;color:var(--gr);margin-bottom:4px;}
.my-name{text-align:center;font-weight:900;font-size:16px;margin-bottom:16px;}
.my-section{margin-bottom:20px;}
.my-sec-ttl{font-size:12px;color:var(--gr);font-weight:700;margin-bottom:9px;padding-bottom:5px;border-bottom:1px solid var(--nv3);}
.my-listing{background:var(--nv2);border-radius:11px;padding:11px 13px;margin-bottom:7px;display:flex;align-items:center;gap:10px;}
.my-listing-info{flex:1;min-width:0;}
.fav-player{background:var(--nv2);border-radius:11px;padding:10px 13px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;}

/* OVERLAY */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:flex-end;}
.overlay.on{display:flex;}
.sheet{background:var(--nv2);border-radius:20px 20px 0 0;padding:20px 20px 36px;width:100%;max-height:85vh;overflow-y:auto;}
.handle{width:40px;height:4px;background:var(--nv3);border-radius:2px;margin:0 auto 16px;}
.sheet-ttl{font-size:18px;font-weight:900;margin-bottom:6px;}
.sheet-sub{font-size:13px;color:var(--gr);margin-bottom:18px;}

/* UPLOAD */
.up-area{border:2px dashed var(--nv3);border-radius:13px;padding:32px 16px;text-align:center;cursor:pointer;margin-bottom:13px;}
.up-area:active{border-color:var(--pk);}
.up-prev{display:none;margin-bottom:13px;}
.up-prev img{width:100%;max-height:200px;object-fit:cover;border-radius:10px;}

/* ADMIN */
.a-sec{background:var(--nv3);border-radius:11px;padding:11px 13px;margin-bottom:7px;}
.a-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.a-btns{margin-left:auto;display:flex;gap:5px;}
.btn-ed{background:rgba(74,144,226,.2);color:var(--bl);border:1px solid var(--bl);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;}
.btn-dl{background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;}
.p-tag{background:var(--nv2);border-radius:6px;padding:2px 7px;font-size:10px;color:var(--gr);margin:2px;}
.word-tag{background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);border-radius:8px;padding:4px 10px;font-size:12px;cursor:pointer;display:inline-block;margin:3px;}

/* REPORT */
.report-item{background:var(--nv3);border-radius:11px;padding:11px 13px;margin-bottom:7px;border-left:3px solid var(--rd);}

/* NOTIFICATION BANNER */
.notif-banner{background:var(--nv2);border:1px solid var(--pk);border-radius:13px;padding:13px;margin-bottom:13px;display:flex;align-items:center;gap:10px;}

/* BANNED SCREEN */
.banned-screen{display:none;position:fixed;inset:0;background:var(--nv);z-index:999;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:32px;}
.banned-screen.on{display:flex;}

/* EMPTY */
.empty{text-align:center;padding:40px 20px;color:var(--gr);}
.ei{font-size:48px;margin-bottom:13px;}

/* BACK BTN */
.back-btn{background:transparent;border:none;color:var(--gr);font-size:22px;cursor:pointer;padding:0;display:flex;align-items:center;gap:5px;font-family:inherit;font-size:13px;}

/* TOAST */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(30,30,60,.95);color:#fff;padding:11px 20px;border-radius:24px;font-size:13px;font-weight:700;z-index:9999;pointer-events:none;opacity:0;transition:opacity .3s;white-space:nowrap;border:1px solid rgba(255,255,255,.15);}
.toast.show{opacity:1;}
</style>
</head>
<body>

<!-- ========== BANNED SCREEN ========== -->
<div class="banned-screen" id="banned-screen">
  <div style="font-size:64px;margin-bottom:16px;">ğŸš«</div>
  <div style="font-size:20px;font-weight:900;margin-bottom:9px;color:var(--rd);">åˆ©ç”¨åœæ­¢</div>
  <div style="color:var(--gr);font-size:14px;line-height:1.6;">ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ç®¡ç†è€…ã«ã‚ˆã‚Šåˆ©ç”¨åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚<br>å¿ƒå½“ãŸã‚ŠãŒã‚ã‚‹å ´åˆã¯ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</div>
</div>

<!-- ========== PAGE: HOME ========== -->
<div class="pg on" id="pg-home">
  <div class="hdr">
    <div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div>
    <div class="sm-badge" id="hdr-badge">ğŸ‰ 0ä»¶æˆç«‹</div>
  </div>
  <div class="pg-body">
    <div class="notice-box" id="home-notice">
      <div class="notice-ttl">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</div>
      <div id="notice-text"></div>
    </div>
    <div class="hero" style="border-radius:16px;margin-bottom:16px;min-height:200px;">
      <div class="hero-ico">âš½</div>
      <div class="hero-ttl">æ¨ã—ã®é¸æ‰‹ã‚°ãƒƒã‚ºã‚’<br>äº¤æ›ã—ã‚ˆã†ï¼</div>
      <div class="hero-sub">ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã§ç›´æ¥äº¤æ›ã€‚<br>ã‹ã¶ã‚Šã‚°ãƒƒã‚ºã‚’æ¨ã—ã«å¤‰ãˆã‚ˆã†ã€‚</div>
    </div>
    <div class="stat-row">
      <div class="stat-card"><div class="stat-n" id="total-n">0</div><div class="stat-l">ç·äº¤æ›æˆç«‹æ•°</div></div>
      <div class="stat-card"><div class="stat-n" id="my-trades">0</div><div class="stat-l">è‡ªåˆ†ã®äº¤æ›æ•°</div></div>
    </div>

    <!-- Share Section -->
    <div style="background:linear-gradient(135deg,rgba(255,61,139,.12),rgba(155,93,229,.12));border:1px solid rgba(255,61,139,.3);border-radius:16px;padding:16px;text-align:center;margin-bottom:16px;">
      <div style="font-size:13px;color:var(--wh);font-weight:700;margin-bottom:4px;">ç´ æ•µã ã¨æ€ã£ãŸã‚‰æ‹¡æ•£å”åŠ›ãŠé¡˜ã„ğŸ¤²</div>
      <div style="margin-bottom:13px;"></div>
      <button onclick="shareToX()" style="background:#000;color:#fff;border:none;border-radius:48px;padding:13px 28px;font-size:14px;font-weight:900;font-family:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(0,0,0,.4);">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        ã‚·ã‚§ã‚¢ã™ã‚‹
      </button>
    </div>
  </div>
  <div class="bnav" id="main-bnav">
    <div class="ni on" onclick="navTo('home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="navTo('reg')"><div class="ni-ico">ï¼‹</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="navTo('search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="navTo('msg')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><div class="ni-badge" id="msg-badge" style="display:none;">0</div></div>
    <div class="ni" onclick="navTo('mypage')"><div class="ni-ico">ğŸ‘¤</div><div class="ni-lbl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== PAGE: REGISTER ========== -->
<div class="pg" id="pg-reg">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge">ç™»éŒ²</div></div>
  <div id="reg-step1" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
    <div class="tabs" id="reg-league-tabs">
      <div class="tab on" onclick="switchLeague('J1',this,'reg')">J1</div>
      <div class="tab" onclick="switchLeague('J2',this,'reg')">J2</div>
      <div class="tab" onclick="switchLeague('J3',this,'reg')">J3</div>
    </div>
    <div class="pg-body">
      <div class="ttl">ãƒãƒ¼ãƒ ã‚’é¸ã¶</div>
      <div class="sub">å¿œæ´ã—ã¦ã„ã‚‹ãƒãƒ¼ãƒ ã‚’é¸ã‚“ã§ãã ã•ã„</div>
      <div class="search-box"><span>ğŸ”</span><input type="text" id="reg-team-q" placeholder="ãƒãƒ¼ãƒ åã§æ¤œç´¢..." oninput="renderTeamList('reg')"></div>
      <div id="reg-team-list"></div>
    </div>
  </div>
  <div id="reg-step2" style="flex:1;display:flex;flex-direction:column;overflow:hidden;display:none;">
    <div class="pg-body">
      <button class="back-btn" onclick="showRegStep(1)" style="margin-bottom:13px;">â† ãƒãƒ¼ãƒ ã‚’é¸ã³ç›´ã™</button>
      <div class="ttl">ã‚°ãƒƒã‚ºã‚’é¸ã¶</div>
      <div class="sub" id="reg-team-label2">ãƒãƒ¼ãƒ å</div>
      <div class="g-grid" id="reg-g-grid"></div>
      <button class="btn btn-s" onclick="showNewGoodsSheet()" style="margin-top:4px;">ï¼‹ æ–°ã—ã„ã‚°ãƒƒã‚ºã‚’ç™»éŒ²</button>
    </div>
  </div>
  <div id="reg-step3" style="flex:1;display:flex;flex-direction:column;overflow:hidden;display:none;">
    <div class="pg-body">
      <button class="back-btn" onclick="showRegStep(2)" style="margin-bottom:13px;">â† ã‚°ãƒƒã‚ºã‚’é¸ã³ç›´ã™</button>
      <div class="ttl">èƒŒç•ªå·ã‚’é¸ã¶</div>
      <div class="sub" id="reg-num-sub"></div>
      <div class="legend">
        <div class="leg"><div class="leg-dot" style="background:var(--mn)"></div><span style="font-size:11px;">æŒã£ã¦ã„ã‚‹</span></div>
        <div class="leg"><div class="leg-dot" style="background:var(--pk)"></div><span style="font-size:11px;">æ¬²ã—ã„</span></div>
        <div class="leg"><div class="leg-dot" style="background:var(--gd)"></div><span style="font-size:11px;">å–å¼•ä¸­</span></div>
      </div>
      <div id="reg-n-grid" class="n-grid"></div>
    </div>
    <div class="pg-ftr">
      <button class="btn btn-p" onclick="submitMyListing()">ç™»éŒ²ã™ã‚‹</button>
      <button class="btn btn-s" onclick="showRegStep(2)">â† ã‚°ãƒƒã‚ºã‚’é¸ã³ç›´ã™</button>
    </div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="navTo('home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni on" onclick="navTo('reg')"><div class="ni-ico">ï¼‹</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="navTo('search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="navTo('msg')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><div class="ni-badge" id="msg-badge2" style="display:none;">0</div></div>
    <div class="ni" onclick="navTo('mypage')"><div class="ni-ico">ğŸ‘¤</div><div class="ni-lbl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== PAGE: SEARCH ========== -->
<div class="pg" id="pg-search">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge">æ¢ã™</div></div>
  <div id="search-step1" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
    <div class="tabs" id="search-league-tabs">
      <div class="tab on" onclick="switchLeague('J1',this,'search')">J1</div>
      <div class="tab" onclick="switchLeague('J2',this,'search')">J2</div>
      <div class="tab" onclick="switchLeague('J3',this,'search')">J3</div>
    </div>
    <div class="pg-body">
      <div class="ttl">æ¢ã™</div>
      <div class="sub">ãƒãƒ¼ãƒ ãƒ»é¸æ‰‹ãƒ»ã‚°ãƒƒã‚ºã§æ¤œç´¢</div>
      <div class="search-box"><span>ğŸ”</span><input type="text" id="search-team-q" placeholder="ãƒãƒ¼ãƒ åã§æ¤œç´¢..." oninput="renderTeamList('search')"></div>
      <div id="search-team-list"></div>
    </div>
  </div>
  <div id="search-step2" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
    <div class="pg-body">
      <button class="back-btn" onclick="showSearchStep(1)" style="margin-bottom:13px;">â† <span id="search-team-label"></span></button>
      <div class="ttl">é¸æ‰‹ã‚’é¸ã¶</div>
      <div id="search-player-list"></div>
    </div>
  </div>
  <div id="search-step3" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
    <div class="pg-body">
      <button class="back-btn" onclick="showSearchStep(2)" style="margin-bottom:13px;">â† <span id="search-player-label"></span></button>
      <div class="ttl">ã‚°ãƒƒã‚ºã‚’é¸ã¶</div>
      <div class="g-grid" id="search-g-grid"></div>
    </div>
  </div>
  <div id="search-step4" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
    <div class="pg-body">
      <button class="back-btn" onclick="showSearchStep(3)" style="margin-bottom:13px;">â† <span id="search-result-label"></span></button>
      <div id="search-results-list"></div>
    </div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="navTo('home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="navTo('reg')"><div class="ni-ico">ï¼‹</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni on" onclick="navTo('search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="navTo('msg')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><div class="ni-badge" id="msg-badge3" style="display:none;">0</div></div>
    <div class="ni" onclick="navTo('mypage')"><div class="ni-ico">ğŸ‘¤</div><div class="ni-lbl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== PAGE: MESSAGES ========== -->
<div class="pg" id="pg-messages">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
  <div class="pg-body">
    <div id="msg-thread-list"></div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="navTo('home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="navTo('reg')"><div class="ni-ico">ï¼‹</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="navTo('search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni on" onclick="navTo('msg')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div></div>
    <div class="ni" onclick="navTo('mypage')"><div class="ni-ico">ğŸ‘¤</div><div class="ni-lbl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== PAGE: CHAT ========== -->
<div class="pg" id="pg-chat">
  <div class="hdr">
    <button class="back-btn" onclick="go('pg-messages');renderMsgThreads();" style="color:var(--wh);">â† æˆ»ã‚‹</button>
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="ava sm" id="c-ava">ğŸ˜Š</div>
      <div>
        <div style="font-weight:700;font-size:13px;" id="c-name"></div>
        <div style="font-size:10px;color:var(--gr);" id="c-status"></div>
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;">
      <span id="c-goods-badge" style="font-size:10px;color:var(--gd);font-weight:700;"></span>
      <button class="btn-sm" style="background:rgba(255,107,107,.15);color:var(--rd);border:1px solid var(--rd);font-size:11px;" onclick="showReportSheet()">å ±å‘Š</button>
    </div>
  </div>
  <!-- Trade info bar -->
  <div class="trade-bar" id="trade-bar">
    <div class="trade-bar-ttl">ğŸ“¦ ã“ã®äº¤æ›ã«ã¤ã„ã¦</div>
    <div id="trade-bar-content"></div>
  </div>
  <!-- Stadium -->
  <div class="stadium-area" id="stadium-area" style="display:none;margin-top:9px;">
    <img id="stadium-img" src="" alt="">
    <div class="stadium-name" id="stadium-name"></div>
  </div>
  <div class="c-msgs" id="c-msgs"></div>
  <div id="c-input-area">
    <div class="c-bar">
      <input type="text" id="c-inp" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
      <button class="c-send" onclick="sendMsg()">â¤</button>
    </div>
    <div style="display:flex;gap:8px;padding:0 13px 9px;">
      <button class="btn btn-g" style="padding:10px;font-size:12px;" id="done-trade-btn" onclick="showDoneModal()">âœ… äº¤æ›å®Œäº†</button>
      <button class="btn btn-r" style="padding:10px;font-size:12px;" id="cancel-trade-btn" onclick="showCancelModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- ========== PAGE: MYPAGE ========== -->
<div class="pg" id="pg-mypage">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge" id="my-badge">ğŸŒ±</div></div>
  <div class="pg-body" style="position:relative;">
    <!-- é€æ˜ãªç®¡ç†è€…ãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹ãƒ»3ç§’é•·æŠ¼ã—ï¼‰ -->
    <div id="admin-secret-btn" style="position:absolute;bottom:10px;right:10px;width:50px;height:50px;z-index:10;cursor:pointer;border-radius:50%;" onmousedown="startAdminHold()" onmouseup="cancelAdminHold()" ontouchstart="startAdminHold()" ontouchend="cancelAdminHold()"></div>

    <div class="my-ava-big" id="my-ava-big" onclick="openEditProfile()">
      <span id="p-ava">ğŸ˜Š</span>
      <div class="my-ava-edit">âœï¸</div>
    </div>
    <div class="my-name" id="p-name">æ¨ã—ãƒ•ã‚¡ãƒ³</div>
    <div class="my-id" id="p-uid">ID: ---</div>

    <div class="stat-row" style="margin-bottom:20px;">
      <div class="stat-card"><div class="stat-n" id="my-trades2">0</div><div class="stat-l">äº¤æ›æˆç«‹æ•°</div></div>
      <div class="stat-card"><div class="stat-n" id="my-listings-n">0</div><div class="stat-l">ç™»éŒ²ä¸­ã‚°ãƒƒã‚º</div></div>
    </div>

    <div class="my-section">
      <div class="my-sec-ttl">â­ ãŠæ°—ã«å…¥ã‚Šé¸æ‰‹</div>
      <div id="fav-player-list"></div>
      <button class="btn btn-s" style="padding:10px;font-size:13px;" onclick="navTo('search');showSearchStep(1);">ï¼‹ é¸æ‰‹ã‚’æ¢ã—ã¦è¿½åŠ </button>
    </div>

    <div class="my-section">
      <div class="my-sec-ttl">ğŸ“¦ ç™»éŒ²ä¸­ã‚°ãƒƒã‚º</div>
      <div id="my-listings-list"></div>
    </div>
  </div>
  <div class="bnav">
    <div class="ni" onclick="navTo('home')"><div class="ni-ico">ğŸ </div><div class="ni-lbl">ãƒ›ãƒ¼ãƒ </div></div>
    <div class="ni" onclick="navTo('reg')"><div class="ni-ico">ï¼‹</div><div class="ni-lbl">ç™»éŒ²</div></div>
    <div class="ni" onclick="navTo('search')"><div class="ni-ico">ğŸ”</div><div class="ni-lbl">æ¢ã™</div></div>
    <div class="ni" onclick="navTo('msg')"><div class="ni-ico">ğŸ’¬</div><div class="ni-lbl">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><div class="ni-badge" id="msg-badge5" style="display:none;">0</div></div>
    <div class="ni on" onclick="navTo('mypage')"><div class="ni-ico">ğŸ‘¤</div><div class="ni-lbl">ãƒã‚¤ãƒšãƒ¼ã‚¸</div></div>
  </div>
</div>

<!-- ========== PAGE: TRADE NUMBERS ========== -->
<div class="pg" id="pg-trade-nums">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge">äº¤æ›å¸Œæœ›</div></div>
  <div class="pg-body">
    <div class="ttl">èƒŒç•ªå·ã‚’é¸ã¶</div>
    <div class="sub" id="trade-num-sub"></div>
    <div class="legend">
      <div class="leg"><div class="leg-dot" style="background:var(--mn)"></div><span style="font-size:11px;">æŒã£ã¦ã„ã‚‹</span></div>
      <div class="leg"><div class="leg-dot" style="background:var(--pk)"></div><span style="font-size:11px;">æ¬²ã—ã„</span></div>
    </div>
    <div id="trade-n-grid" class="n-grid"></div>
  </div>
  <div class="pg-ftr">
    <button class="btn btn-p" onclick="submitTradeRequest()">äº¤æ›å¸Œæœ›ã‚’é€ã‚‹</button>
    <button class="btn btn-s" onclick="go('pg-search')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ========== PAGE: ADMIN LOGIN ========== -->
<div class="pg" id="pg-admin-login">
  <div class="hdr"><div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b></div><div class="sm-badge">ç®¡ç†</div></div>
  <div class="pg-body">
    <div style="padding-top:40px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">ğŸ”</div>
      <div class="ttl" style="text-align:center;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
      <div class="sub" style="text-align:center;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <input class="inp" type="password" id="admin-pw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin-bottom:13px;">
      <button class="btn btn-p" onclick="checkPw()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button class="btn btn-s" onclick="go('pg-mypage')" style="margin-top:9px;">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- ========== PAGE: ADMIN ========== -->
<div class="pg" id="pg-admin">
  <div class="hdr">
    <div class="logo">æ¨ã—<b>ãƒãƒƒãƒ</b> <span style="color:var(--gr);font-size:13px;">ç®¡ç†</span></div>
    <button class="btn-sm btn-s" onclick="go('pg-mypage')">æˆ»ã‚‹</button>
  </div>
  <div class="tabs" id="admin-main-tabs">
    <div class="tab on" onclick="switchAdminTab('teams',this)">ãƒãƒ¼ãƒ </div>
    <div class="tab" onclick="switchAdminTab('notice',this)">ãŠçŸ¥ã‚‰ã›</div>
    <div class="tab" onclick="switchAdminTab('words',this)">ç¦æ­¢</div>
    <div class="tab" onclick="switchAdminTab('reports',this)">å ±å‘Š</div>
    <div class="tab" onclick="switchAdminTab('goods-a',this)">ã‚°ãƒƒã‚º</div>
  </div>

  <!-- Teams Tab -->
  <div id="admin-teams-tab" class="pg-body">
    <div class="tabs" id="admin-league-tabs" style="margin:-16px -16px 16px;">
      <div class="tab on" onclick="switchAdminLeague('J1',this)">J1</div>
      <div class="tab" onclick="switchAdminLeague('J2',this)">J2</div>
      <div class="tab" onclick="switchAdminLeague('J3',this)">J3</div>
    </div>
    <button class="btn btn-p" onclick="openAddTeam()" style="margin-bottom:13px;padding:11px;">ï¼‹ ãƒãƒ¼ãƒ ã‚’è¿½åŠ </button>
    <div id="admin-team-list"></div>
  </div>

  <!-- Notice Tab -->
  <div id="admin-notice-tab" class="pg-body" style="display:none;">
    <div class="ttl">ãŠçŸ¥ã‚‰ã›ç·¨é›†</div>
    <div class="sub">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆç©ºæ¬„ã§éè¡¨ç¤ºï¼‰</div>
    <textarea class="inp" id="notice-edit" rows="5" placeholder="ãŠçŸ¥ã‚‰ã›ã‚’å…¥åŠ›..."></textarea>
    <div class="ttl" style="margin-top:13px;">è©¦åˆæƒ…å ±</div>
    <div class="sub">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¡¨ç¤ºã™ã‚‹è©¦åˆæƒ…å ±</div>
    <input class="inp" id="match-info-edit" placeholder="ä¾‹ï¼š3/15 æ ƒæœ¨SC vs ç¦å³¶ ã‚«ãƒ³ã‚»ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ">
    <button class="btn btn-p" onclick="saveNotice()">ä¿å­˜ã™ã‚‹</button>
  </div>

  <!-- Banned Words Tab -->
  <div id="admin-words-tab" class="pg-body" style="display:none;">
    <div class="ttl">ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰</div>
    <div class="sub">ãƒãƒ£ãƒƒãƒˆã§ä½¿ç”¨ã§ããªã„è¨€è‘‰</div>
    <div style="display:flex;gap:8px;margin-bottom:13px;">
      <input class="inp" id="new-word-inp" placeholder="ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="margin-bottom:0;flex:1;">
      <button class="btn btn-p" onclick="addWord()" style="width:auto;padding:12px 16px;">è¿½åŠ </button>
    </div>
    <div id="word-tags"></div>
  </div>

  <!-- Reports Tab -->
  <div id="admin-reports-tab" class="pg-body" style="display:none;">
    <div class="ttl">å ±å‘Šä¸€è¦§</div>
    <div class="sub">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å ±å‘Š</div>
    <div id="admin-reports-list"></div>
    <div class="ttl" style="margin-top:20px;">BANãƒªã‚¹ãƒˆ</div>
    <div class="sub">åˆ©ç”¨åœæ­¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</div>
    <div style="display:flex;gap:8px;margin-bottom:13px;">
      <input class="inp" id="ban-uid-inp" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›" style="margin-bottom:0;flex:1;">
      <button class="btn btn-r" onclick="addBan()" style="width:auto;padding:12px 16px;">BAN</button>
    </div>
    <div id="ban-list"></div>
  </div>

  <!-- Goods Tab -->
  <div id="admin-goods-a-tab" class="pg-body" style="display:none;">
    <div class="ttl">ã‚°ãƒƒã‚ºä¸€è¦§</div>
    <div id="admin-goods-list"></div>
  </div>
</div>

<!-- ========== PAGE: NOTIFICATION PERMISSION ========== -->
<div class="pg" id="pg-notif">
  <div class="pg-body" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;">
    <div style="font-size:72px;margin-bottom:20px;">ğŸ””</div>
    <div class="ttl" style="text-align:center;margin-bottom:9px;">é€šçŸ¥ã‚’å—ã‘å–ã‚‹</div>
    <div style="text-align:center;color:var(--gr);font-size:14px;line-height:1.6;margin-bottom:30px;">
      äº¤æ›å¸Œæœ›ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»<br>ãŠæ°—ã«å…¥ã‚Šé¸æ‰‹ã®ã‚°ãƒƒã‚ºç™»éŒ²æ™‚ã«<br>ãŠçŸ¥ã‚‰ã›ã—ã¾ã™
    </div>
    <button class="btn btn-p" onclick="requestNotif()" style="margin-bottom:13px;">é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹</button>
    <button class="btn btn-s" onclick="skipNotif()">å¾Œã§è¨­å®šã™ã‚‹</button>
  </div>
</div>

<!-- ========== OVERLAYS ========== -->
<!-- New Goods -->
<div class="overlay" id="ov-new-goods">
  <div class="sheet">
    <div class="handle"></div>
    <div class="sheet-ttl">æ–°ã—ã„ã‚°ãƒƒã‚ºã‚’ç™»éŒ²</div>
    <div class="sheet-sub">å†™çœŸã¨åå‰ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
    <div id="up-area" class="up-area" onclick="document.getElementById('file-inp').click()">
      <div style="font-size:36px;margin-bottom:8px;">ğŸ“·</div>
      <div style="font-size:14px;font-weight:700;">å†™çœŸã‚’é¸ã¶</div>
      <div style="font-size:12px;color:var(--gr);margin-top:4px;">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</div>
    </div>
    <div id="up-prev" class="up-prev"><img id="up-img" src=""><br><button class="btn-sm btn-s" onclick="document.getElementById('file-inp').click()" style="margin-top:7px;">å†™çœŸã‚’å¤‰æ›´</button></div>
    <input type="file" id="file-inp" accept="image/*" style="display:none;" onchange="previewFile(this)">
    <span class="lbl">ã‚«ãƒ†ã‚´ãƒª</span>
    <select class="inp" id="ng-cat">
      <option>ç¼¶ãƒãƒƒã‚¸</option><option>ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰</option><option>ã‚¬ãƒãƒ£</option>
      <option>ã‚¿ã‚ªãƒ«</option><option>ãƒ¦ãƒ‹ãƒ•ã‚©ãƒ¼ãƒ </option><option>ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«</option>
      <option>ã‚¹ãƒ†ãƒƒã‚«ãƒ¼</option><option>ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼</option><option>ãƒ•ã‚©ãƒˆã‚«ãƒ¼ãƒ‰</option><option>ãã®ä»–</option>
    </select>
    <span class="lbl">ã‚°ãƒƒã‚ºåãƒ»è©³ç´°</span>
    <input class="inp" id="ng-name" placeholder="ä¾‹ï¼šç¬¬3å¼¾ #4 ä½è—¤ç¥¥">
    <button class="btn btn-p" id="ng-btn" onclick="saveNewGoods()">ç™»éŒ²ã—ã¦èƒŒç•ªå·ã‚’é¸ã¶ â†’</button>
    <button class="btn btn-s" onclick="closeOv('ov-new-goods')" style="margin-top:9px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Done -->
<div class="overlay" id="ov-done">
  <div class="sheet">
    <div class="handle"></div>
    <div style="font-size:44px;text-align:center;margin-bottom:10px;">âœ…</div>
    <div class="sheet-ttl">äº¤æ›å®Œäº†ã‚’å ±å‘Š</div>
    <div class="sheet-sub">ç›¸æ‰‹ã‚‚å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨äº¤æ›æˆç«‹ã«ãªã‚Šã¾ã™ã€‚</div>
    <button class="btn btn-g" onclick="confirmDone()" style="margin-bottom:9px;">å®Œäº†ã—ãŸï¼</button>
    <button class="btn btn-s" onclick="closeOv('ov-done')">æˆ»ã‚‹</button>
  </div>
</div>

<!-- Cancel -->
<div class="overlay" id="ov-cancel">
  <div class="sheet">
    <div class="handle"></div>
    <div style="font-size:44px;text-align:center;margin-bottom:10px;">âŒ</div>
    <div class="sheet-ttl">äº¤æ›ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
    <div class="sheet-sub">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ç™»éŒ²ã‚°ãƒƒã‚ºãŒäº¤æ›å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚</div>
    <button class="btn btn-r" onclick="confirmCancel()" style="margin-bottom:9px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-cancel')">æˆ»ã‚‹</button>
  </div>
</div>

<!-- Report -->
<div class="overlay" id="ov-report">
  <div class="sheet">
    <div class="handle"></div>
    <div style="font-size:44px;text-align:center;margin-bottom:10px;">ğŸš¨</div>
    <div class="sheet-ttl">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å ±å‘Š</div>
    <div class="sheet-sub">ä¸é©åˆ‡ãªã‚„ã‚Šã¨ã‚Šã‚’ç®¡ç†è€…ã«å ±å‘Šã—ã¾ã™ã€‚</div>
    <span class="lbl">å ±å‘Šç†ç”±</span>
    <select class="inp" id="report-reason">
      <option>ä¸é©åˆ‡ãªè¨€å‹•</option><option>å€‹äººæƒ…å ±ã®è¦æ±‚</option><option>è©æ¬ºãƒ»ãªã‚Šã™ã¾ã—</option>
      <option>èª¹è¬—ä¸­å‚·</option><option>ãã®ä»–</option>
    </select>
    <span class="lbl">è©³ç´°ï¼ˆä»»æ„ï¼‰</span>
    <textarea class="inp" id="report-detail" rows="3" placeholder="è©³ã—ãæ•™ãˆã¦ãã ã•ã„"></textarea>
    <button class="btn btn-r" onclick="submitReport()" style="margin-bottom:9px;">å ±å‘Šã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-report')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Edit Profile -->
<div class="overlay" id="ov-profile">
  <div class="sheet">
    <div class="handle"></div>
    <div class="sheet-ttl">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div>
    <span class="lbl">è¡¨ç¤ºå</span>
    <input class="inp" id="edit-name" placeholder="è¡¨ç¤ºå">
    <span class="lbl">ã‚¢ã‚¤ã‚³ãƒ³çµµæ–‡å­—</span>
    <div id="emoji-picker" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:13px;background:var(--nv3);padding:11px;border-radius:10px;">
      <!-- rendered by JS -->
    </div>
    <span id="edit-emoji-preview" style="font-size:32px;text-align:center;display:block;margin-bottom:13px;"></span>
    <button class="btn btn-p" onclick="saveProfile()" style="margin-bottom:9px;">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-profile')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Add/Edit Team -->
<div class="overlay" id="ov-team">
  <div class="sheet">
    <div class="handle"></div>
    <div class="sheet-ttl" id="ov-team-title">ãƒãƒ¼ãƒ ã‚’è¿½åŠ </div>
    <div class="sheet-sub">
      ğŸ’¡ é¸æ‰‹ç™»éŒ²æ–¹æ³•ï¼šJãƒªãƒ¼ã‚°ã®URLï¼ˆä¾‹: https://www.jleague.jp/club/tochigi/player/ï¼‰ã‚’
      <a href="https://claude.ai" target="_blank" style="color:var(--pk);">Claude.ai</a> ã«è²¼ã£ã¦
      ã€Œã“ã®URLã®ãƒãƒ¼ãƒ ã®é¸æ‰‹ã‚’ã€ŒèƒŒç•ªå· åå‰ã€å½¢å¼ã§ä¸€è¦§ã«ã—ã¦ã€ã¨ä¾é ¼â†’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸‹ã«è²¼ã‚Šä»˜ã‘
    </div>
    <span class="lbl">ãƒãƒ¼ãƒ å</span>
    <input class="inp" id="t-name" placeholder="ä¾‹ï¼šæ ƒæœ¨SC">
    <span class="lbl">çµµæ–‡å­—</span>
    <input class="inp" id="t-emoji" placeholder="ä¾‹ï¼šğŸŸ¡">
    <span class="lbl">ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å</span>
    <input class="inp" id="t-stadium" placeholder="ä¾‹ï¼šã‚«ãƒ³ã‚»ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã¨ã¡ã">
    <span class="lbl">ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç”»åƒURLï¼ˆä»»æ„ï¼‰</span>
    <input class="inp" id="t-stadium-img" placeholder="https://...">
    <span class="lbl">é¸æ‰‹ä¸€è¦§ï¼ˆã€ŒèƒŒç•ªå· åå‰ã€ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰</span>
    <textarea class="inp" id="t-players" rows="9" style="resize:vertical;" placeholder="1 å·ç”°ä¿®å¹³&#10;4 ä½è—¤ç¥¥&#10;5 æŸ³è‚²å´‡"></textarea>
    <input type="hidden" id="t-id">
    <button class="btn btn-p" onclick="saveTeam()" style="margin-bottom:9px;">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-s" onclick="closeOv('ov-team')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- Confirm Sheet -->
<div class="overlay" id="ov-confirm">
  <div class="sheet">
    <div class="handle"></div>
    <div class="sheet-ttl" style="text-align:center;margin-bottom:9px;" id="confirm-msg">ç¢ºèª</div>
    <button class="btn btn-r" id="confirm-ok-btn" style="margin-bottom:9px;">ã¯ã„</button>
    <button class="btn btn-s" onclick="closeOv('ov-confirm')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>


<div id="toast" class="toast"></div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// ============================================================
// FIREBASE INIT
// ============================================================
firebase.initializeApp({
  apiKey: "AIzaSyBiLft_UAh3FxTQ2BlMDxc9ztues6LiBoo",
  authDomain: "oshi-match-2c8e6.firebaseapp.com",
  projectId: "oshi-match-2c8e6",
  storageBucket: "oshi-match-2c8e6.firebasestorage.app",
  messagingSenderId: "518098690390",
  appId: "1:518098690390:web:f33481ca687d80fa2d76f7"
});
var db = firebase.firestore();

// ============================================================
// LOCAL CACHE & HELPERS
// ============================================================
function sg(k,d){try{var v=localStorage.getItem(k);return v!==null?JSON.parse(v):d;}catch(e){return d;}}
function ss(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}
function nid(){try{return db.collection('_').doc().id;}catch(e){return '_'+Math.random().toString(36).substr(2,9);}}
function fmtTime(ts){if(!ts)return'';var d=new Date(ts);return d.getHours()+':'+('0'+d.getMinutes()).slice(-2);}

// ============================================================
// FIREBASE DB HELPERS
// ============================================================
async function dbGetListings(){
  try{
    var snap=await db.collection('listings').where('status','in',['open','trading']).get();
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_listings',arr); return arr;
  }catch(e){return sg('oshi_listings',[]);}
}
async function dbSaveListing(data){
  try{
    if(data.id&&data.id.length>5){await db.collection('listings').doc(data.id).set(data);}
    else{var ref=await db.collection('listings').add(data);data.id=ref.id;}
    var arr=sg('oshi_listings',[]);var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0)arr[idx]=data;else arr.push(data);ss('oshi_listings',arr);return data;
  }catch(e){var a=sg('oshi_listings',[]);a.push(data);ss('oshi_listings',a);return data;}
}
async function dbUpdateListing(id,update){
  try{await db.collection('listings').doc(id).update(update);}catch(e){}
  var arr=sg('oshi_listings',[]);var idx=arr.findIndex(function(x){return x.id===id;});
  if(idx>=0){Object.assign(arr[idx],update);ss('oshi_listings',arr);}
}
async function dbDeleteListing(id){
  try{await db.collection('listings').doc(id).delete();}catch(e){}
  ss('oshi_listings',sg('oshi_listings',[]).filter(function(x){return x.id!==id;}));
}
async function dbGetThreads(){
  try{
    var snap=await db.collection('threads').where('users','array-contains',myUid).get();
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    // Filter out cancelled+done (auto-delete from view)
    arr=arr.filter(function(t){return t.status==='trading'||t.status==='open';});
    ss('oshi_threads',arr);return arr;
  }catch(e){return sg('oshi_threads',[]).filter(function(t){return t.status==='trading'||t.status==='open';});}
}
async function dbSaveThread(data){
  try{
    if(data.id&&data.id.length>5){await db.collection('threads').doc(data.id).set(data);}
    else{var ref=await db.collection('threads').add(data);data.id=ref.id;}
    var arr=sg('oshi_threads',[]);var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0)arr[idx]=data;else arr.push(data);ss('oshi_threads',arr);return data;
  }catch(e){var a=sg('oshi_threads',[]);a.push(data);ss('oshi_threads',a);return data;}
}
async function dbUpdateThread(id,update){
  try{await db.collection('threads').doc(id).update(update);}catch(e){}
  var arr=sg('oshi_threads',[]);var idx=arr.findIndex(function(x){return x.id===id;});
  if(idx>=0){Object.assign(arr[idx],update);ss('oshi_threads',arr);}
}
async function dbDeleteThread(id){
  try{await db.collection('threads').doc(id).delete();}catch(e){}
  ss('oshi_threads',sg('oshi_threads',[]).filter(function(x){return x.id!==id;}));
}
async function dbGetGoods(){
  try{
    var snap=await db.collection('goods').get();
    var now=Date.now();var sixMo=180*24*60*60*1000;
    var arr=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());})
      .filter(function(g){return !g.lastUsed||(now-g.lastUsed)<sixMo;});
    if(arr.length)ss('oshi_goods',arr);return arr.length?arr:sg('oshi_goods',[]);
  }catch(e){return sg('oshi_goods',[]);}
}
async function dbSaveGoods(data){
  try{
    if(data.id&&data.id.length>5){await db.collection('goods').doc(data.id).set(data);}
    else{var ref=await db.collection('goods').add(data);data.id=ref.id;}
    var arr=sg('oshi_goods',[]);var idx=arr.findIndex(function(x){return x.id===data.id;});
    if(idx>=0)arr[idx]=data;else arr.push(data);ss('oshi_goods',arr);return data;
  }catch(e){var a=sg('oshi_goods',[]);a.push(data);ss('oshi_goods',a);return data;}
}
async function dbDeleteGoods(id){
  try{
    await db.collection('goods').doc(id).delete();
  }catch(e){console.error('delete goods error',e);}
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚‚å‰Šé™¤
  var arr=sg('oshi_goods',[]).filter(function(x){return x.id!==id;});
  ss('oshi_goods',arr);
}
async function dbGetSettings(){
  try{
    var snap=await db.collection('settings').doc('global').get();
    if(snap.exists){var d=snap.data();ss('oshi_notice',d.notice||'');ss('oshi_banned_words',d.bannedWords||[]);ss('oshi_match_info',d.matchInfo||'');return d;}
  }catch(e){}
  return{notice:sg('oshi_notice',''),bannedWords:sg('oshi_banned_words',[]),matchInfo:sg('oshi_match_info','')};
}
async function dbSaveSettings(notice,bannedWords,matchInfo){
  try{await db.collection('settings').doc('global').set({notice:notice,bannedWords:bannedWords,matchInfo:matchInfo||''});}catch(e){}
  ss('oshi_notice',notice);ss('oshi_banned_words',bannedWords);ss('oshi_match_info',matchInfo||'');
}
async function dbIncrementTrades(){
  try{await db.collection('settings').doc('global').update({totalTrades:firebase.firestore.FieldValue.increment(1)});}catch(e){}
  ss('oshi_total',sg('oshi_total',0)+1);
}
async function dbGetTotal(){
  try{var s=await db.collection('settings').doc('global').get();if(s.exists)return s.data().totalTrades||0;}catch(e){}
  return sg('oshi_total',0);
}
async function dbSaveReport(data){
  try{await db.collection('reports').add(data);}catch(e){}
}
async function dbGetReports(){
  try{var s=await db.collection('reports').orderBy('at','desc').limit(50).get();return s.docs.map(function(d){return Object.assign({id:d.id},d.data());});}catch(e){return[];}
}
async function dbSaveBan(uid){
  try{await db.collection('banned').doc(uid).set({uid:uid,at:Date.now()});}catch(e){}
  var list=sg('oshi_banned_list',[]);if(list.indexOf(uid)<0){list.push(uid);ss('oshi_banned_list',list);}
}
async function dbCheckBan(uid){
  try{var s=await db.collection('banned').doc(uid).get();return s.exists;}catch(e){return sg('oshi_banned_list',[]).indexOf(uid)>=0;}
}
async function dbGetBans(){
  try{var s=await db.collection('banned').get();return s.docs.map(function(d){return d.id;});}catch(e){return sg('oshi_banned_list',[]);}
}
async function dbRemoveBan(uid){
  try{await db.collection('banned').doc(uid).delete();}catch(e){}
  ss('oshi_banned_list',sg('oshi_banned_list',[]).filter(function(x){return x!==uid;}));
}

// ============================================================
// STATE
// ============================================================
var myUid, myEmoji, myName;
var regLeague='J1', searchLeague='J1';
var selRegTeam=null, selRegGoodsId=null, selRegGoodsName=null, regNumStates={};
var searchTeam=null, searchPlayer=null, searchGoodsId=null, searchGoodsName=null;
var tradeTargetId=null, tradeTargetUserId=null, tradeNumStates={};
var curChatThreadId=null;
var adminLeague='J1';
var adminHoldTimer=null;
var ADMIN_PW='oshimatch2024';

// ============================================================
// TEAM DATA (J3â†’J2â†’J1)
// ============================================================
function defaultTeams(){
  return{
    J1:[
      {id:'j1t01',name:'é¹¿å³¶ã‚¢ãƒ³ãƒˆãƒ©ãƒ¼ã‚º',emoji:'ğŸ”´',stadium:'ã‚«ã‚·ãƒã‚µãƒƒã‚«ãƒ¼ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ—©å·å‹åŸº'},{no:4,name:'æ¤ç”°ç›´é€š'},{no:7,name:'çŸ¥å¿µæ…¶'},{no:9,name:'éˆ´æœ¨å„ªç£¨'},{no:10,name:'æŸ´å´å²³'},{no:13,name:'ä»²é–“éš¼æ–—'},{no:14,name:'æ¨‹å£é›„å¤ª'},{no:18,name:'åå¤æ–°å¤ªéƒ'},{no:20,name:'å¸«å²¡æŸŠç”Ÿ'},{no:30,name:'å‰ç”°æ¹Šæµ·'}]},
      {id:'j1t02',name:'æ°´æˆ¸ãƒ›ãƒ¼ãƒªãƒ¼ãƒ›ãƒƒã‚¯',emoji:'ğŸ’™',stadium:'ã‚±ãƒ¼ã‚ºãƒ‡ãƒ³ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ°´æˆ¸',stadiumImg:'',players:[{no:1,name:'ä¸­å±±é–‹å¸†'},{no:9,name:'å®‰è—¤ç‘å­£'},{no:10,name:'å±±å£ä¸€çœŸ'},{no:13,name:'æ¢…ç”°å‡Œæˆ‘'}]},
      {id:'j1t03',name:'æµ¦å’Œãƒ¬ãƒƒã‚º',emoji:'ğŸ”´',stadium:'åŸ¼ç‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ 2002',stadiumImg:'',players:[{no:1,name:'è¥¿å·å‘¨ä½œ'},{no:3,name:'å®®æœ¬å„ªå¤ª'},{no:5,name:'å²©å°¾æ†²'},{no:8,name:'å°æ³‰ä½³ç©‚'},{no:9,name:'èˆˆæ¢ æ…ä¸‰'},{no:10,name:'ã‚·ãƒ£ãƒ«ã‚¯'},{no:11,name:'å‰ç”°ç›´è¼'},{no:18,name:'æ­¦ç”°è‹±å¯¿'},{no:21,name:'ä¼Šè—¤æ•¦æ¨¹'},{no:30,name:'å®‰å±…æµ·æ¸¡'}]},
      {id:'j1t04',name:'æŸãƒ¬ã‚¤ã‚½ãƒ«',emoji:'ğŸ’›',stadium:'ä¸‰å”ãƒ•ãƒ­ãƒ³ãƒ†ã‚¢æŸã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ¾æœ¬å¥å¤ª'},{no:4,name:'çŠ¬é£¼æ™ºä¹Ÿ'},{no:7,name:'æˆ¸å¶‹ç¥¥éƒ'},{no:9,name:'ç´°è°·çœŸå¤§'},{no:10,name:'ãƒãƒ†ã‚¦ã‚¹ ã‚µãƒ´ã‚£ã‚ª'},{no:11,name:'æœ¨ä¸‹åº·ä»‹'},{no:14,name:'å·å£å°šç´€'},{no:18,name:'ç´ºé‡å’Œä¹Ÿ'}]},
      {id:'j1t05',name:'ã‚¸ã‚§ãƒ•ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰åƒè‘‰',emoji:'ğŸŸ ',stadium:'ãƒ•ã‚¯ãƒ€é›»å­ã‚¢ãƒªãƒ¼ãƒŠ',stadiumImg:'',players:[{no:1,name:'éˆ´æœ¨æ¤‹å¤§'},{no:7,name:'æœ«å‰å¡'},{no:9,name:'ãƒ‰ã‚¦ã‚°ãƒ©ã‚¹'},{no:10,name:'ç”°å£æ³°å£«'},{no:11,name:'ã‚´ãƒ¼ãƒ‰ãƒ³'}]},
      {id:'j1t06',name:'FCæ±äº¬',emoji:'ğŸ’™',stadium:'å‘³ã®ç´ ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'é‡æ¾¤å¤§å¿—ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ³'},{no:5,name:'æœ¨æœ¬æ­ç”Ÿ'},{no:9,name:'ãƒ‡ã‚£ã‚¨ã‚´ ã‚ªãƒªãƒ´ã‚§ã‚¤ãƒ©'},{no:10,name:'æ¾æœ¨ç–ç”Ÿ'},{no:11,name:'ä»²å·è¼äºº'},{no:20,name:'è’æœ¨é¼å¤ªéƒ'},{no:23,name:'ä¿µç©ç”°æ™ƒå¤ª'}]},
      {id:'j1t07',name:'æ±äº¬ãƒ´ã‚§ãƒ«ãƒ‡ã‚£',emoji:'ğŸ’š',stadium:'å‘³ã®ç´ ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ãƒãƒ†ã‚¦ã‚¹'},{no:8,name:'æ£®ç”°æ™ƒæ¨¹'},{no:9,name:'æœ¨æ‘å‹‡å¤§'},{no:10,name:'è¦‹æœ¨å‹å“‰'},{no:11,name:'å±±è¦‹å¤§ç™»'},{no:20,name:'æŸ“é‡å”¯æœˆ'}]},
      {id:'j1t08',name:'FCç”ºç”°ã‚¼ãƒ«ãƒ“ã‚¢',emoji:'ğŸ’™',stadium:'ç”ºç”°GIONã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'è°·æ™ƒç”Ÿ'},{no:9,name:'ã‚ª ã‚»ãƒ•ãƒ³'},{no:10,name:'ä¸‹ç”°åŒ—æ–—'},{no:11,name:'è—¤å°¾ç¿”å¤ª'},{no:14,name:'ä»™é ­å•“çŸ¢'},{no:23,name:'ãƒŸãƒƒãƒã‚§ãƒ« ãƒ‡ãƒ¥ãƒ¼ã‚¯'}]},
      {id:'j1t09',name:'å·å´ãƒ•ãƒ­ãƒ³ã‚¿ãƒ¼ãƒ¬',emoji:'ğŸ’™',stadium:'Uvanceã¨ã©ã‚ãã‚¹ã‚¿ã‚¸ã‚¢ãƒ  by Fujitsu',stadiumImg:'',players:[{no:1,name:'ä¸Šç¦å…ƒç›´äºº'},{no:8,name:'æ©˜ç”°å¥äºº'},{no:9,name:'å±±ç”°æ–°'},{no:10,name:'è„‡å‚æ³°æ–—'},{no:11,name:'ãƒãƒ«ã‚·ãƒ¼ãƒ‹ãƒ§'},{no:14,name:'å®¶é•·æ˜­åš'},{no:34,name:'é•·ç’ƒå–œ'}]},
      {id:'j1t10',name:'æ¨ªæµœFãƒ»ãƒãƒªãƒã‚¹',emoji:'ğŸ’™',stadium:'æ—¥ç”£ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä¸€æ£®ç´”'},{no:8,name:'å–œç”°æ‹“ä¹Ÿ'},{no:9,name:'ã‚¢ãƒ³ãƒ‡ãƒ«ã‚½ãƒ³ ãƒ­ãƒšã‚¹'},{no:10,name:'è¥¿æ‘æ‹“çœŸ'},{no:11,name:'ãƒ¤ãƒ³ ãƒãƒ†ã‚¦ã‚¹'},{no:18,name:'æ¤ä¸­æœæ—¥'},{no:27,name:'æ¸¡è¾ºçš“å¤ª'}]},
      {id:'j1t11',name:'æ¸…æ°´ã‚¨ã‚¹ãƒ‘ãƒ«ã‚¹',emoji:'ğŸŸ ',stadium:'IAIã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ—¥æœ¬å¹³',stadiumImg:'',players:[{no:1,name:'æ¨©ç”°ä¿®ä¸€'},{no:7,name:'çŸ¢å³¶æ…ä¹Ÿ'},{no:9,name:'åŒ—å·èˆªä¹Ÿ'},{no:10,name:'ä¹¾è²´å£«'},{no:11,name:'ã‚«ãƒ«ãƒªãƒ¼ãƒ‹ãƒ§ã‚¹ ã‚¸ãƒ¥ãƒ‹ã‚ª'}]},
      {id:'j1t12',name:'åå¤å±‹ã‚°ãƒ©ãƒ³ãƒ‘ã‚¹',emoji:'ğŸ”´',stadium:'è±Šç”°ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ãƒ©ãƒ³ã‚²ãƒ©ãƒƒã‚¯'},{no:7,name:'å’Œæ³‰ç«œå¸'},{no:8,name:'ç¨²å£ç¥¥'},{no:9,name:'ãƒ‘ãƒˆãƒªãƒƒã‚¯'},{no:10,name:'æ°¸äº•è¬™ä½‘'},{no:11,name:'æ£®å³¶å¸'}]},
      {id:'j1t13',name:'äº¬éƒ½ã‚µãƒ³ã‚¬FC',emoji:'ğŸ’œ',stadium:'ã‚µãƒ³ã‚¬ã‚¹ã‚¿ã‚¸ã‚¢ãƒ  by KYOCERA',stadiumImg:'',players:[{no:1,name:'ã‚¯ ã‚½ãƒ³ãƒ¦ãƒ³'},{no:7,name:'è±Šå·é›„å¤ª'},{no:9,name:'ã‚¸ãƒ§ãƒ«ãƒ‡ã‚£ ã‚¯ãƒ«ãƒ¼ã‚¯ã‚¹'},{no:10,name:'ç¦ç”°å¿ƒä¹‹åŠ©'},{no:11,name:'ãƒãƒ«ã‚³ ãƒˆã‚¥ãƒ¼ãƒªã‚ª'}]},
      {id:'j1t14',name:'ã‚¬ãƒ³ãƒå¤§é˜ª',emoji:'ğŸ’™',stadium:'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¹ç”°',stadiumImg:'',players:[{no:1,name:'æ±å£é †æ˜­'},{no:7,name:'å€‰ç”°ç§‹'},{no:9,name:'å®‡ä½ç¾è²´å²'},{no:10,name:'ãƒã‚¿ ãƒ©ãƒ´ã‚£'},{no:11,name:'ã‚¦ã‚§ãƒ«ãƒˆãƒ³'},{no:14,name:'å±±æœ¬æ‚ æ¨¹'}]},
      {id:'j1t15',name:'ã‚»ãƒ¬ãƒƒã‚½å¤§é˜ª',emoji:'ğŸŒ¸',stadium:'ãƒ¨ãƒ‰ã‚³ã‚¦æ¡œã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ã‚¸ãƒ³ãƒ’ãƒ§ãƒ³'},{no:7,name:'ä¹¾è²´å£«'},{no:8,name:'éˆ´æœ¨å¾³çœŸ'},{no:9,name:'ãƒ¬ã‚ª ã‚»ã‚¢ãƒ©'},{no:10,name:'é¦™å·çœŸå¸'},{no:11,name:'ç‚ºç”°å¤§è²´'}]},
      {id:'j1t16',name:'ãƒ´ã‚£ãƒƒã‚»ãƒ«ç¥æˆ¸',emoji:'ğŸ”´',stadium:'ãƒã‚¨ãƒ“ã‚¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç¥æˆ¸',stadiumImg:'',players:[{no:1,name:'å‰å·é»›ä¹Ÿ'},{no:7,name:'æ­¦è—¤å˜‰ç´€'},{no:8,name:'å±±å£è›'},{no:9,name:'å¤§è¿«å‹‡ä¹Ÿ'},{no:10,name:'ã‚¤ãƒ‹ã‚¨ã‚¹ã‚¿'},{no:16,name:'é…’äº•é«˜å¾³'}]},
      {id:'j1t17',name:'ãƒ•ã‚¡ã‚¸ã‚¢ãƒ¼ãƒå²¡å±±',emoji:'ğŸ’›',stadium:'ã‚·ãƒ†ã‚£ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å €ç”°å¤§æš‰'},{no:9,name:'ã‚°ãƒ¬ã‚¤ã‚½ãƒ³'},{no:10,name:'ç”°ä¸­é›„å¤§'},{no:11,name:'å¤ªç”°é¾ä¹‹ä»‹'},{no:13,name:'æ¾ç”°ä¸€è¼'}]},
      {id:'j1t18',name:'ã‚µãƒ³ãƒ•ãƒ¬ãƒƒãƒã‚§åºƒå³¶',emoji:'ğŸ’œ',stadium:'ã‚¨ãƒ‡ã‚£ã‚ªãƒ³ãƒ”ãƒ¼ã‚¹ã‚¦ã‚¤ãƒ³ã‚°åºƒå³¶',stadiumImg:'',players:[{no:1,name:'å¤§è¿«æ•¬ä»‹'},{no:7,name:'æº€ç”°èª '},{no:8,name:'æ¾æœ¬æ³°å¿—'},{no:9,name:'å¤§æ©‹ç¥ç´€'},{no:10,name:'åŠ è—¤é™¸æ¬¡æ¨¹'},{no:11,name:'å·æ‘æ‹“å¤¢'}]},
      {id:'j1t19',name:'Vãƒ»ãƒ•ã‚¡ãƒ¼ãƒ¬ãƒ³é•·å´',emoji:'ğŸ’™',stadium:'ãƒˆãƒ©ãƒ³ã‚¹ã‚³ã‚¹ãƒ¢ã‚¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ é•·å´',stadiumImg:'',players:[{no:1,name:'å¯Œæ¾¤é›…ä¹Ÿ'},{no:9,name:'ãƒ•ã‚¡ãƒ³ ãƒã‚¿'},{no:10,name:'ãƒãƒ«ã‚³ã‚¹ ã‚®ã‚¸ã‚§ãƒ«ãƒ¢'},{no:11,name:'ã‚¨ã‚¸ã‚¬ãƒ« ã‚¸ãƒ¥ãƒ‹ã‚ª'}]},
      {id:'j1t20',name:'ã‚¢ãƒ“ã‚¹ãƒ‘ç¦å²¡',emoji:'ğŸ’™',stadium:'ãƒ™ã‚¹ãƒˆé›»å™¨ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ‘ä¸Šæ˜Œè¬™'},{no:7,name:'ç´ºé‡å’Œä¹Ÿ'},{no:9,name:'ã‚¦ã‚§ãƒªãƒ³ãƒˆãƒ³'},{no:10,name:'é‡è¦‹æŸ¾æ–—'},{no:11,name:'åŒ—å³¶ç¥äºŒ'}]}
    ],
    J2:[
      {id:'j2t01',name:'åŒ—æµ·é“ã‚³ãƒ³ã‚µãƒ‰ãƒ¼ãƒ¬æœ­å¹Œ',emoji:'ğŸ”´',stadium:'æœ­å¹Œãƒ‰ãƒ¼ãƒ ',stadiumImg:'',players:[{no:1,name:'è…é‡å­æ†²'},{no:7,name:'é’æœ¨äº®å¤ª'},{no:9,name:'å°æŸå‰›'},{no:10,name:'è’é‡æ‹“é¦¬'},{no:11,name:'è…å¤§è¼'}]},
      {id:'j2t02',name:'ãƒ´ã‚¡ãƒ³ãƒ©ãƒ¼ãƒ¬å…«æˆ¸',emoji:'ğŸ’™',stadium:'ãƒ—ãƒ©ã‚¤ãƒ•ãƒ¼ã‚ºã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'è—¤ç”°å’Œè¼'},{no:9,name:'æ­¦é¢¯'},{no:10,name:'è‰æœ¨ç‘ æ–—'}]},
      {id:'j2t03',name:'ãƒ™ã‚¬ãƒ«ã‚¿ä»™å°',emoji:'ğŸ’›',stadium:'ãƒ¦ã‚¢ãƒ†ãƒƒã‚¯ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ä»™å°',stadiumImg:'',players:[{no:1,name:'ã‚¹ãƒˆã‚¤ã‚·ãƒƒãƒ'},{no:9,name:'ä¸­å³¶å…ƒå½¦'},{no:10,name:'æ¾ä¸‹ä½³è²´'},{no:11,name:'éƒ·å®¶å‹å¤ª'}]},
      {id:'j2t04',name:'ãƒ–ãƒ©ã‚¦ãƒ–ãƒªãƒƒãƒ„ç§‹ç”°',emoji:'ğŸ”µ',stadium:'ã‚½ãƒ¦ãƒ¼ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å±±ç”°å…ƒæ°—'},{no:9,name:'é½‹è—¤æµå¤ª'},{no:10,name:'ä¸­æ‘äº®å¤ª'}]},
      {id:'j2t05',name:'ãƒ¢ãƒ³ãƒ†ãƒ‡ã‚£ã‚ªå±±å½¢',emoji:'ğŸ’™',stadium:'NDã‚½ãƒ•ãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ å±±å½¢',stadiumImg:'',players:[{no:1,name:'å¾Œè—¤é›…æ˜'},{no:9,name:'é«™æ©‹æ½¤å“‰'},{no:10,name:'è—¤æœ¬ä½³å¸Œ'},{no:11,name:'ãƒã‚¢ã‚´ ã‚¢ã‚¦ãƒ™ã‚¹'}]},
      {id:'j2t06',name:'ã„ã‚ãFC',emoji:'âš¡',stadium:'ã„ã‚ãã‚°ãƒªãƒ¼ãƒ³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰',stadiumImg:'',players:[{no:1,name:'ç«‹å·å°å¤ªéƒ'},{no:9,name:'è°·æ‘æµ·é‚£'},{no:10,name:'æœ‰ç”°ç¨œ'}]},
      {id:'j2t07',name:'æ ƒæœ¨ã‚·ãƒ†ã‚£FC',emoji:'ğŸŸ¢',stadium:'æ ƒæœ¨å¸‚ã¨ã¡ãå²©ä¸‹è‡ªç„¶è¾²åœ’ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å¤§è¥¿å‹'},{no:9,name:'æ©‹æœ¬å¥äºº'},{no:10,name:'è‰é‡ä¾‘å·±'}]},
      {id:'j2t08',name:'å¤§å®®ã‚¢ãƒ«ãƒ‡ã‚£ãƒ¼ã‚¸ãƒ£',emoji:'ğŸŸ ',stadium:'NACK5ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¤§å®®',stadiumImg:'',players:[{no:1,name:'å¿—æ‘æ»‰'},{no:9,name:'å¯Œå±±è²´å…‰'},{no:10,name:'çŸ³å·ä¿Šè¼'},{no:11,name:'æ³‰æ¾¤ä»'}]},
      {id:'j2t09',name:'æ¨ªæµœFC',emoji:'ğŸ’™',stadium:'ãƒ‹ãƒƒãƒ‘ãƒ„ä¸‰ãƒ„æ²¢çƒæŠ€å ´',stadiumImg:'',players:[{no:1,name:'å¸‚å·æš‰è¨˜'},{no:9,name:'ã‚«ãƒ–ãƒ¬ãƒ©'},{no:10,name:'ä¸­æ‘ä¿Šè¼”'},{no:11,name:'æ–‰è—¤å…‰æ¯…'}]},
      {id:'j2t10',name:'æ¹˜å—ãƒ™ãƒ«ãƒãƒ¼ãƒ¬',emoji:'ğŸ’š',stadium:'ãƒ¬ãƒ¢ãƒ³ã‚¬ã‚¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¹³å¡š',stadiumImg:'',players:[{no:1,name:'å¯Œå±…å¤§æ¨¹'},{no:9,name:'ãƒ«ã‚­ã‚¢ãƒ³'},{no:10,name:'å¹³å²¡å¤§é™½'},{no:11,name:'éˆ´æœ¨ç« æ–—'}]},
      {id:'j2t11',name:'ãƒ´ã‚¡ãƒ³ãƒ•ã‚©ãƒ¼ãƒ¬ç”²åºœ',emoji:'ğŸ’™',stadium:'JIT ãƒªã‚µã‚¤ã‚¯ãƒ«ã‚¤ãƒ³ã‚¯ ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å²¡è¥¿å®ç¥'},{no:9,name:'ä¸‰å¹³å’Œå¸'},{no:10,name:'æ­¦å¯Œå­ä»‹'}]},
      {id:'j2t12',name:'ã‚¢ãƒ«ãƒ“ãƒ¬ãƒƒã‚¯ã‚¹æ–°æ½Ÿ',emoji:'ğŸŸ ',stadium:'ãƒ‡ãƒ³ã‚«ãƒ“ãƒƒã‚°ã‚¹ãƒ¯ãƒ³ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å°å³¶äº¨ä»‹'},{no:7,name:'æ¾ç”°è© å¤ªéƒ'},{no:9,name:'éˆ´æœ¨å­å¸'},{no:10,name:'é«˜æœ¨å–„æœ—'},{no:11,name:'è°·å£æµ·æ–—'}]},
      {id:'j2t13',name:'ã‚«ã‚¿ãƒ¼ãƒ¬å¯Œå±±',emoji:'âš«',stadium:'å¯Œå±±çœŒç·åˆé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'ç”°å·çŸ¥æ¨¹'},{no:9,name:'å‰å¹³ç¿¼'},{no:10,name:'æ¾å²¡ç‘ å¤¢'}]},
      {id:'j2t14',name:'ã‚¸ãƒ¥ãƒ“ãƒ­ç£ç”°',emoji:'ğŸ’™',stadium:'ãƒ¤ãƒãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä¸‰æµ¦é¾è¼'},{no:9,name:'å¾Œè—¤å•“ä»‹'},{no:10,name:'æ¾æœ¬æ˜Œä¹Ÿ'},{no:11,name:'å¤å·é™½ä»‹'}]},
      {id:'j2t15',name:'è—¤æMYFC',emoji:'ğŸ’š',stadium:'è—¤æç·åˆé‹å‹•å…¬åœ’ã‚µãƒƒã‚«ãƒ¼å ´',stadiumImg:'',players:[{no:1,name:'å†…å±±åœ­'},{no:9,name:'å¹³å°¾å£®'},{no:10,name:'æ°´é‡æ³°è¼”'}]},
      {id:'j2t16',name:'å¾³å³¶ãƒ´ã‚©ãƒ«ãƒ†ã‚£ã‚¹',emoji:'ğŸ’™',stadium:'é³´é–€ãƒ»å¤§å¡šã‚¹ãƒãƒ¼ãƒ„ãƒ‘ãƒ¼ã‚¯ ãƒã‚«ãƒªã‚¹ã‚¨ãƒƒãƒˆã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ¢¶å·è£•å—£'},{no:9,name:'æµœä¸‹ç‘›'},{no:10,name:'è¥¿è°·å’Œå¸Œ'}]},
      {id:'j2t17',name:'FCä»Šæ²»',emoji:'ğŸŸ ',stadium:'ã‚ã‚ŠãŒã¨ã†ã‚µãƒ¼ãƒ“ã‚¹. å¤¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ä¿®è¡Œæ™ºä»'},{no:9,name:'æœ‰ç”°ç¨œ'},{no:10,name:'ä¸‹å·å¤ªé™½'}]},
      {id:'j2t18',name:'ã‚µã‚¬ãƒ³é³¥æ –',emoji:'ğŸ’™',stadium:'é§…å‰ä¸å‹•ç”£ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æœ´ä¸€åœ­'},{no:7,name:'å±±å´å‡Œå¾'},{no:9,name:'æœ¬ç”°é¢¨æ™º'},{no:10,name:'èŠåœ°æ³°æ™º'}]},
      {id:'j2t19',name:'å¤§åˆ†ãƒˆãƒªãƒ‹ãƒ¼ã‚¿',emoji:'ğŸ’™',stadium:'æ˜­å’Œé›»å·¥ãƒ‰ãƒ¼ãƒ å¤§åˆ†',stadiumImg:'',players:[{no:1,name:'ãƒ ãƒ³ ã‚®ãƒ§ãƒ³ã‚´ãƒ³'},{no:9,name:'é•·æ²¢é§¿'},{no:10,name:'æ¸¡é‚‰æ–°å¤ª'}]},
      {id:'j2t20',name:'ãƒ†ã‚²ãƒã‚¸ãƒ£ãƒ¼ãƒ­å®®å´',emoji:'ğŸŸ¢',stadium:'ãƒ¦ãƒ‹ãƒªãƒ¼ãƒã‚¹ã‚¿ã‚¸ã‚¢ãƒ æ–°å¯Œ',stadiumImg:'',players:[{no:1,name:'å±±æœ¬æµ©æ­£'},{no:9,name:'ä¸­åŸç§€äºº'},{no:10,name:'ä½è—¤å’Œå¼˜'}]}
    ],
    J3:[
      {id:'j3t01',name:'ç¦å³¶ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰FC',emoji:'ğŸŸ¢',stadium:'ã¨ã†ã»ã†ãƒ»ã¿ã‚“ãªã®ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[
        {no:1,name:'ä¸Šç”°æ™ºè¼'},{no:5,name:'ç•¶éº»é¢¯'},{no:6,name:'ä¸Šç•‘ä½‘å¹³å£«'},{no:7,name:'èŠ¦éƒ¨æ™ƒç”Ÿ'},
        {no:8,name:'å²¡ç”°å„ªå¸Œ'},{no:9,name:'æ¸…æ°´ä¸€é›…'},{no:10,name:'é‡è°·å²³æ™ƒ'},{no:11,name:'ä¸‰æµ¦çŸ¥è‰¯'},
        {no:14,name:'ä¸­æ‘ç¿¼'},{no:17,name:'è—¤è°·åŒ '},{no:18,name:'çŸ³äº•ç¨œçœŸ'},{no:19,name:'è—¤ç”°ä»æœ—'},
        {no:20,name:'æ³‰å½©ç¨€'},{no:22,name:'å‰ä¸¸çµ¢æ¢“'},{no:23,name:'å®‰åœ¨é”å¼¥'},{no:24,name:'å®ç´æ‹“æ–—'},
        {no:25,name:'æ‘ä¸ŠåŠ›å·±'},{no:26,name:'ç”°ä¸­æ…¶æ±°'},{no:27,name:'é‡æœ«å­¦'},{no:28,name:'éˆ´ç›´æ¨¹'},
        {no:29,name:'åœŸå±‹æ«‚å¤§'},{no:30,name:'ç‹©é‡æµ·æ™Ÿ'},{no:31,name:'å®‰è¥¿é§¿'},{no:32,name:'æ°¸é•·é·¹è™'},
        {no:40,name:'æ¨‹å£å¯›è¦'},{no:41,name:'ç”°ä¸­é›„å¤§'},{no:77,name:'åƒè‘‰è™å£«'},{no:78,name:'ãƒãƒ§ãƒ³ ã‚½ãƒ³ãƒªãƒ§ãƒ³'}
      ]},
      {id:'j3t02',name:'æ ƒæœ¨SC',emoji:'ğŸŸ¡',stadium:'ã‚«ãƒ³ã‚»ã‚­ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã¨ã¡ã',stadiumImg:'',players:[
        {no:1,name:'å·ç”°ä¿®å¹³'},{no:4,name:'ä½è—¤ç¥¥'},{no:5,name:'æŸ³è‚²å´‡'},{no:6,name:'é˜¿éƒ¨æµ·æ–—'},
        {no:7,name:'å·åé€£ä»‹'},{no:9,name:'è¿‘è—¤æ…¶ä¸€'},{no:10,name:'äº”ååµå¤ªé™½'},{no:11,name:'é’å³¶å¤ªä¸€'},
        {no:13,name:'å¤§æ›½æ ¹åºƒæ±°'},{no:14,name:'éˆ´æœ¨ä¿Šä¹Ÿ'},{no:15,name:'å ¤é™½è¼'},{no:17,name:'æ‰æ£®è€ƒèµ·'},
        {no:19,name:'åº„å¸æœ—'},{no:21,name:'æ«»åº­ç«‹æ¨¹'},{no:24,name:'ç”°ç«¯ç‰è–'},{no:25,name:'å²©ï¨‘åš'},
        {no:26,name:'ç”°ç•‘çŸ¥èµ·'},{no:27,name:'æ°¸äº•å¤§å£«'},{no:29,name:'çŸ¢é‡è²´ç« '},{no:31,name:'é¹¿é‡ä¿®å¹³'},
        {no:37,name:'æœ¨é‚¨å„ªäºº'},{no:39,name:'å±‹å®œå’ŒçœŸ'},{no:40,name:'é£Ÿé‡å£®ç£¨'},{no:47,name:'å‰é‡é™½ç¿”'},
        {no:71,name:'çŒªè¶Šå„ªæƒŸ'},{no:77,name:'è¥¿é‡å¤ªé™½'},{no:80,name:'ã‚ªã‚¿ãƒœãƒ¼ ã‚±ãƒã‚¹'},{no:81,name:'ä¸­é‡å…‹å“‰'},{no:88,name:'å†…ç”°èˆªå¹³'}
      ]},
      {id:'j3t03',name:'ã‚¶ã‚¹ãƒ‘ç¾¤é¦¬',emoji:'ğŸŸ¢',stadium:'æ­£ç”°é†¤æ²¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ç¾¤é¦¬',stadiumImg:'',players:[{no:1,name:'æ¸…æ°´æ…¶è¨˜'},{no:9,name:'å²¡æœ¬ä¸€çœŸ'},{no:10,name:'åŸå’Œéš¼é¢¯'},{no:11,name:'åŒ—å·æŸŠæ–—'}]},
      {id:'j3t04',name:'æ¾æœ¬å±±é›…FC',emoji:'ğŸŸ¢',stadium:'ã‚µãƒ³ãƒ—ãƒ­ ã‚¢ãƒ«ã‚¦ã‚£ãƒ³',stadiumImg:'',players:[{no:1,name:'å¤§å†…ä¸€ç”Ÿ'},{no:7,name:'å°æ¾è“®'},{no:9,name:'æ¨ªå±±æ­©å¤¢'},{no:10,name:'è—¤ç”°æ¯å¹'},{no:11,name:'éˆ´æœ¨å›½å‹'}]},
      {id:'j3t05',name:'SCç›¸æ¨¡åŸ',emoji:'âš«',stadium:'ç›¸æ¨¡åŸã‚®ã‚ªãƒ³ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ³¢å¤šé‡è±ª'},{no:9,name:'ãƒ‰ãƒŸãƒ³ã‚²ã‚¹'},{no:10,name:'ç”°ä¸­ãƒ‘ã‚¦ãƒ­æ·³ä¸€'},{no:11,name:'ä¹…ä¿è—¤æ¬¡éƒ'}]},
      {id:'j3t06',name:'ACé•·é‡ãƒ‘ãƒ«ã‚»ã‚¤ãƒ­',emoji:'ğŸ’›',stadium:'é•·é‡Uã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'å¤§é‡å“²ç…¥'},{no:9,name:'ä¸‰ç”°å°šå¸Œ'},{no:10,name:'å®®é˜ªæ”¿æ¨¹'},{no:11,name:'å±±æœ¬å¤§è²´'}]},
      {id:'j3t07',name:'ãƒ„ã‚¨ãƒ¼ã‚²ãƒ³é‡‘æ²¢',emoji:'ğŸ’›',stadium:'çŸ³å·çœŒè¥¿éƒ¨ç·‘åœ°å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'ç™½äº•è£•äºº'},{no:9,name:'ç‰åŸå³»å¾'},{no:10,name:'æ—èª é“'},{no:11,name:'å¤§çŸ³ç«œå¹³'}]},
      {id:'j3t08',name:'FCå²é˜œ',emoji:'ğŸ”µ',stadium:'å²é˜œãƒ¡ãƒ¢ãƒªã‚¢ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼é•·è‰¯å·ç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'æ¡ç•‘å’Œç¹'},{no:9,name:'å±±å†…å¯›å²'},{no:10,name:'è—¤å²¡æµ©ä»‹'},{no:11,name:'ç²Ÿé£¯åŸå°šå¹³'}]},
      {id:'j3t09',name:'ãƒ¬ã‚¤ãƒ©ãƒƒã‚¯æ»‹è³€FC',emoji:'ğŸ’™',stadium:'è‰æ´¥å¸‚ç«‹å¸‚æ°‘ä½“è‚²é¤¨å‰ç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'æ¸…æ°´å¥å¤ª'},{no:9,name:'é½Šè—¤å­¦'},{no:10,name:'å‰é•·çœŸå„ª'},{no:11,name:'æ£šæ©‹å°­å£«'}]},
      {id:'j3t10',name:'å¥ˆè‰¯ã‚¯ãƒ©ãƒ–',emoji:'ğŸŸ¤',stadium:'ãƒ­ãƒ¼ãƒˆ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¥ˆè‰¯',stadiumImg:'',players:[{no:1,name:'ç”°å·çŸ¥æ¨¹'},{no:9,name:'å†…ç”°é”ä¹Ÿ'},{no:10,name:'é«˜æ©‹å¤§æ‚Ÿ'},{no:11,name:'å²¡ç”°å„ªå¸Œ'}]},
      {id:'j3t11',name:'FCå¤§é˜ª',emoji:'ğŸ”µ',stadium:'æ±å¤§é˜ªå¸‚èŠ±åœ’ãƒ©ã‚°ãƒ“ãƒ¼å ´',stadiumImg:'',players:[{no:1,name:'é˜¿éƒ¨ä¼¸è¡Œ'},{no:9,name:'è—¤æœ¬æ·³å¾'},{no:10,name:'ä½è—¤å¤§æ¨¹'},{no:11,name:'æ¾ç”°è© å¤ªéƒ'}]},
      {id:'j3t12',name:'ã‚¬ã‚¤ãƒŠãƒ¼ãƒ¬é³¥å–',emoji:'ğŸ’™',stadium:'Axisãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'è‹¥åŸæ™ºå“‰'},{no:9,name:'ã‚¸ãƒ§ã‚¢ãƒ³ãƒ»ã‚¸ãƒ§ã‚¤ã‚¢'},{no:10,name:'ç”°æ‘ç¿”å¤ª'},{no:11,name:'æ°¸äº•é¾'}]},
      {id:'j3t13',name:'ãƒ¬ãƒãƒ•ã‚¡å±±å£FC',emoji:'ğŸ’™',stadium:'ç¶­æ–°ã¿ã‚‰ã„ãµã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'é–¢æ†²å¤ªéƒ'},{no:7,name:'äº”ååµå¤ªé™½'},{no:9,name:'æ²³é‡å­æ±°'},{no:10,name:'é«˜æœ¨å¤§è¼”'},{no:11,name:'å¤§æ§»å‘¨å¹³'}]},
      {id:'j3t14',name:'æ„›åª›FC',emoji:'ğŸŸ ',stadium:'ãƒ‹ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ç¥å±±ç«œä¸€'},{no:9,name:'è¥¿ç”°æµ'},{no:10,name:'æ£®ç”°æ¶¼é¦¬'},{no:11,name:'çŸ³æµ¦å¤§é›…'}]},
      {id:'j3t15',name:'ã‚«ãƒã‚¿ãƒãƒ¼ãƒ¬è®ƒå²',emoji:'ğŸ’›',stadium:'Pikaraã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ¸…æ°´å¥å¤ª'},{no:9,name:'å¯Œç”°å¥å¤ª'},{no:10,name:'é«˜æ©‹å¤§æ‚Ÿ'},{no:11,name:'å²¡æœ¬å°‡æˆ'}]},
      {id:'j3t16',name:'é«˜çŸ¥ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰SC',emoji:'ğŸ”´',stadium:'æ˜¥é‡ç·åˆé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'å‰ä¸¸çµ¢æ¢“'},{no:9,name:'æ¾ç”°é™¸'},{no:10,name:'ä¸­å±±é™¸'},{no:11,name:'å²¡ç”°å„ªå¸Œ'}]},
      {id:'j3t17',name:'ã‚®ãƒ©ãƒ´ã‚¡ãƒ³ãƒ„åŒ—ä¹å·',emoji:'ğŸ’™',stadium:'ãƒŸã‚¯ãƒ‹ãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ åŒ—ä¹å·',stadiumImg:'',players:[{no:1,name:'æ°¸äº•å …æ¢§'},{no:9,name:'ãƒ‡ã‚£ã‚µãƒ­ç‡¦ã‚·ãƒ«ãƒ´ã‚¡ãƒ¼ãƒ'},{no:10,name:'è—¤åŸå¥ä»‹'},{no:11,name:'åœŸä¿¡ç”°æ‚ ç”Ÿ'}]},
      {id:'j3t18',name:'ãƒ­ã‚¢ãƒƒã‚½ç†Šæœ¬',emoji:'ğŸ”´',stadium:'ãˆãŒãŠå¥åº·ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'ç”°ä»£ç‰æˆ‘'},{no:7,name:'æ±Ÿï¨‘å·§æœ—'},{no:9,name:'ç”°è¾ºé™½å¤ª'},{no:10,name:'å³¶æ‘æ‹“å¼¥'},{no:11,name:'ç«¹æœ¬é›„é£›'}]},
      {id:'j3t19',name:'é¹¿å…å³¶ãƒ¦ãƒŠã‚¤ãƒ†ãƒƒãƒ‰FC',emoji:'âš«',stadium:'ç™½æ³¢ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',stadiumImg:'',players:[{no:1,name:'æ³‰æ£®æ¶¼å¤ª'},{no:9,name:'æœ‰ç”°ç¨œ'},{no:10,name:'ä¸­åŸç§€äºº'},{no:11,name:'ç ‚æ£®å’Œä¹Ÿ'}]},
      {id:'j3t20',name:'FCç‰çƒ',emoji:'ğŸ’™',stadium:'æ²–ç¸„å¸‚é™¸ä¸Šç«¶æŠ€å ´',stadiumImg:'',players:[{no:1,name:'çŒ¿æ©‹å¤ç¶™'},{no:9,name:'é˜¿éƒ¨æ‹“é¦¬'},{no:10,name:'æ¸…æ­¦åŠŸæš‰'},{no:11,name:'æ± ç”°å»‰'}]}
    ]
  };
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded',function(){
  myUid=localStorage.getItem('oshi_uid');
  if(!myUid){myUid='u'+Math.random().toString(36).substr(2,8);localStorage.setItem('oshi_uid',myUid);}
  myName=sg('oshi_name','æ¨ã—ãƒ•ã‚¡ãƒ³ #'+myUid.slice(-4));
  var emos=['ğŸ˜Š','ğŸµ','â­','ğŸŒ¸','ğŸ’«','ğŸ¤','ğŸ†','ğŸŒŸ','ğŸ€','ğŸ’–','ğŸ”¥','ğŸ’','ğŸ¦','ğŸ¯','ğŸ¦‹'];
  myEmoji=sg('oshi_emoji',emos[parseInt(myUid.slice(-2),36)%emos.length]);

  // Check ban - ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚initApp()ã‚’å¿…ãšå®Ÿè¡Œ
  dbCheckBan(myUid).then(function(banned){
    if(banned){document.getElementById('banned-screen').classList.add('on');return;}
    initApp();
  }).catch(function(e){
    console.error('ban check error:',e);
    initApp(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚èµ·å‹•ã™ã‚‹
  });
});

function initApp(){
  updateMyPage();
  if(!sg('oshi_teams',null))ss('oshi_teams',defaultTeams());
  dbGetSettings().then(function(s){
    showNoticeFromText(s.notice||'',s.matchInfo||'');
  });
  dbGetGoods().then(function(goods){
    if(!goods.length){
      // No default goods - users register them
    }
  });
  loadTotalTrades();
  renderTeamList('reg');
  renderTeamList('search');
  renderMsgThreads();
  updateMsgBadge();

  // Check if first time â†’ show notification permission
  if(!sg('oshi_notif_asked',false)){
    go('pg-notif');
  }

  document.getElementById('c-inp').addEventListener('keypress',function(e){if(e.key==='Enter')sendMsg();});

  // Setup swipe-to-delete for threads
  setupSwipeDelete();
}

async function loadTotalTrades(){
  var n=await dbGetTotal();
  document.getElementById('total-n').textContent=n;
  document.getElementById('hdr-badge').textContent='ğŸ‰ '+n+'ä»¶æˆç«‹';
}

function updateMyPage(){
  document.getElementById('p-ava').textContent=myEmoji;
  document.getElementById('p-uid').textContent='ID: '+myUid;
  document.getElementById('p-name').textContent=myName;
  document.getElementById('my-badge').textContent=getBadge(sg('trades_'+myUid,0));
  renderFavPlayers();
  renderMyListings();
  var n=sg('trades_'+myUid,0);
  document.getElementById('my-trades').textContent=n;
  document.getElementById('my-trades2').textContent=n;
}
function getBadge(n){return n>=30?'ğŸ‘‘':n>=10?'ğŸ†':n>=3?'â­':'ğŸŒ±';}

function showNoticeFromText(txt,matchInfo){
  var box=document.getElementById('home-notice');
  var el=document.getElementById('notice-text');
  var content='';
  if(txt&&txt.trim())content+=txt;
  if(matchInfo&&matchInfo.trim())content+=(content?'\n\n':'')+'âš½ '+matchInfo;
  if(content){el.textContent=content;box.style.display='block';}
  else box.style.display='none';
}

// ============================================================
// NOTIFICATION
// ============================================================

function requestNotif(){
  ss('oshi_notif_asked',true);
  if('Notification' in window){
    Notification.requestPermission().then(function(p){
      ss('oshi_notif_granted',p==='granted');
      go('pg-home');
    });
  } else {
    go('pg-home');
  }
}
function skipNotif(){
  ss('oshi_notif_asked',true);
  go('pg-home');
}
function sendLocalNotif(title,body){
  if(sg('oshi_notif_granted',false)&&'Notification' in window&&Notification.permission==='granted'){
    new Notification(title,{body:body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš½</text></svg>'});
  }
}

// ============================================================
// NAVIGATION
// ============================================================
function go(id){
  var pages=document.querySelectorAll('.pg');
  for(var i=0;i<pages.length;i++)pages[i].classList.remove('on');
  document.getElementById(id).classList.add('on');
  window.scrollTo(0,0);
}
function navTo(tab){
  if(tab==='home'){go('pg-home');}
  else if(tab==='reg'){selRegTeam=null;selRegGoodsId=null;selRegGoodsName=null;regNumStates={};go('pg-reg');showRegStep(1);}
  else if(tab==='search'){go('pg-search');showSearchStep(1);}
  else if(tab==='msg'){go('pg-messages');renderMsgThreads();}
  else if(tab==='mypage'){go('pg-mypage');updateMyPage();}
  // Update nav active states
  var navsIds=['main-bnav'];
  // handled by each page's bnav independently
}

// ============================================================
// ADMIN SECRET BUTTON
// ============================================================
function startAdminHold(){
  adminHoldTimer=setTimeout(function(){
    go('pg-admin-login');
  },3000);
}
function cancelAdminHold(){
  if(adminHoldTimer){clearTimeout(adminHoldTimer);adminHoldTimer=null;}
}

// ============================================================
// PROFILE EDIT
// ============================================================
function openEditProfile(){
  document.getElementById('edit-name').value=myName;
  // Emoji picker
  var emos=['ğŸ˜Š','ğŸµ','â­','ğŸŒ¸','ğŸ’«','ğŸ¤','ğŸ†','ğŸŒŸ','ğŸ€','ğŸ’–','ğŸ”¥','ğŸ’','ğŸ¦','ğŸ¯','ğŸ¦‹','âš½','ğŸ…','ğŸ¯','ğŸª','ğŸŒˆ'];
  var html='';
  emos.forEach(function(e){
    html+='<span style="font-size:28px;cursor:pointer;padding:4px;" onclick="selectEmoji(\''+e+'\')">' +e+'</span>';
  });
  document.getElementById('emoji-picker').innerHTML=html;
  document.getElementById('edit-emoji-preview').textContent=myEmoji;
  document.getElementById('ov-profile').classList.add('on');
}
function selectEmoji(e){
  myEmoji=e;
  document.getElementById('edit-emoji-preview').textContent=e;
}
function saveProfile(){
  var name=document.getElementById('edit-name').value.trim();
  if(name)myName=name;
  ss('oshi_emoji',myEmoji);
  ss('oshi_name',myName);
  closeOv('ov-profile');
  updateMyPage();
}

// ============================================================
// MY LISTINGS
// ============================================================
async function renderMyListings(){
  var el=document.getElementById('my-listings-list');
  if(!el)return;
  el.innerHTML='<div style="color:var(--gr);font-size:13px;padding:9px 0;">èª­ã¿è¾¼ã¿ä¸­...</div>';
  var listings=[];
  try{
    var snap=await db.collection('listings').get();
    var all=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_listings',all);
    listings=all.filter(function(l){
      return l.userId===myUid&&l.status!=='done'&&l.status!=='cancelled';
    });
  }catch(e){
    listings=sg('oshi_listings',[]).filter(function(l){
      return l.userId===myUid&&l.status!=='done'&&l.status!=='cancelled';
    });
  }
  document.getElementById('my-listings-n').textContent=listings.length;
  if(!listings.length){el.innerHTML='<div style="color:var(--gr);font-size:13px;padding:9px 0;">ç™»éŒ²ä¸­ã®ã‚°ãƒƒã‚ºã¯ã‚ã‚Šã¾ã›ã‚“</div>';return;}
  var html='';
  listings.forEach(function(l){
    var status=l.status==='trading'?'<span style="color:var(--gd);font-size:11px;">ğŸ”„ å–å¼•ä¸­</span>':'<span style="color:var(--mn);font-size:11px;">âœ… äº¤æ›å¯èƒ½</span>';
    var haveNos=(l.have||[]).map(function(n){return '#'+n;}).join(' ');
    html+='<div class="my-listing"><div style="font-size:20px;">ğŸ“¦</div>';
    html+='<div class="my-listing-info">';
    html+='<div style="font-weight:700;font-size:13px;">'+l.goodsName+'</div>';
    html+='<div style="font-size:11px;color:var(--gr);">'+l.team+'</div>';
    html+='<div style="font-size:11px;margin-top:2px;">'+haveNos+' '+status+'</div>';
    html+='</div>';
    html+='<button class="btn-dl" data-id="'+l.id+'" onclick="cancelMyListing(this.dataset.id)">å–æ¶ˆ</button></div>';
  });
  el.innerHTML=html;
}
function cancelMyListing(id){
  showConfirmSheet('ã“ã®ç™»éŒ²ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ',async function(){
    try{
      await db.collection('listings').doc(id).delete();
    }catch(e){console.error('listing delete err:',e);}
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚‚å‰Šé™¤
    ss('oshi_listings',sg('oshi_listings',[]).filter(function(x){return x.id!==id;}));
    showToast('å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†å–å¾—ï¼ˆFirestoreåæ˜ å¾…ã¡ï¼‰
    setTimeout(async function(){await renderMyListings();},500);
  });
}

// ============================================================
// FAV PLAYERS
// ============================================================
function renderFavPlayers(){
  var favs=sg('oshi_favs',[]);
  var el=document.getElementById('fav-player-list');
  if(!favs.length){el.innerHTML='<div style="color:var(--gr);font-size:13px;padding:9px 0;">ãŠæ°—ã«å…¥ã‚Šé¸æ‰‹ã¯ã„ã¾ã›ã‚“</div>';return;}
  var html='';
  favs.forEach(function(f){
    html+='<div class="fav-player"><div>';
    html+='<div style="font-weight:700;font-size:13px;">'+f.teamEmoji+' #'+f.no+' '+f.name+'</div>';
    html+='<div style="font-size:11px;color:var(--gr);">'+f.team+'</div></div>';
    html+='<button class="btn-dl" onclick="removeFav(\''+f.no+'\',\''+f.teamId+'\')">å‰Šé™¤</button></div>';
  });
  el.innerHTML=html;
}
function addFav(player,team){
  var favs=sg('oshi_favs',[]);
  var exists=favs.find(function(f){return f.no===player.no&&f.teamId===team.id;});
  if(exists){alert('ã™ã§ã«è¿½åŠ æ¸ˆã¿ã§ã™');return;}
  favs.push({no:player.no,name:player.name,teamId:team.id,team:team.name,teamEmoji:team.emoji});
  ss('oshi_favs',favs);
  alert('â­ ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸï¼ã‚°ãƒƒã‚ºãŒç™»éŒ²ã•ã‚ŒãŸã‚‰é€šçŸ¥ã—ã¾ã™ã€‚');
}
function removeFav(no,teamId){
  var favs=sg('oshi_favs',[]).filter(function(f){return!(f.no==no&&f.teamId===teamId);});
  ss('oshi_favs',favs);
  renderFavPlayers();
  // æ¤œç´¢ç”»é¢ãŒè¡¨ç¤ºä¸­ã§ã‚ã‚Œã°â­ã‚‚æ›´æ–°
  if(searchTeam)renderSearchPlayers();
}
function checkFavNotif(listing){
  var favs=sg('oshi_favs',[]);
  var match=favs.find(function(f){
    return f.teamId===listing.teamId&&((listing.have||[]).indexOf(f.no)>=0||(listing.want||[]).indexOf(f.no)>=0);
  });
  if(match){
    sendLocalNotif('æ¨ã—ãƒãƒƒãƒ','â­ ãŠæ°—ã«å…¥ã‚Š #'+match.no+' '+match.name+' ã®ã‚°ãƒƒã‚ºãŒç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼');
  }
}

// ============================================================
// MSG BADGE
// ============================================================
function updateMsgBadge(){
  var threads=sg('oshi_threads',[]);
  var unread=threads.filter(function(t){
    return t.status==='trading'&&(t.userA===myUid||t.userB===myUid)&&!t['read_'+myUid];
  }).length;
  ['msg-badge','msg-badge2','msg-badge3','msg-badge5'].forEach(function(id){
    var el=document.getElementById(id);
    if(el){el.textContent=unread;el.style.display=unread>0?'flex':'none';}
  });
}

// ============================================================
// TEAM LIST
// ============================================================
function switchLeague(l,el,mode){
  if(mode==='reg')regLeague=l;else searchLeague=l;
  var tabsId=mode==='reg'?'reg-league-tabs':'search-league-tabs';
  var tabs=document.querySelectorAll('#'+tabsId+' .tab');
  for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');
  el.classList.add('on');
  renderTeamList(mode);
}
function renderTeamList(mode){
  var league=mode==='reg'?regLeague:searchLeague;
  var listId=mode==='reg'?'reg-team-list':'search-team-list';
  var qId=mode==='reg'?'reg-team-q':'search-team-q';
  var teams=(sg('oshi_teams',defaultTeams())[league])||[];
  var q=(document.getElementById(qId).value||'').trim();
  if(q)teams=teams.filter(function(t){return t.name.indexOf(q)>=0;});
  var html='';
  teams.forEach(function(t){
    var enc=encodeURIComponent(JSON.stringify(t));
    html+='<div class="team-item" onclick="pickTeam(\''+enc+'\',\''+mode+'\')">';
    html+='<div class="team-ico">'+t.emoji+'</div>';
    html+='<div><div class="team-name">'+t.name+'</div>';
    html+='<div class="team-sub">'+(t.stadium||'')+'</div></div></div>';
  });
  if(!html)html='<div class="empty"><div class="ei">ğŸ˜¢</div><p>ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p></div>';
  document.getElementById(listId).innerHTML=html;
}
function pickTeam(enc,mode){
  var t=JSON.parse(decodeURIComponent(enc));
  if(mode==='reg'){selRegTeam=t;showRegStep(2);}
  else{searchTeam=t;showSearchStep(2);}
}

// ============================================================
// REGISTER FLOW
// ============================================================
function showRegStep(n){
  document.getElementById('reg-step1').style.display=n===1?'flex':'none';
  document.getElementById('reg-step2').style.display=n===2?'block':'none';
  document.getElementById('reg-step3').style.display=n===3?'flex':'none';
  if(n===2)renderRegGoodsGrid();
  if(n===3)renderRegNumbers();
}
async function renderRegGoodsGrid(){
  document.getElementById('reg-team-label2').textContent=selRegTeam.emoji+' '+selRegTeam.name;
  var gridEl=document.getElementById('reg-g-grid');
  gridEl.innerHTML='<div style="grid-column:span 3;color:var(--gr);text-align:center;padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
  var goods=[];
  try{
    var snap=await db.collection('goods').get();
    goods=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_goods',goods);
  }catch(e){goods=sg('oshi_goods',[]);}
  var filtered=goods.filter(function(g){return g.teamId===selRegTeam.id;});
  filtered.sort(function(a,b){return(b.lastUsed||0)-(a.lastUsed||0);});
  var html='';
  filtered.forEach(function(g){
    html+='<div class="g-card" onclick="pickRegGoods(\''+g.id+'\',\''+g.name.replace(/'/g,'&#39;')+'\')">';
    if(g.photo)html+='<img src="'+g.photo+'" alt="'+g.name+'">';
    else html+='<span class="emo">'+(g.emoji||'ğŸ«')+'</span>';
    html+='<div class="lbl">'+g.name+'</div></div>';
  });
  if(!filtered.length)html='<div class="empty" style="grid-column:span 3;"><div class="ei">ğŸ“¦</div><p style="font-size:13px;">ã‚°ãƒƒã‚ºãŒã¾ã ã‚ã‚Šã¾ã›ã‚“<br>ã€Œæ–°ã—ã„ã‚°ãƒƒã‚ºã‚’ç™»éŒ²ã€ã‹ã‚‰è¿½åŠ ï¼</p></div>';
  gridEl.innerHTML=html;
}
function pickRegGoods(id,name){
  selRegGoodsId=id;selRegGoodsName=name;showRegStep(3);
}
function showNewGoodsSheet(){
  document.getElementById('ov-new-goods').classList.add('on');
}
function renderRegNumbers(){
  document.getElementById('reg-num-sub').textContent=selRegTeam.name+'ï½œ'+selRegGoodsName;
  regNumStates={};
  // Get trading numbers for this user
  var tradingNos=getUserTradingNos(selRegTeam.id);
  renderNumGrid('reg-n-grid',selRegTeam.players||[],regNumStates,'regCycle',tradingNos);
}
function getUserTradingNos(teamId){
  var threads=sg('oshi_threads',[]);var nos=[];
  threads.forEach(function(t){
    if(t.status==='trading'&&(t.userA===myUid||t.userB===myUid)){
      (t.myNums||[]).forEach(function(n){nos.push(n);});
    }
  });
  return nos;
}
function renderNumGrid(gridId,players,states,cycleFn,disabledNos){
  disabledNos=disabledNos||[];
  var html='';
  players.forEach(function(p){
    var st=states[p.no]||'';
    var disabled=disabledNos.indexOf(p.no)>=0;
    var cls=disabled?'n-chip trading':'n-chip '+st;
    var onclick=disabled?'':' onclick="'+cycleFn+'('+p.no+')"';
    html+='<div class="'+cls+'"'+onclick+'>';
    html+='<div class="nn">#'+p.no+'</div>';
    html+='<div class="np">'+p.name+'</div></div>';
  });
  if(!html)html='<div style="grid-column:span 4;color:var(--gr);font-size:13px;text-align:center;padding:20px;">é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  document.getElementById(gridId).innerHTML=html;
}
function regCycle(no){
  var cur=regNumStates[no];
  if(!cur)regNumStates[no]='have';
  else if(cur==='have')regNumStates[no]='want';
  else delete regNumStates[no];
  renderNumGrid('reg-n-grid',selRegTeam.players||[],regNumStates,'regCycle',getUserTradingNos(selRegTeam.id));
}
async function submitMyListing(){
  var haveNos=[],wantNos=[];
  Object.keys(regNumStates).forEach(function(k){
    if(regNumStates[k]==='have')haveNos.push(parseInt(k));
    else wantNos.push(parseInt(k));
  });
  if(!haveNos.length){alert('ã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');return;}
  var listing={
    userId:myUid,userEmoji:myEmoji,userName:myName,
    team:selRegTeam.name,teamEmoji:selRegTeam.emoji,teamId:selRegTeam.id,league:regLeague,
    stadium:selRegTeam.stadium||'',stadiumImg:selRegTeam.stadiumImg||'',
    goodsId:selRegGoodsId,goodsName:selRegGoodsName,
    have:haveNos,want:wantNos,status:'open',
    users:[myUid],createdAt:Date.now(),updatedAt:Date.now()
  };
  // Firestoreã«ä¿å­˜ï¼ˆawaitã§å®Œå…¨ã«å¾…ã¤ï¼‰
  var ref=null;
  try{
    ref=await db.collection('listings').add(listing);
    listing.id=ref.id;
  }catch(e){
    console.error('listing save error:',e);
    showToast('âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
    return;
  }
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
  var arr=sg('oshi_listings',[]);
  arr.push(listing);
  ss('oshi_listings',arr);
  // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆæ¬¡ã®ç™»éŒ²ã®ãŸã‚ï¼‰
  selRegTeam=null;selRegGoodsId=null;selRegGoodsName=null;regNumStates={};
  checkFavNotif(listing);
  showToast('âœ… ç™»éŒ²ã—ã¾ã—ãŸï¼');
  // ãƒã‚¤ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¦å³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  navTo('mypage');
  await renderMyListings();
}

// New goods
function previewFile(input){
  if(input.files&&input.files[0]){
    window._pendingFile=input.files[0];
    var reader=new FileReader();
    reader.onload=function(e){
      document.getElementById('up-img').src=e.target.result;
      document.getElementById('up-prev').style.display='block';
      document.getElementById('up-area').style.display='none';
    };
    reader.readAsDataURL(input.files[0]);
  }
}
async function saveNewGoods(){
  var name=document.getElementById('ng-name').value.trim();
  var cat=document.getElementById('ng-cat').value;
  if(!name){alert('ã‚°ãƒƒã‚ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if(!window._pendingFile){alert('å†™çœŸã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  var fullName=cat+'ï½œ'+name;
  var btn=document.getElementById('ng-btn');btn.textContent='ç™»éŒ²ä¸­...';btn.disabled=true;
  var reader=new FileReader();
  reader.onload=async function(e){
    var entry={name:fullName,emoji:'ğŸ«',photo:e.target.result,lastUsed:Date.now(),teamId:selRegTeam?selRegTeam.id:null};
    var saved=await dbSaveGoods(entry);
    selRegGoodsId=saved.id;selRegGoodsName=fullName;
    window._pendingFile=null;
    document.getElementById('up-prev').style.display='none';
    document.getElementById('up-area').style.display='block';
    document.getElementById('ng-name').value='';
    btn.textContent='ç™»éŒ²ã—ã¦èƒŒç•ªå·ã‚’é¸ã¶ â†’';btn.disabled=false;
    closeOv('ov-new-goods');
    // ã‚°ãƒƒã‚ºä¸€è¦§ã‚’æœ€æ–°åŒ–ã—ã¦ã‹ã‚‰æ¬¡ã¸
    await renderRegGoodsGrid();
    showRegStep(3);
  };
  reader.readAsDataURL(window._pendingFile);
}

// ============================================================
// SEARCH FLOW
// ============================================================
function showSearchStep(n){
  document.getElementById('search-step1').style.display=n===1?'flex':'none';
  document.getElementById('search-step2').style.display=n===2?'flex':'none';
  document.getElementById('search-step3').style.display=n===3?'flex':'none';
  document.getElementById('search-step4').style.display=n===4?'flex':'none';
  if(n===2)renderSearchPlayers();
  if(n===3)renderSearchGoods();
  if(n===4)renderSearchResults();
}
function renderSearchPlayers(){
  document.getElementById('search-team-label').textContent=searchTeam.emoji+' '+searchTeam.name;
  var players=searchTeam.players||[];
  window._searchPlayers=players;
  var favs=sg('oshi_favs',[]);
  var html='';
  players.forEach(function(p,i){
    var enc=encodeURIComponent(JSON.stringify(p));
    var isFav=favs.find(function(f){return f.no===p.no&&f.teamId===searchTeam.id;});
    html+='<div class="team-item">';
    html+='<div class="team-ico" style="font-size:16px;font-weight:900;">#'+p.no+'</div>';
    html+='<div style="flex:1;" onclick="pickSearchPlayer(\''+enc+'\')"><div class="team-name">'+p.name+'</div></div>';
    html+='<button class="btn-sm" style="background:'+(isFav?'rgba(255,209,102,.2)':'var(--nv3)')+';" onclick="toggleFav('+i+')">'+(isFav?'â­':'â˜†')+'</button>';
    html+='</div>';
  });
  if(!html)html='<div class="empty"><div class="ei">ğŸ˜¢</div><p>é¸æ‰‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
  document.getElementById('search-player-list').innerHTML=html;
}
function toggleFav(i){
  var p=window._searchPlayers[i];
  var favs=sg('oshi_favs',[]);
  var idx=favs.findIndex(function(f){return f.no===p.no&&f.teamId===searchTeam.id;});
  if(idx>=0){
    favs.splice(idx,1);
    ss('oshi_favs',favs);
    showToast('ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    renderSearchPlayers();
  } else {
    favs.push({no:p.no,name:p.name,teamId:searchTeam.id,team:searchTeam.name,teamEmoji:searchTeam.emoji});
    ss('oshi_favs',favs);
    showToast('â­ ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸï¼');
    // ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
    setTimeout(function(){navTo('mypage');},800);
  }
}
function pickSearchPlayer(enc){
  searchPlayer=JSON.parse(decodeURIComponent(enc));
  showSearchStep(3);
}
function renderSearchGoods(){
  db.collection('goods').get().then(function(snap){
    var goods=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_goods',goods);
    return goods;
  }).catch(function(){return dbGetGoods();}).then(function(goods){
    var filtered=goods.filter(function(g){return g.teamId===searchTeam.id;});
    filtered.sort(function(a,b){return(b.lastUsed||0)-(a.lastUsed||0);});
    document.getElementById('search-player-label').textContent='#'+searchPlayer.no+' '+searchPlayer.name;
    var html='';
    filtered.forEach(function(g){
      html+='<div class="g-card" onclick="pickSearchGoods(\''+g.id+'\',\''+g.name.replace(/'/g,'&#39;')+'\')">';
      if(g.photo)html+='<img src="'+g.photo+'" alt="'+g.name+'">';
      else html+='<span class="emo">'+(g.emoji||'ğŸ«')+'</span>';
      html+='<div class="lbl">'+g.name+'</div></div>';
    });
    if(!filtered.length)html='<div class="empty" style="grid-column:span 3;"><div class="ei">ğŸ“¦</div><p>ã‚°ãƒƒã‚ºãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
    document.getElementById('search-g-grid').innerHTML=html;
  });
}
function pickSearchGoods(id,name){
  searchGoodsId=id;searchGoodsName=name;showSearchStep(4);
}
function renderSearchResults(){
  var lbl=searchTeam.emoji+' '+searchTeam.name+' #'+searchPlayer.no+' '+searchPlayer.name;
  document.getElementById('search-result-label').textContent=lbl;
  var el=document.getElementById('search-results-list');
  el.innerHTML='<div class="empty"><div class="ei">â³</div><p>æ¤œç´¢ä¸­...</p></div>';
  dbGetListings().then(function(listings){
    var filtered=listings.filter(function(l){
      return l.teamId===searchTeam.id&&l.goodsId===searchGoodsId&&
        ((l.have||[]).indexOf(searchPlayer.no)>=0||(l.want||[]).indexOf(searchPlayer.no)>=0);
    });
    if(!filtered.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ˜¢</div><p>ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹äººãŒã„ã¾ã›ã‚“</p></div>';return;}
    var html='';
    filtered.forEach(function(l){
      var isTrading=l.status==='trading';
      var isMine=l.userId===myUid;
      var haveTagsHtml='',wantTagsHtml='';
      (l.have||[]).forEach(function(n){haveTagsHtml+='<span class="tag h">#'+n+'</span>';});
      (l.want||[]).forEach(function(n){wantTagsHtml+='<span class="tag w">#'+n+'</span>';});
      html+='<div class="result-item'+(isTrading?' trading-item':'')+'">';
      html+='<div class="ri-hdr"><div class="ri-user">';
      html+='<div class="ava sm">'+(l.userEmoji||'ğŸ˜Š')+'</div>';
      html+='<div><div class="ri-name">'+(l.userName||'æ¨ã—ãƒ•ã‚¡ãƒ³')+(isMine?'<span class="ri-mine" style="margin-left:6px;">è‡ªåˆ†</span>':'')+'</div>';
      html+='<div class="ri-sub">'+l.team+'</div></div></div>';
      html+='<span class="status-badge '+(isTrading?'sb-trading':'sb-open')+'">'+(isTrading?'å–å¼•ä¸­':'äº¤æ›å¯èƒ½')+'</span></div>';
      html+='<div style="font-size:11px;color:var(--gr);margin-bottom:5px;">æŒã£ã¦ã„ã‚‹</div>';
      html+='<div class="tag-row">'+haveTagsHtml+'</div>';
      html+='<div style="font-size:11px;color:var(--gr);margin-bottom:5px;">æ¬²ã—ã„</div>';
      html+='<div class="tag-row" style="margin-bottom:9px;">'+wantTagsHtml+'</div>';
      if(!isMine&&!isTrading){
        html+='<button class="btn btn-p" style="font-size:13px;padding:10px;" onclick="startTradeRequest(\''+l.id+'\')">äº¤æ›å¸Œæœ›ã™ã‚‹</button>';
      } else if(isMine){
        html+='<button class="btn" style="background:var(--nv3);color:var(--gr);font-size:13px;padding:10px;" disabled>è‡ªåˆ†ã®ç™»éŒ²</button>';
      } else {
        html+='<button class="btn" style="background:var(--nv3);color:var(--gr);font-size:13px;padding:10px;" disabled>å–å¼•ä¸­</button>';
      }
      html+='</div>';
    });
    el.innerHTML=html;
  });
}

// ============================================================
// TRADE REQUEST
// ============================================================
async function startTradeRequest(listingId){
  tradeTargetId=listingId;
  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===listingId;});
  if(!target){try{var s=await db.collection('listings').doc(listingId).get();if(s.exists)target=Object.assign({id:s.id},s.data());}catch(e){}}
  if(!target){alert('ç™»éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  tradeTargetUserId=target.userId;
  document.getElementById('trade-num-sub').textContent=target.team+'ï½œ'+target.goodsName+' ã®äº¤æ›å¸Œæœ›ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰';
  tradeNumStates={};
  renderNumGrid('trade-n-grid',getTeamPlayers(target.teamId),tradeNumStates,'tradeCycle',[]);
  go('pg-trade-nums');
}
function getTeamPlayers(teamId){
  var teams=sg('oshi_teams',defaultTeams());
  for(var league in teams){var t=teams[league].find(function(t){return t.id===teamId;});if(t)return t.players||[];}
  return[];
}
function tradeCycle(no){
  var cur=tradeNumStates[no];
  if(!cur)tradeNumStates[no]='have';
  else if(cur==='have')tradeNumStates[no]='want';
  else delete tradeNumStates[no];
  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===tradeTargetId;});
  renderNumGrid('trade-n-grid',target?getTeamPlayers(target.teamId):[],tradeNumStates,'tradeCycle',[]);
}
async function submitTradeRequest(){
  var haveNos=[],wantNos=[];
  Object.keys(tradeNumStates).forEach(function(k){
    if(tradeNumStates[k]==='have')haveNos.push(parseInt(k));
    else wantNos.push(parseInt(k));
  });
  if(!haveNos.length){alert('ã€ŒæŒã£ã¦ã„ã‚‹ã€ç•ªå·ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„');return;}
  var listings=sg('oshi_listings',[]);
  var target=listings.find(function(l){return l.id===tradeTargetId;});
  if(!target){alert('ç™»éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  await dbUpdateListing(tradeTargetId,{status:'trading',updatedAt:Date.now()});
  var thread={
    userA:myUid,userAEmoji:myEmoji,userAName:myName,
    userB:target.userId,userBEmoji:target.userEmoji,userBName:target.userName||'æ¨ã—ãƒ•ã‚¡ãƒ³',
    users:[myUid,target.userId],
    team:target.team,teamEmoji:target.teamEmoji,stadium:target.stadium||'',stadiumImg:target.stadiumImg||'',
    goodsName:target.goodsName,listingId:tradeTargetId,
    myNums:haveNos,wantNums:wantNos,
    myGoodsInfo:{have:haveNos,want:wantNos},
    targetGoodsInfo:{have:target.have||[],want:target.want||[]},
    status:'trading',
    messages:[{from:'sys',text:'å–å¼•ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚ä¸å¯§ãªã‚„ã‚Šã¨ã‚Šã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',at:Date.now()}],
    doneA:false,doneB:false,
    createdAt:Date.now()
  };
  thread['read_'+myUid]=true;
  await dbSaveThread(thread);
  sendLocalNotif('æ¨ã—ãƒãƒƒãƒ','äº¤æ›å¸Œæœ›ã‚’é€ã‚Šã¾ã—ãŸï¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç›¸è«‡ã—ã¾ã—ã‚‡ã†ã€‚');
  alert('âœ… äº¤æ›å¸Œæœ›ã‚’é€ã‚Šã¾ã—ãŸï¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç›¸è«‡ã—ã¾ã—ã‚‡ã†ã€‚');
  navTo('msg');
}

// ============================================================
// MESSAGES
// ============================================================
function renderMsgThreads(){
  var el=document.getElementById('msg-thread-list');
  el.innerHTML='<div class="empty"><div class="ei">â³</div><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>';
  dbGetThreads().then(function(threads){
    threads=threads.filter(function(t){return t.userA===myUid||t.userB===myUid;});
    if(!threads.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ’¬</div><p>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';return;}
    threads.sort(function(a,b){return b.createdAt-a.createdAt;});
    var html='';
    threads.forEach(function(t){
      var isMyA=t.userA===myUid;
      var peerEmoji=isMyA?t.userBEmoji:t.userAEmoji;
      var peerName=isMyA?(t.userBName||'æ¨ã—ãƒ•ã‚¡ãƒ³'):(t.userAName||'æ¨ã—ãƒ•ã‚¡ãƒ³');
      var lastMsg=t.messages&&t.messages.length?t.messages[t.messages.length-1]:{text:'å–å¼•é–‹å§‹'};
      var isUnread=!t['read_'+myUid]&&lastMsg.from!==myUid&&lastMsg.from!=='sys';
      var timeStr=fmtTime(t.createdAt);
      html+='<div class="thread-wrap" id="tw-'+t.id+'" ontouchstart="touchStart(event,\''+t.id+'\')" ontouchmove="touchMove(event,\''+t.id+'\')" ontouchend="touchEnd(event,\''+t.id+'\')">';
      html+='<div class="msg-thread trading" onclick="openChat(\''+t.id+'\')">';
      html+='<div class="ava">'+(peerEmoji||'ğŸ˜Š')+'</div>';
      html+='<div class="thread-info">';
      html+='<div class="thread-name">'+t.teamEmoji+' '+t.goodsName+'</div>';
      html+='<div class="thread-last">'+peerName+': '+(lastMsg.text.length>25?lastMsg.text.substr(0,25)+'â€¦':lastMsg.text)+'</div></div>';
      html+='<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">';
      html+='<div class="thread-time">'+timeStr+'</div>';
      if(isUnread)html+='<div class="unread-dot"></div>';
      html+='</div></div>';
      html+='<div class="thread-del-btn" onclick="deleteThread(\''+t.id+'\')">ğŸ—‘ï¸</div></div>';
    });
    el.innerHTML=html;
    updateMsgBadge();
  });
}

// Swipe to delete
var touchStartX=0;
function touchStart(e,id){touchStartX=e.touches[0].clientX;}
function touchMove(e,id){
  var dx=e.touches[0].clientX-touchStartX;
  if(dx<-30){document.getElementById('tw-'+id).classList.add('swiped');}
  else if(dx>10){document.getElementById('tw-'+id).classList.remove('swiped');}
}
function touchEnd(e,id){}
function setupSwipeDelete(){}
function deleteThread(id){
  showConfirmSheet('ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',async function(){
    await dbDeleteThread(id);
    renderMsgThreads();
  });
}

function openChat(threadId){
  curChatThreadId=threadId;
  var threads=sg('oshi_threads',[]);
  var t=threads.find(function(t){return t.id===threadId;});
  if(!t)return;
  // Mark as read
  var upd={};upd['read_'+myUid]=true;
  dbUpdateThread(threadId,upd);
  var isMyA=t.userA===myUid;
  var peerEmoji=isMyA?t.userBEmoji:t.userAEmoji;
  var peerName=isMyA?(t.userBName||'æ¨ã—ãƒ•ã‚¡ãƒ³'):(t.userAName||'æ¨ã—ãƒ•ã‚¡ãƒ³');
  document.getElementById('c-ava').textContent=peerEmoji||'ğŸ˜Š';
  document.getElementById('c-name').textContent=peerName;
  document.getElementById('c-goods-badge').textContent='å–å¼•ä¸­';
  document.getElementById('c-status').textContent='â— å–å¼•ä¸­';
  // Trade bar
  var tgInfo=t.targetGoodsInfo||{};
  var myGInfo=t.myGoodsInfo||{};
  var barHtml='<div style="font-size:12px;color:var(--wh);margin-bottom:4px;">ğŸ“¦ '+t.goodsName+'</div>';
  barHtml+='<div class="trade-nums">';
  (tgInfo.have||t.have||[]).forEach(function(n){barHtml+='<span class="tag h">#'+n+'</span>';});
  (tgInfo.want||t.want||[]).forEach(function(n){barHtml+='<span class="tag w">#'+n+'</span>';});
  barHtml+='</div>';
  document.getElementById('trade-bar-content').innerHTML=barHtml;
  // Stadium
  var sa=document.getElementById('stadium-area');
  if(t.stadiumImg&&t.stadiumImg.trim()){
    document.getElementById('stadium-img').src=t.stadiumImg;
    document.getElementById('stadium-img').style.display='block';
    document.getElementById('stadium-name').textContent='ğŸ“ '+t.stadium;
    sa.style.display='block';
  } else if(t.stadium){
    sa.style.display='block';
    document.getElementById('stadium-img').style.display='none';
    document.getElementById('stadium-name').textContent='ğŸ“ '+t.stadium;
  } else {sa.style.display='none';}
  document.getElementById('done-trade-btn').style.display='block';
  document.getElementById('cancel-trade-btn').style.display='block';
  document.getElementById('c-input-area').style.display='block';
  renderChatMsgs(t);
  go('pg-chat');
  updateMsgBadge();
}
function renderChatMsgs(t){
  var el=document.getElementById('c-msgs');
  var msgs=t.messages||[];
  var html='<div class="msg sys">ğŸ”’ åŒ¿åãƒãƒ£ãƒƒãƒˆã§ã™ã€‚å€‹äººæƒ…å ±ã¯å…±æœ‰ã—ãªã„ã§ãã ã•ã„ã€‚</div>';
  msgs.forEach(function(m,i){
    if(m.from==='sys'){
      html+='<div class="msg sys">'+m.text+'</div>';
    } else if(m.from===myUid){
      var nextFrom=msgs[i+1]?msgs[i+1].from:null;
      html+='<div class="msg s">'+m.text+'<div class="msg-time">'+fmtTime(m.at)+'</div></div>';
      // Show read receipt if last sent message
      if(nextFrom!==myUid&&t['read_peer']){
        html+='<div class="read-txt">æ—¢èª­</div>';
      }
    } else {
      html+='<div class="msg r">'+m.text+'<div class="msg-time">'+fmtTime(m.at)+'</div></div>';
    }
  });
  el.innerHTML=html;
  el.scrollTop=el.scrollHeight;
}
async function sendMsg(){
  var inp=document.getElementById('c-inp');
  var text=inp.value.trim();
  if(!text)return;
  var banned=sg('oshi_banned_words',[]);
  for(var i=0;i<banned.length;i++){if(text.indexOf(banned[i])>=0){alert('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚');return;}}
  inp.value='';
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0)return;
  threads[idx].messages=threads[idx].messages||[];
  threads[idx].messages.push({from:myUid,text:text,at:Date.now()});
  // Reset peer read on new message
  var upd={messages:threads[idx].messages};
  var t=threads[idx];
  var peer=t.userA===myUid?t.userB:t.userA;
  upd['read_'+peer]=false;
  await dbUpdateThread(curChatThreadId,upd);
  ss('oshi_threads',threads);
  renderChatMsgs(threads[idx]);
  sendLocalNotif('æ¨ã—ãƒãƒƒãƒ','æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸ');
}
function showDoneModal(){document.getElementById('ov-done').classList.add('on');}
function showCancelModal(){document.getElementById('ov-cancel').classList.add('on');}
function closeOv(id){document.getElementById(id).classList.remove('on');}
async function confirmDone(){
  closeOv('ov-done');
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0)return;
  var t=threads[idx];
  var isMyA=t.userA===myUid;
  if(isMyA)t.doneA=true;else t.doneB=true;
  if(t.doneA&&t.doneB){
    t.status='done';
    t.messages.push({from:'sys',text:'ğŸ‰ äº¤æ›ãŒæˆç«‹ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚',at:Date.now()});
    await dbUpdateThread(curChatThreadId,{status:'done',doneA:true,doneB:true,messages:t.messages});
    await dbDeleteListing(t.listingId);
    // Auto-delete thread after done (remove from view)
    setTimeout(async function(){await dbDeleteThread(curChatThreadId);},3000);
    var n=sg('trades_'+myUid,0)+1;ss('trades_'+myUid,n);
    await dbIncrementTrades();loadTotalTrades();
    ss('oshi_threads',threads);
    renderChatMsgs(t);
    document.getElementById('c-goods-badge').textContent='âœ…æˆç«‹';
    document.getElementById('done-trade-btn').style.display='none';
    document.getElementById('cancel-trade-btn').style.display='none';
    document.getElementById('c-input-area').style.display='none';
    sendLocalNotif('æ¨ã—ãƒãƒƒãƒ','ğŸ‰ äº¤æ›æˆç«‹ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼');
    alert('ğŸ‰ äº¤æ›æˆç«‹ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼');
    updateMyPage();
  } else {
    var upd2=isMyA?{doneA:true}:{doneB:true};
    upd2.messages=t.messages;
    await dbUpdateThread(curChatThreadId,upd2);
    ss('oshi_threads',threads);
    alert('å®Œäº†ã—ã¾ã—ãŸã€‚ç›¸æ‰‹ãŒå®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨æˆç«‹ã«ãªã‚Šã¾ã™ã€‚');
  }
}
async function confirmCancel(){
  closeOv('ov-cancel');
  var threads=sg('oshi_threads',[]);
  var idx=threads.findIndex(function(t){return t.id===curChatThreadId;});
  if(idx<0)return;
  var t=threads[idx];
  t.status='cancelled';
  t.messages.push({from:'sys',text:'âŒ å–å¼•ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚',at:Date.now()});
  await dbUpdateThread(curChatThreadId,{status:'cancelled',messages:t.messages});
  await dbUpdateListing(t.listingId,{status:'open',updatedAt:Date.now()});
  // Auto-delete cancelled thread
  setTimeout(async function(){await dbDeleteThread(curChatThreadId);},2000);
  ss('oshi_threads',threads);
  renderChatMsgs(t);
  document.getElementById('done-trade-btn').style.display='none';
  document.getElementById('cancel-trade-btn').style.display='none';
  alert('å–å¼•ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ã‚°ãƒƒã‚ºãŒäº¤æ›å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚');
  setTimeout(function(){navTo('msg');},2100);
}

// ============================================================
// REPORT
// ============================================================
function showReportSheet(){document.getElementById('ov-report').classList.add('on');}
async function submitReport(){
  var threads=sg('oshi_threads',[]);
  var t=threads.find(function(t){return t.id===curChatThreadId;});
  if(!t)return;
  var peer=t.userA===myUid?t.userB:t.userA;
  var reason=document.getElementById('report-reason').value;
  var detail=document.getElementById('report-detail').value.trim();
  await dbSaveReport({reporterId:myUid,reportedId:peer,reason:reason,detail:detail,threadId:curChatThreadId,at:Date.now()});
  closeOv('ov-report');
  document.getElementById('report-detail').value='';
  alert('å ±å‘Šã—ã¾ã—ãŸã€‚ç®¡ç†è€…ãŒç¢ºèªã—ã¾ã™ã€‚');
}

// ============================================================
// ADMIN
// ============================================================
function showConfirmSheet(msg,cb){
  document.getElementById('confirm-msg').textContent=msg;
  // ãƒœã‚¿ãƒ³ã‚’cloneã—ã¦å¤ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’å®Œå…¨é™¤å»ï¼ˆiOSãƒã‚°å¯¾ç­–ï¼‰
  var oldBtn=document.getElementById('confirm-ok-btn');
  var newBtn=oldBtn.cloneNode(true);
  oldBtn.parentNode.replaceChild(newBtn,oldBtn);
  newBtn.addEventListener('click',function(){
    closeOv('ov-confirm');
    if(cb)cb();
  });
  document.getElementById('ov-confirm').classList.add('on');
}

function showToast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer=setTimeout(function(){t.classList.remove('show');},2200);
}
function shareToX(){
  var text='ã‚ªã‚¹ã‚¹ãƒ¡ãƒ¼ï¼\nhttps:\/\/oshimatch.github.io\/oshi-match\/\næ¨ã—ã‚°ãƒƒã‚ºãƒãƒƒãƒ\nJãƒªãƒ¼ã‚°å…¨ãƒãƒ¼ãƒ å¯¾å¿œï¼\nã‚„ã‚Šã¨ã‚Šç°¡å˜ï¼æ¤œç´¢ã€ç™»éŒ²ï¼äº¤æ›ï¼\nç™»éŒ²ä¸è¦ã§ã™ãåˆ©ç”¨â™ª';
  var url='https://twitter.com/intent/tweet?text='+encodeURIComponent(text);
  window.open(url,'_blank');
}





function checkPw(){
  if(document.getElementById('admin-pw').value===ADMIN_PW){
    document.getElementById('admin-pw').value='';
    renderAdminTeams();
    dbGetGoods().then(function(){renderAdminGoods();});
    dbGetSettings().then(function(s){
      renderWordTags();
      document.getElementById('notice-edit').value=s.notice||'';
      document.getElementById('match-info-edit').value=s.matchInfo||'';
    });
    renderAdminReports();
    renderBanList();
    go('pg-admin');
  } else {alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');}
}
function switchAdminTab(tab,el){
  var tabs=document.querySelectorAll('#admin-main-tabs .tab');
  for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');
  el.classList.add('on');
  document.getElementById('admin-teams-tab').style.display=tab==='teams'?'block':'none';
  document.getElementById('admin-notice-tab').style.display=tab==='notice'?'block':'none';
  document.getElementById('admin-words-tab').style.display=tab==='words'?'block':'none';
  document.getElementById('admin-reports-tab').style.display=tab==='reports'?'block':'none';
  document.getElementById('admin-goods-a-tab').style.display=tab==='goods-a'?'block':'none';
  if(tab==='reports'){renderAdminReports();renderBanList();}
}
function switchAdminLeague(l,el){
  adminLeague=l;
  var tabs=document.querySelectorAll('#admin-league-tabs .tab');
  for(var i=0;i<tabs.length;i++)tabs[i].classList.remove('on');
  el.classList.add('on');
  renderAdminTeams();
}
function renderAdminTeams(){
  var teams=(sg('oshi_teams',defaultTeams())[adminLeague])||[];
  var el=document.getElementById('admin-team-list');
  if(!teams.length){el.innerHTML='<div style="color:var(--gr);text-align:center;padding:16px;font-size:13px;">ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  var html='';
  teams.forEach(function(t){
    var enc=encodeURIComponent(JSON.stringify(t));
    html+='<div class="a-sec"><div class="a-row">';
    html+='<span style="font-weight:700;font-size:13px;">'+t.emoji+' '+t.name+'</span>';
    html+='<div class="a-btns"><button class="btn-ed" onclick="openEditTeam(\''+enc+'\')">ç·¨é›†</button>';
    html+='<button class="btn-dl" onclick="delTeam(\''+t.id+'\',\''+t.name.replace(/'/g,'&#39;')+'\')">å‰Šé™¤</button></div></div>';
    if(t.stadium)html+='<div style="font-size:11px;color:var(--gr);margin-bottom:6px;">ğŸ“ '+t.stadium+'</div>';
    var ptags='';(t.players||[]).forEach(function(p){ptags+='<span class="p-tag">#'+p.no+' '+p.name+'</span>';});
    html+='<div>'+ptags+'</div></div>';
  });
  el.innerHTML=html;
}
async function renderAdminGoods(){
  var el=document.getElementById('admin-goods-list');
  if(!el)return;
  el.innerHTML='<div style="color:var(--gr);text-align:center;padding:16px;font-size:13px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
  var goods=[];
  try{
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å¼·åˆ¶å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡è¦–ï¼‰
    var snap=await db.collection('goods').get();
    goods=snap.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_goods',goods);
  }catch(e){
    try{var snap2=await db.collection('goods').get();
    goods=snap2.docs.map(function(d){return Object.assign({id:d.id},d.data());});
    ss('oshi_goods',goods);}catch(e2){goods=sg('oshi_goods',[]);}
  }
  var html='';
  goods.forEach(function(g){
    html+='<div class="a-sec"><div class="a-row">';
    if(g.photo)html+='<img src="'+g.photo+'" style="width:26px;height:26px;object-fit:cover;border-radius:5px;margin-right:7px;">';
    else html+='<span style="margin-right:6px;">'+(g.emoji||'ğŸ«')+'</span>';
    html+='<span style="font-weight:700;font-size:13px;flex:1;">'+g.name+'</span>';
    html+='<button class="btn-dl" onclick="delGoods(\''+g.id+'\')">å‰Šé™¤</button>';
    html+='</div></div>';
  });
  if(!goods.length)html='<div style="color:var(--gr);text-align:center;padding:16px;font-size:13px;">ã‚°ãƒƒã‚ºãŒã‚ã‚Šã¾ã›ã‚“</div>';
  el.innerHTML=html;
}
function delGoods(id){
  showConfirmSheet('ã“ã®ã‚°ãƒƒã‚ºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',async function(){
    try{
      await db.collection('goods').doc(id).delete();
    }catch(e){
      showToast('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³å‰Šé™¤
    ss('oshi_goods',sg('oshi_goods',[]).filter(function(x){return x.id!==id;}));
    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
    // 1ç§’å¾Œã«å†å–å¾—ï¼ˆFirestoreåæ˜ å¾…ã¡ï¼‰
    setTimeout(async function(){await renderAdminGoods();},1000);
  });
}
function renderWordTags(){
  var words=sg('oshi_banned_words',[]);
  var html='';
  words.forEach(function(w){html+='<span class="word-tag" onclick="delWord(\''+w.replace(/'/g,'&#39;')+'\')">'+w+' âœ•</span>';});
  document.getElementById('word-tags').innerHTML=html||'<span style="color:var(--gr);font-size:13px;">ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</span>';
}
async function addWord(){
  var w=document.getElementById('new-word-inp').value.trim();if(!w)return;
  var words=sg('oshi_banned_words',[]);if(words.indexOf(w)<0)words.push(w);
  var notice=sg('oshi_notice','');var matchInfo=sg('oshi_match_info','');
  await dbSaveSettings(notice,words,matchInfo);
  document.getElementById('new-word-inp').value='';renderWordTags();
}
async function delWord(w){
  var words=sg('oshi_banned_words',[]).filter(function(x){return x!==w;});
  await dbSaveSettings(sg('oshi_notice',''),words,sg('oshi_match_info',''));renderWordTags();
}
async function saveNotice(){
  var txt=document.getElementById('notice-edit').value.trim();
  var mi=document.getElementById('match-info-edit').value.trim();
  var words=sg('oshi_banned_words',[]);
  await dbSaveSettings(txt,words,mi);
  showNoticeFromText(txt,mi);alert('ä¿å­˜ã—ã¾ã—ãŸ');
}
async function renderAdminReports(){
  var el=document.getElementById('admin-reports-list');
  if(!el)return;
  el.innerHTML='<div style="color:var(--gr);font-size:13px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
  var reports=await dbGetReports();
  if(!reports.length){el.innerHTML='<div style="color:var(--gr);font-size:13px;">å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</div>';return;}
  var html='';
  reports.forEach(function(r){
    html+='<div class="report-item">';
    html+='<div style="font-weight:700;font-size:12px;margin-bottom:4px;">'+r.reason+'</div>';
    html+='<div style="font-size:11px;color:var(--gr);">å ±å‘Šè€…: '+r.reporterId+'</div>';
    html+='<div style="font-size:11px;color:var(--gr);">å¯¾è±¡: '+r.reportedId+'</div>';
    if(r.detail)html+='<div style="font-size:11px;margin-top:4px;">'+r.detail+'</div>';
    html+='<button class="btn-sm btn-r" style="margin-top:7px;" onclick="addBanFromReport(\''+r.reportedId+'\')">ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’BAN</button>';
    html+='</div>';
  });
  el.innerHTML=html;
}
async function renderBanList(){
  var el=document.getElementById('ban-list');if(!el)return;
  var bans=await dbGetBans();
  if(!bans.length){el.innerHTML='<div style="color:var(--gr);font-size:13px;">BANãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</div>';return;}
  var html='';
  bans.forEach(function(uid){
    html+='<div class="a-sec"><div class="a-row">';
    html+='<span style="font-size:12px;">'+uid+'</span>';
    html+='<button class="btn-ed" onclick="removeBan(\''+uid+'\')">è§£é™¤</button></div></div>';
  });
  el.innerHTML=html;
}
async function addBan(){
  var uid=document.getElementById('ban-uid-inp').value.trim();if(!uid)return;
  await dbSaveBan(uid);document.getElementById('ban-uid-inp').value='';renderBanList();alert('BANã—ã¾ã—ãŸ');
}
async function addBanFromReport(uid){
  showConfirmSheet(uid+' ã‚’BANã—ã¾ã™ã‹ï¼Ÿ',async function(){
    await dbSaveBan(uid);renderBanList();showToast('BANã—ã¾ã—ãŸ');
  });
  return;
}
async function removeBan(uid){
  await dbRemoveBan(uid);renderBanList();alert('BANè§£é™¤ã—ã¾ã—ãŸ');
}
function openAddTeam(){
  document.getElementById('ov-team-title').textContent='ãƒãƒ¼ãƒ ã‚’è¿½åŠ ï¼ˆ'+adminLeague+'ï¼‰';
  ['t-name','t-emoji','t-stadium','t-stadium-img','t-players','t-id'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('ov-team').classList.add('on');
}
function openEditTeam(enc){
  var t=JSON.parse(decodeURIComponent(enc));
  document.getElementById('ov-team-title').textContent='ãƒãƒ¼ãƒ ã‚’ç·¨é›†';
  document.getElementById('t-name').value=t.name;
  document.getElementById('t-emoji').value=t.emoji;
  document.getElementById('t-stadium').value=t.stadium||'';
  document.getElementById('t-stadium-img').value=t.stadiumImg||'';
  document.getElementById('t-players').value=(t.players||[]).map(function(p){return p.no+' '+p.name;}).join('\n');
  document.getElementById('t-id').value=t.id||'';
  document.getElementById('ov-team').classList.add('on');
}
function saveTeam(){
  var name=document.getElementById('t-name').value.trim();
  var emoji=document.getElementById('t-emoji').value.trim()||'âš½';
  var stadium=document.getElementById('t-stadium').value.trim();
  var stadiumImg=document.getElementById('t-stadium-img').value.trim();
  var raw=document.getElementById('t-players').value.trim();
  var editId=document.getElementById('t-id').value.trim();
  if(!name){alert('ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var lines=raw.split('\n');var players=[];
  lines.forEach(function(line){
    line=line.trim();if(!line)return;
    var parts=line.split(/\s+/);var no=parseInt(parts[0]);var pname=parts.slice(1).join(' ');
    if(!isNaN(no)&&pname)players.push({no:no,name:pname});
  });
  var teams=sg('oshi_teams',defaultTeams());
  if(!teams[adminLeague])teams[adminLeague]=[];
  var teamData={id:editId||nid(),name:name,emoji:emoji,stadium:stadium,stadiumImg:stadiumImg,players:players};
  if(editId){
    var idx=teams[adminLeague].findIndex(function(t){return t.id===editId;});
    if(idx>=0)teams[adminLeague][idx]=teamData;else teams[adminLeague].push(teamData);
  } else {teams[adminLeague].push(teamData);}
  ss('oshi_teams',teams);
  closeOv('ov-team');renderAdminTeams();
}
function delTeam(id,name){
  showConfirmSheet('ã€Œ'+name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',function(){
    var teams=sg('oshi_teams',defaultTeams());
    if(teams[adminLeague])teams[adminLeague]=teams[adminLeague].filter(function(t){return t.id!==id;});
    ss('oshi_teams',teams);renderAdminTeams();
  });
}
</script>
</body>
</html>
